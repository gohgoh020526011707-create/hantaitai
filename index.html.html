<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工自主排班系統 (網頁版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 和 Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }
        .material-icons-outlined {
            font-size: 1.25rem;
        }
        /* 滾動條美化 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 避免 Tailwind CSS JIT 編譯器移除動態 class */
        .bg-blue-100, .bg-green-100, .bg-yellow-100, .bg-indigo-100, .bg-pink-100, .bg-purple-100, .bg-gray-100 {}
        .text-blue-800, .text-green-800, .text-yellow-800, .text-indigo-800, .text-pink-800, .text-purple-800, .text-gray-800, .text-amber-800 {}
        .border-blue-400, .border-green-400, .border-yellow-400, .border-indigo-400, .border-pink-400, .border-purple-400, .border-gray-400 {}
        .hidden { display: none; }
        
        /* 月曆樣式 */
        .calendar-day {
            transition: all 0.2s ease-in-out;
            min-height: 6rem; /* 調整手機上的最小高度 */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        @media (min-width: 640px) {
            .calendar-day {
                min-height: 7rem;
            }
        }
        .calendar-day.cursor-pointer:not(.no-hover):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .today {
            box-shadow: inset 0 0 0 2px #4f46e5;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <!-- Login Form -->
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center">登入系統</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <input type="text" id="login-username" placeholder="用戶名稱" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="login-password" placeholder="密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">登入</button>
                    <p class="text-center text-sm">還沒有帳號？ <a href="#" id="show-register" class="font-medium text-indigo-600 hover:underline">立即註冊</a></p>
                </form>
            </div>
            <!-- Register Form -->
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center">註冊新帳號</h2>
                <form id="register-form" class="mt-8 space-y-6">
                    <input type="text" id="register-username" placeholder="用戶名稱 (登入用)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password" placeholder="密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password-confirm" placeholder="確認密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <div>
                        <label for="register-role" class="block text-sm font-medium text-gray-700 sr-only">選擇您的職位</label>
                        <select id="register-role" required class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>請選擇您的職位</option>
                            <option value="内場工讀生">内場工讀生</option>
                            <option value="内場備菜班">内場備菜班</option>
                            <option value="内場炸爐班">内場炸爐班</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">註冊</button>
                    <p class="text-center text-sm">已經有帳號了？ <a href="#" id="show-login" class="font-medium text-indigo-600 hover:underline">返回登入</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-center text-red-500 text-sm mt-4"></p>
        </div>
    </div>
    
    <!-- App Container -->
    <div id="app" class="hidden min-h-screen p-1 sm:p-4 md:p-8">
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-2 sm:p-6 md:p-8">
            
            <!-- Header -->
            <header class="mb-6 md:mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span class="material-icons-outlined text-2xl md:text-3xl text-indigo-600">event_available</span>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">員工自主排班系統</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-xs sm:text-sm text-gray-600">使用者: <span id="userName" class="font-semibold bg-gray-100 p-1 rounded"></span> (<span id="userRole" class="font-semibold"></span>)</p>
                        <button id="logout-btn" class="flex items-center gap-1 text-sm text-red-500 hover:text-red-700">
                            <span class="material-icons-outlined">logout</span>
                            <span class="hidden sm:inline">登出</span>
                        </button>
                    </div>
                </div>
                <p id="app-subtitle" class="mt-2 text-gray-500 text-sm md:text-base">一個讓團隊合作更順暢的排班解決方案。</p>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Standard View for Admins -->
                <div id="standard-view">
                    <!-- ... (admin view remains unchanged) ... -->
                </div>

                <!-- Calendar View -->
                <div id="calendar-view" class="hidden">
                    <!-- This will be dynamically structured based on role -->
                </div>
            </main>
        </div>

        <!-- Notification Toast -->
        <div id="toast" class="fixed bottom-8 right-8 bg-gray-900 text-white py-3 px-6 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-500 ease-in-out">
            <p id="toast-message"></p>
        </div>
    </div>

    <script type="module">
        // Firebase v9+ modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            onSnapshot,
            collection,
            query,
            where,
            writeBatch,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===================================================================================
        // === 重要：請將下方的 firebaseConfig 物件替換成您自己的 Firebase 專案設定 ===
        // ===================================================================================
        const firebaseConfig = {
        apiKey: "AIzaSyBEMnLL-ppl8-jQnA1RzZW8JfsUjCqEOFQ",
        authDomain: "schedule-hantaitai.firebaseapp.com",
        databaseURL: "https://schedule-hantaitai-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "schedule-hantaitai",
        storageBucket: "schedule-hantaitai.firebasestorage.app",
        messagingSenderId: "600535535784",
        appId: "1:600535535784:web:397ad1387e60f87479b29d"
        };
        // ===================================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- App State ---
            let currentUser = null; // Will contain auth user object
            let currentUserData = null; // Will contain user data from Firestore
            let allUsers = [];
            let allData = {}; // A single object to hold all schedule data for realtime updates
            let calendarDate = new Date();
            let holidaysCache = {}; // Cache for fetched holiday data
            let unsubscribeListeners = []; // To store unsubscribe functions for cleanup on logout
            
            const ADMIN_ROLE = "管理者";
            const FULLTIME_ROLES = ["内場備菜班", "内場炸爐班"];
            const PART_TIMER_ROLE = "内場工讀生";

            // --- UI Elements ---
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app');
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authError = document.getElementById('auth-error');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');
            const logoutBtn = document.getElementById('logout-btn');
            const userNameSpan = document.getElementById('userName');
            const userRoleSpan = document.getElementById('userRole');
            const appSubtitle = document.getElementById('app-subtitle');
            const calendarView = document.getElementById('calendar-view');

            // --- Helper Functions ---
            function showToast(message) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.remove('translate-y-20', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            async function fetchHolidays(year) {
                if (holidaysCache[year]) {
                    return holidaysCache[year];
                }

                const fallback2025 = new Map([
                    ['2025-01-01', '中華民國開國紀念日'],['2025-01-28', '農曆除夕'],['2025-01-29', '農曆春節'],['2025-01-30', '農曆春節'],
                    ['2025-01-31', '農曆春節'],['2025-02-28', '和平紀念日'],['2025-04-04', '兒童節'],['2025-05-31', '端午節'],
                    ['2025-10-06', '中秋節'],['2025-10-10', '國慶日']
                ]);

                try {
                    const response = await fetch(`https://cdn.jsdelivr.net/gh/g0v/tw-holiday@master/data/${year}.json`);
                    if (!response.ok) {
                        if (year === 2025 || year === '2025') {
                            console.warn(`無法從網路獲取 ${year} 年的假日資訊，將使用內建的備用資料。`);
                            holidaysCache[year] = fallback2025;
                            return holidaysCache[year];
                        }
                        console.warn(`Could not fetch holidays for ${year}. The API might not have data for this year.`);
                        holidaysCache[year] = new Map();
                        return holidaysCache[year];
                    }
                    const data = await response.json();
                    const holidaysMap = new Map();
                    data.holidays.forEach(holiday => {
                        if (holiday.isHoliday) { 
                           holidaysMap.set(holiday.date, holiday.name);
                        }
                    });
                    holidaysCache[year] = holidaysMap;
                    return holidaysMap;
                } catch (error) {
                    console.warn("Network error fetching holiday data:", error);
                     if (year === 2025 || year === '2025') {
                        console.warn(`網路錯誤導致無法獲取 ${year} 年的假日資訊，將使用內建的備用資料。`);
                        holidaysCache[year] = fallback2025;
                        return holidaysCache[year];
                    }
                    holidaysCache[year] = new Map();
                    return holidaysCache[year];
                }
            }

            // --- Realtime Data Listeners ---
            function setupRealtimeListeners() {
                const dataDocRef = doc(db, "scheduleData", "main");
                const usersColRef = collection(db, "users");

                const unsubData = onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        allData = docSnap.data();
                    } else {
                        // Initialize data if it doesn't exist
                        setDoc(doc(db, "scheduleData", "main"), {
                            userVacations: {},
                            userAvailability: {},
                            coverSignups: {},
                            adminHolidays: []
                        });
                    }
                    if (currentUserData) renderAppView(); // Re-render when data changes
                });

                const unsubUsers = onSnapshot(query(collection(db, "users")), (snapshot) => {
                    allUsers = [];
                    snapshot.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
                    if (currentUserData) renderAppView(); // Re-render when users change
                });
                
                unsubscribeListeners.push(unsubData, unsubUsers);
            }

            function cleanupListeners() {
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
            }

            // --- Calendar & Shift Logic ---
            async function renderPartTimerView() {
                const month = calendarDate.getMonth();
                const year = calendarDate.getFullYear();
                const { userVacations = {}, adminHolidays = [], coverSignups = {} } = allData;
                
                let availableCoverShifts = [];
                const fullTimeUsers = allUsers.filter(u => FULLTIME_ROLES.includes(u.role));
                
                fullTimeUsers.forEach(user => {
                    const vacationKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[vacationKey] || [];
                    monthlyVacations.forEach(dateString => {
                        const vacationDate = new Date(...dateString.split('-').map((n, i) => i === 1 ? n - 1 : n));
                        if (vacationDate.getDay() === 4 || adminHolidays.includes(dateString)) return;

                        const slots = (user.role === '内場備菜班') 
                            ? [{ key: 'AM', time: '10:00 - 14:00' }, { key: 'PM', time: '16:30 - 20:00' }]
                            : [{ key: 'AM', time: '10:30 - 14:00' }, { key: 'PM', time: '17:00 - 21:00' }];
                        
                        slots.forEach(slot => {
                            availableCoverShifts.push({
                                id: `cover-${user.id}-${dateString}-${slot.key}`,
                                date: dateString,
                                time: slot.time,
                                fullTimerName: user.username,
                                fullTimerRole: user.role,
                            });
                        });
                    });
                });
                
                availableCoverShifts.sort((a, b) => {
                    const roleOrder = { '内場備菜班': 1, '内場炸爐班': 2 };
                    if (roleOrder[a.fullTimerRole] !== roleOrder[b.fullTimerRole]) {
                        return roleOrder[a.fullTimerRole] - roleOrder[b.fullTimerRole];
                    }
                    return new Date(a.date) - new Date(b.date);
                });

                calendarView.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8">
                        <div id="cover-shifts-panel" class="md:col-span-1 bg-gray-50 p-2 sm:p-4 rounded-lg h-fit">
                            <h3 class="font-bold text-lg mb-4 text-center">可代班列表</h3>
                            <div id="cover-shifts-list" class="space-y-3 max-h-[50vh] md:max-h-[60vh] overflow-y-auto"></div>
                        </div>
                        <div class="md:col-span-2">
                            <div id="calendar-header" class="flex items-center justify-between mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                                <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                            </div>
                            <div id="calendar-weekdays" class="grid grid-cols-7 gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                            <p class="text-center text-sm text-gray-500 mt-4">點擊月曆日期來標示您的可上班時間。</p>
                        </div>
                    </div>
                `;

                const coverShiftsList = document.getElementById('cover-shifts-list');
                if (availableCoverShifts.length === 0) {
                    coverShiftsList.innerHTML = `<p class="text-center text-gray-500 p-4">本月尚無代班需求。</p>`;
                } else {
                    availableCoverShifts.forEach(shift => {
                        const isSignedUpByCurrentUser = coverSignups[shift.id] === currentUser.uid;
                        const isTakenByOther = coverSignups[shift.id] && !isSignedUpByCurrentUser;
                        const card = document.createElement('div');
                        card.className = 'bg-white p-3 rounded-md shadow-sm border-l-4';
                        
                        let buttonHtml;
                        if (isSignedUpByCurrentUser) {
                            card.classList.add('border-green-500');
                            buttonHtml = `<button data-id="${shift.id}" class="cancel-cover-btn w-full mt-2 text-sm bg-red-500 text-white py-1 rounded hover:bg-red-600">取消代班</button>`;
                        } else if (isTakenByOther) {
                            card.classList.add('border-gray-300');
                            const taker = allUsers.find(u => u.id === coverSignups[shift.id]);
                            buttonHtml = `<div class="mt-2 text-sm text-center font-semibold bg-gray-200 text-gray-600 py-1 rounded">已被 ${taker ? taker.username : ''} 預約</div>`;
                        } else {
                            card.classList.add('border-indigo-500');
                            buttonHtml = `<button data-id="${shift.id}" class="signup-cover-btn w-full mt-2 text-sm bg-indigo-600 text-white py-1 rounded hover:bg-indigo-700">我要代班</button>`;
                        }

                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <p class="font-bold">${shift.date}</p>
                                <p class="text-sm font-semibold bg-gray-200 px-2 py-1 rounded">${shift.time}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">休假人員: ${shift.fullTimerName} (${shift.fullTimerRole})</p>
                            ${buttonHtml}
                        `;
                        coverShiftsList.appendChild(card);
                    });
                }
                
                await renderFullCalendar();
            }
            
            async function renderFullTimeView() {
                calendarView.innerHTML = `
                    <div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="grid grid-cols-7 gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                        <p class="text-center text-sm text-gray-500 mt-4"></p>
                    </div>
                `;
                 const instructions = calendarView.querySelector('p');
                if (currentUserData.role === ADMIN_ROLE) {
                    instructions.textContent = "點擊日期以設定或取消該日為全體公休日。";
                } else {
                    instructions.textContent = "請點擊日期選擇您的休假日 (每月最多4天)。";
                }
                await renderFullCalendar();
            }

            async function renderFullCalendar() {
                calendarDate.setDate(1);
                const month = calendarDate.getMonth();
                const year = calendarDate.getFullYear();
                
                document.getElementById('calendar-month-year').textContent = `${year}年 ${month + 1}月`;
                
                const holidays = await fetchHolidays(year);
                const { userVacations = {}, adminHolidays = [], coverSignups = {}, userAvailability = {} } = allData;

                const dailySchedule = {};
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dailySchedule[dateString] = [];
                }

                allUsers.filter(u => FULLTIME_ROLES.includes(u.role)).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[userMonthKey] || [];
                    for (let i = 1; i <= lastDayOfMonth; i++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        if (!monthlyVacations.includes(dateString)) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    }
                });

                Object.keys(coverSignups).forEach(coverId => {
                    const parts = coverId.split('-');
                    if (parts.length < 5) return;
                    const dateString = parts.slice(parts.length - 4, parts.length - 1).join('-');
                    const timeSlot = parts[parts.length - 1];
                    const date = new Date(dateString);

                    if (date.getFullYear() === year && date.getMonth() === month) {
                         const ptUserId = coverSignups[coverId];
                         const ptUser = allUsers.find(u => u.id === ptUserId);
                         const fullTimerId = parts.slice(1, parts.length - 4).join('-');
                         const originalFullTimer = allUsers.find(u => u.id === fullTimerId);

                         if(ptUser && originalFullTimer) {
                            dailySchedule[dateString].push({ username: ptUser.username, role: originalFullTimer.role, isCover: true, timeSlot });
                         }
                    }
                });
                
                allUsers.filter(u => u.role === PART_TIMER_ROLE).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyAvailability = userAvailability[userMonthKey] || [];
                    monthlyAvailability.forEach(dateString => {
                        const alreadyScheduled = dailySchedule[dateString].some(s => s.username === user.username);
                        if (!alreadyScheduled) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    });
                });

                const calendarGrid = document.getElementById('calendar-grid');
                calendarGrid.innerHTML = '';
                const firstDayIndex = calendarDate.getDay();
                const prevLastDay = new Date(year, month, 0).getDate();
                for (let i = firstDayIndex; i > 0; i--) {
                    calendarGrid.innerHTML += `<div class="p-1 sm:p-2 text-center text-gray-300 no-hover">${prevLastDay - i + 1}</div>`;
                }

                const todayString = new Date().toISOString().split('T')[0];

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const day = document.createElement('div');
                    const isThursday = new Date(year, month, i).getDay() === 4;
                    const holidayName = holidays.get(dateString);
                    const isAdminHoliday = adminHolidays.includes(dateString);

                    day.className = `calendar-day p-1 sm:p-2 rounded-lg text-left`;
                    day.dataset.date = dateString;

                    if (isThursday || isAdminHoliday) {
                        day.classList.add('bg-red-100');
                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800">${i}</span></div><div class="flex-grow flex items-center justify-center"><p class="font-bold text-red-700 text-xs sm:text-sm">公休日</p></div>`;
                        if (currentUserData.role === ADMIN_ROLE && !isThursday) day.classList.add('cursor-pointer'); 
                    } else {
                        if(holidayName) day.classList.add('bg-yellow-100');
                        
                        if (FULLTIME_ROLES.includes(currentUserData.role) || currentUserData.role === PART_TIMER_ROLE || currentUserData.role === ADMIN_ROLE) {
                            day.classList.add('cursor-pointer');
                        }

                        const workingUsers = dailySchedule[dateString] || [];
                        let usersHtml = '<div class="flex-grow"></div>';
                        if (workingUsers.length > 0) {
                            const displayGroups = {};
                            workingUsers.forEach(workInfo => {
                                let roleLabel = '';
                                if (workInfo.role === '内場備菜班') roleLabel = '備菜班';
                                else if (workInfo.role === '内場炸爐班') roleLabel = '炸爐班';
                                else if (workInfo.role === PART_TIMER_ROLE && !workInfo.isCover) roleLabel = '收班';
                                if (!roleLabel) return;
                                
                                if (!displayGroups[roleLabel]) displayGroups[roleLabel] = {};

                                if (workInfo.isCover) {
                                    const timeKey = workInfo.timeSlot === 'AM' ? 'morning' : 'evening';
                                    displayGroups[roleLabel][timeKey] = workInfo.username;
                                } else {
                                    displayGroups[roleLabel].fullDay = workInfo.username;
                                }
                            });

                            const userListHtml = [];
                            const order = ['備菜班', '炸爐班', '收班'];

                            order.forEach(roleLabel => {
                                const group = displayGroups[roleLabel];
                                if (!group) return;
                                
                                let colorClass = '';
                                if (roleLabel === '備菜班') colorClass = 'font-semibold text-green-800';
                                else if (roleLabel === '炸爐班') colorClass = 'font-semibold text-amber-800';
                                else if (roleLabel === '收班') colorClass = 'font-semibold text-blue-800';

                                if (group.fullDay) userListHtml.push(`<div class="${colorClass}">${roleLabel}：${group.fullDay}</div>`);
                                if (group.morning) userListHtml.push(`<div class="${colorClass}">${roleLabel} 早上：${group.morning}</div>`);
                                if (group.evening) userListHtml.push(`<div class="${colorClass}">${roleLabel} 晚上：${group.evening}</div>`);
                            });
                            usersHtml = `<div class="mt-1 text-xs text-gray-600 leading-tight overflow-hidden">${userListHtml.join('')}</div>`;
                        }
                        
                        let selfStatusHtml = '';
                        if (currentUserData.role === ADMIN_ROLE) {
                            if(!holidayName) day.classList.add('bg-gray-50');
                        } else if (FULLTIME_ROLES.includes(currentUserData.role)) {
                            const vacationKey = `${currentUser.uid}-${year}-${month+1}`;
                            const isVacation = (userVacations[vacationKey] || []).includes(dateString);
                            if (isVacation) {
                                day.classList.add('bg-red-100', 'border', 'border-red-400');
                                selfStatusHtml = `<p class="text-xs font-semibold text-red-700">休假</p>`;
                            } else {
                                if(!holidayName) day.classList.add('bg-green-100');
                                day.classList.add('border', 'border-green-400');
                                selfStatusHtml = `<p class="text-xs font-semibold text-green-700">上班日</p>`;
                            }
                        } else if (currentUserData.role === PART_TIMER_ROLE) {
                            const availabilityKey = `${currentUser.uid}-${year}-${month+1}`;
                            const isAvailable = (userAvailability[availabilityKey] || []).includes(dateString);
                            const isWorkingCoverShift = workingUsers.some(w => w.username === currentUserData.username && w.isCover);

                            if (isAvailable) {
                                if(!holidayName) day.classList.add('bg-blue-100');
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="text-xs font-semibold text-blue-700">要上班</p>`;
                            } else {
                                if(!holidayName) day.classList.add('bg-white');
                                selfStatusHtml = `<p class="text-xs text-gray-400">休息</p>`;
                            }
                            if (isWorkingCoverShift) {
                                selfStatusHtml += `<p class="text-xs font-bold text-green-700">(已代班)</p>`;
                            }
                        }

                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800">${i}</span>${holidayName ? `<p class="text-xs font-bold text-yellow-800">${holidayName}</p>` : ''}${selfStatusHtml}</div>${usersHtml}`;
                    }
                    
                    if (dateString === todayString) day.classList.add('today');
                    calendarGrid.appendChild(day);
                }
            }
            
            async function handleDayClick(e) {
                const dayDiv = e.target.closest('.calendar-day');
                if (!dayDiv || !dayDiv.dataset.date) return;
                
                const clickedDateStr = dayDiv.dataset.date;
                const [year, month, day] = clickedDateStr.split('-').map(Number);
                const clickedDate = new Date(year, month - 1, day);
                const { adminHolidays: currentAdminHolidays = [] } = allData;
                
                if (currentUserData.role === ADMIN_ROLE) {
                    if (clickedDate.getDay() === 4) return showToast("星期四是固定公休日，無法更改。");
                    
                    const newAdminHolidays = currentAdminHolidays.includes(clickedDateStr)
                        ? currentAdminHolidays.filter(d => d !== clickedDateStr)
                        : [...currentAdminHolidays, clickedDateStr];
                    
                    await setDoc(doc(db, "scheduleData", "main"), { adminHolidays: newAdminHolidays }, { merge: true });
                    showToast(currentAdminHolidays.includes(clickedDateStr) ? `${clickedDateStr} 已取消公休。` : `${clickedDateStr} 已設定為公休日。`);
                    return;
                }
                
                if (clickedDate.getDay() === 4 || currentAdminHolidays.includes(clickedDateStr)) {
                    return showToast("此日為公休日，無法排班");
                }
                
                const [yearFromStr, monthFromStr] = clickedDateStr.split('-');

                if (FULLTIME_ROLES.includes(currentUserData.role)) {
                    const vacationKey = `${currentUser.uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                    const currentVacations = allData.userVacations?.[vacationKey] || [];
                    const newVacations = currentVacations.includes(clickedDateStr)
                        ? currentVacations.filter(d => d !== clickedDateStr)
                        : [...currentVacations, clickedDateStr];
                    
                    if(newVacations.length > 4) return showToast('本月休假已選滿4天');
                    
                    await setDoc(doc(db, "scheduleData", "main"), { userVacations: { ...allData.userVacations, [vacationKey]: newVacations } }, { merge: true });
                } else if (currentUserData.role === PART_TIMER_ROLE) {
                    const availabilityKey = `${currentUser.uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                    const currentAvailability = allData.userAvailability?.[availabilityKey] || [];
                    const newAvailability = currentAvailability.includes(clickedDateStr)
                        ? currentAvailability.filter(d => d !== clickedDateStr)
                        : [...currentAvailability, clickedDateStr];
                        
                    await setDoc(doc(db, "scheduleData", "main"), { userAvailability: { ...allData.userAvailability, [availabilityKey]: newAvailability } }, { merge: true });
                }
            }

            async function handleCoverShiftAction(e) {
                const button = e.target;
                const shiftId = button.dataset.id;
                const { coverSignups: currentCoverSignups = {} } = allData;
                
                if (button.classList.contains('signup-cover-btn')) {
                    if (currentCoverSignups[shiftId]) return showToast('此班次已被預約！');
                    
                    await setDoc(doc(db, "scheduleData", "main"), { coverSignups: { ...currentCoverSignups, [shiftId]: currentUser.uid } }, { merge: true });
                    showToast('成功預約代班！');
                } else if (button.classList.contains('cancel-cover-btn')) {
                    if (currentCoverSignups[shiftId] === currentUser.uid) {
                        const newCoverSignups = { ...currentCoverSignups };
                        delete newCoverSignups[shiftId];
                        await setDoc(doc(db, "scheduleData", "main"), { coverSignups: newCoverSignups }, { merge: true });
                        showToast('已取消代班。');
                    }
                }
            }

            // --- Auth Logic ---
            async function handleRegister(e) {
                e.preventDefault();
                authError.textContent = '';
                const username = registerForm.querySelector('#register-username').value.trim();
                const password = registerForm.querySelector('#register-password').value;
                const passwordConfirm = registerForm.querySelector('#register-password-confirm').value;
                const role = registerForm.querySelector('#register-role').value;
                
                if (!username || !password || !role || !passwordConfirm) return authError.textContent = '所有欄位皆為必填。';
                if (password.length < 6) return authError.textContent = '密碼長度至少需要6位數。';
                if (password !== passwordConfirm) return authError.textContent = '兩次輸入的密碼不一致。';
                
                const q = query(collection(db, "users"), where("username_lowercase", "==", username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) return authError.textContent = '此用戶名稱已被使用。';
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, `${username.toLowerCase()}@schedule-app.com`, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, "users", user.uid), {
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        role: role
                    });
                } catch (error) {
                    console.error("Register error:", error);
                    authError.textContent = "註冊失敗，請稍後再試。";
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                authError.textContent = '';
                const username = loginForm.querySelector('#login-username').value.trim().toLowerCase();
                const password = loginForm.querySelector('#login-password').value;
                
                try {
                    await signInWithEmailAndPassword(auth, `${username}@schedule-app.com`, password);
                } catch (error) {
                    console.error("Login error:", error);
                    authError.textContent = "用戶名稱或密碼錯誤。";
                }
            }

            function handleLogout() {
                signOut(auth);
            }
            
            function renderAppView() {
                if(!currentUserData) return;
                
                if (FULLTIME_ROLES.includes(currentUserData.role) || currentUserData.role === ADMIN_ROLE) {
                    calendarView.classList.remove('hidden');
                    appSubtitle.textContent = currentUserData.role === ADMIN_ROLE ? "團隊排班總覽" : "請在下方月曆選擇您的休假日。";
                    renderFullTimeView();
                } else if (currentUserData.role === PART_TIMER_ROLE) {
                    calendarView.classList.remove('hidden');
                    appSubtitle.textContent = "請從左方列表選擇您要代班的時段。";
                    renderPartTimerView();
                }
            }
            
            // --- Initialization ---
            onAuthStateChanged(auth, async (user) => {
                cleanupListeners();
                if (user) {
                    currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    
                    if (userDocSnap.exists()) {
                        currentUserData = { uid: user.uid, ...userDocSnap.data() };
                        userNameSpan.textContent = currentUserData.username;
                        userRoleSpan.textContent = currentUserData.role;
                        
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        
                        setupRealtimeListeners(); // This will trigger the first render
                    } else {
                        // This case is unlikely but good for safety
                        console.error("User data not found in Firestore!");
                        handleLogout();
                    }
                } else {
                    currentUser = null;
                    currentUserData = null;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });

            function setupEventListeners() {
                showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden'); authError.textContent=''; });
                showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden'); authError.textContent=''; });
                
                registerForm.addEventListener('submit', handleRegister);
                loginForm.addEventListener('submit', handleLogin);
                logoutBtn.addEventListener('click', handleLogout);

                calendarView.addEventListener('click', async (e) => {
                    if (e.target.closest('#prev-month-btn')) {
                        calendarDate.setMonth(calendarDate.getMonth() - 1);
                        renderAppView();
                    }
                    if (e.target.closest('#next-month-btn')) {
                        calendarDate.setMonth(calendarDate.getMonth() + 1);
                        renderAppView();
                    }
                    if (e.target.closest('.calendar-day')) {
                        await handleDayClick(e);
                    }
                    if (e.target.closest('.signup-cover-btn') || e.target.closest('.cancel-cover-btn')) {
                        await handleCoverShiftAction(e);
                    }
                });
            }
            
            setupEventListeners();
        });
    </script>
</body>
</html>

