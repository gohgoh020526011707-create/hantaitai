<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ“æ³°æ³°æ’ç­ç³»çµ±</title>
    
    <!-- === å„ªåŒ– 3.2: é è¼‰å…¥é—œéµè³‡æº === -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- === å„ªåŒ– 3.2: å­—é«”åŠ è¼‰å„ªåŒ– (font-display: swap) === -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"></noscript>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"></noscript>
    <style>
        /* === å„ªåŒ– 3.1: é—œéµ CSS å…§è¯ === */
        /* é¦–å±æ¸²æŸ“æ‰€éœ€çš„é—œéµæ¨£å¼ï¼Œæ¸›å°‘ FOUC (Flash of Unstyled Content) */
        
        /* åŸºç¤æ¨£å¼ */
        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f0f4f8;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Material Icons */
        .material-icons-outlined {
            font-size: 1.25rem;
            font-display: swap;
        }
        
        /* æ»¾å‹•æ¢ç¾åŒ– - ä½¿ç”¨ GPU åŠ é€Ÿ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* é¿å… Tailwind CSS JIT ç·¨è­¯å™¨ç§»é™¤å‹•æ…‹ class */
        .bg-blue-100, .bg-green-100, .bg-yellow-100, .bg-indigo-100, .bg-pink-100, .bg-purple-100, .bg-gray-100, .bg-orange-100 {}
        .text-blue-800, .text-green-800, .text-yellow-800, .text-indigo-800, .text-pink-800, .text-purple-800, .text-gray-800, .text-amber-800, .text-orange-800 {}
        .border-blue-400, .border-green-400, .border-yellow-400, .border-indigo-400, .border-pink-400, .border-purple-400, .border-gray-400, .border-orange-400 {}
        .hidden { display: none; }
        
        /* æœˆæ›†æ¨£å¼ - å„ªåŒ–å‹•ç•«æ€§èƒ½ */
        .calendar-day {
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            min-height: 6rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            will-change: transform; /* GPU åŠ é€Ÿæç¤º */
            contain: layout style; /* CSS Containment å„ªåŒ– */
        }
        @media (min-width: 640px) {
            .calendar-day {
                min-height: 7rem;
            }
        }
        .calendar-day.cursor-pointer:not(.no-hover):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .today {
            box-shadow: inset 0 0 0 2px #4f46e5;
        }
        .custom-calendar-grid {
            display: grid;
            grid-template-columns: 1.15fr 1.15fr 1.15fr 1.15fr 0.5fr 1.15fr 1.15fr;
            contain: layout; /* CSS Containment å„ªåŒ– */
        }
        
        /* Modal Style - å„ªåŒ–éæ¸¡å‹•ç•« */
        #cover-shift-modal.hidden,
        #shift-select-modal.hidden,
        #vacation-time-modal.hidden,
        #delete-user-modal.hidden,
        #settings-modal.hidden {
            display: none;
            opacity: 0;
        }
        #cover-shift-modal:not(.hidden),
        #shift-select-modal:not(.hidden),
        #vacation-time-modal:not(.hidden),
        #delete-user-modal:not(.hidden),
        #settings-modal:not(.hidden) {
            display: flex;
            opacity: 1;
        }
        
        /* æ¸›å°‘é‡ç¹ªçš„å„ªåŒ– */
        .calendar-day span,
        .calendar-day p {
            contain: content;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- === å„ªåŒ– 3.6: è¼‰å…¥å‹•ç•« === -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-[100]">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
            <p class="mt-4 text-gray-600 font-medium">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center">ç™»å…¥ç³»çµ±</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <input type="text" id="login-username" placeholder="ç”¨æˆ¶åç¨±" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="login-password" placeholder="å¯†ç¢¼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">ç™»å…¥</button>
                    <p class="text-center text-sm">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="#" id="show-register" class="font-medium text-indigo-600 hover:underline">ç«‹å³è¨»å†Š</a></p>
                </form>
            </div>
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center">è¨»å†Šæ–°å¸³è™Ÿ</h2>
                <form id="register-form" class="mt-8 space-y-6">
                    <input type="text" id="register-username" placeholder="ç”¨æˆ¶åç¨± (ç™»å…¥ç”¨)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password" placeholder="å¯†ç¢¼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password-confirm" placeholder="ç¢ºèªå¯†ç¢¼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <div>
                        <label for="register-role" class="block text-sm font-medium text-gray-700 sr-only">é¸æ“‡æ‚¨çš„è·ä½</label>
                        <select id="register-role" required class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>è«‹é¸æ“‡æ‚¨çš„è·ä½</option>
                            <option value="å†…å ´å·¥è®€ç”Ÿ">å†…å ´å·¥è®€ç”Ÿ</option>
                            <option value="å¤–å ´å·¥è®€ç”Ÿ">å¤–å ´å·¥è®€ç”Ÿ</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">è¨»å†Š</button>
                    <p class="text-center text-sm">å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ <a href="#" id="show-login" class="font-medium text-indigo-600 hover:underline">è¿”å›ç™»å…¥</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-center text-red-500 text-sm mt-4"></p>
        </div>
    </div>
    
    <div id="app" class="hidden min-h-screen p-1 sm:p-4 md:p-8">
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-2 sm:p-6 md:p-8">
            
            <header class="mb-6 md:mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span class="material-icons-outlined text-2xl md:text-3xl text-indigo-600">event_available</span>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">éŸ“æ³°æ³°æ’ç­ç³»çµ±</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-xs sm:text-sm text-gray-600">ä½¿ç”¨è€…: <span id="userName" class="font-semibold bg-gray-100 p-1 rounded"></span> (<span id="userRole" class="font-semibold"></span>)</p>
                        <button id="settings-btn" class="hidden items-center gap-1 text-sm text-gray-600 hover:text-indigo-600">
                            <span class="material-icons-outlined">settings</span>
                            <span class="hidden sm:inline">å€‹äººè¨­å®š</span>
                        </button>
                        <button id="logout-btn" class="flex items-center gap-1 text-sm text-red-500 hover:text-red-700">
                            <span class="material-icons-outlined">logout</span>
                            <span class="hidden sm:inline">ç™»å‡º</span>
                        </button>
                    </div>
                </div>
                <p id="app-subtitle" class="mt-2 text-gray-500 text-sm md:text-base">ä¸€å€‹è®“åœ˜éšŠåˆä½œæ›´é †æš¢çš„æ’ç­è§£æ±ºæ–¹æ¡ˆã€‚</p>
            </header>

            <main>
                <div id="calendar-view" class="hidden">
                </div>
            </main>
        </div>

        <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">å€‹äººè¨­å®š</h2>
                    <button id="close-settings-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-8">
                    <form id="change-username-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">ä¿®æ”¹é¡¯ç¤ºåç¨±</h3>
                        <input type="text" id="new-username" placeholder="æ–°çš„é¡¯ç¤ºåç¨±" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">æ›´æ–°åç¨±</button>
                        <p id="username-settings-error" class="text-center text-red-500 text-sm mt-2"></p>
                    </form>
                    <hr>
                    <form id="change-password-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">ä¿®æ”¹å¯†ç¢¼</h3>
                        <input type="password" id="new-password" placeholder="æ–°å¯†ç¢¼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <input type="password" id="confirm-new-password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">æ›´æ–°å¯†ç¢¼</button>
                        <p id="password-settings-error" class="text-center text-red-500 text-sm mt-2"></p>
                    </form>
                </div>
            </div>
        </div>

        <div id="shift-select-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">é¸æ“‡ç­æ¬¡</h2>
                    <button id="close-shift-select-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <p id="shift-select-info" class="text-gray-700 mb-4">æ‚¨åœ¨é€™å¤©æœ‰å¤šå€‹ç­æ¬¡ï¼Œè«‹é¸æ“‡è¦æ‰¾äººä»£ç­çš„ç­æ¬¡ï¼š</p>
                <div id="shift-select-options" class="space-y-3">
                    </div>
            </div>
        </div>

        <div id="cover-shift-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">æŒ‡å®šä»£ç­</h2>
                    <button id="close-cover-shift-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <form id="cover-shift-form">
                    <p id="cover-shift-info" class="text-center text-gray-700 mb-4">
                        </p>
                    <div class="space-y-4">
                        <label for="cover-shift-replacement-select" class="block text-sm font-medium text-gray-700">è«‹é¸æ“‡ä»£ç­äººå“¡ï¼š</label>
                        <select id="cover-shift-replacement-select" required class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>é¸æ“‡ä¸€ä½å¤–å ´å·¥è®€ç”Ÿ</option>
                            </select>
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">ç¢ºèªæ›ç­</button>
                    </div>
                </form>
            </div>
        </div>


        <div id="vacation-time-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-600">é¸æ“‡ä¼‘å‡æ™‚é–“</h2>
                    <button id="close-vacation-time-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-4">
                    <p id="vacation-time-info" class="text-gray-700">è«‹é¸æ“‡æ‚¨è¦ä¼‘å‡çš„æ™‚é–“æ®µï¼š</p>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="vacation-morning" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">æ—©ä¸Šä¼‘å‡</span>
                                <p class="text-sm text-gray-500">å‹¾é¸è¡¨ç¤ºæ—©ä¸Šä¼‘å‡ï¼Œä¸å‹¾é¸è¡¨ç¤ºå¯ä»¥æ’æ—©æ«ƒã€æ—©ç­</p>
                            </div>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="vacation-evening" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">æ™šä¸Šä¼‘å‡</span>
                                <p class="text-sm text-gray-500">å‹¾é¸è¡¨ç¤ºæ™šä¸Šä¼‘å‡ï¼Œä¸å‹¾é¸è¡¨ç¤ºå¯ä»¥æ’æ™šæ«ƒã€æ™šç­ã€æ´—ç¢—ã€æ”¶ç­</p>
                            </div>
                        </label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button id="confirm-vacation-time-btn" class="flex-1 p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                            ç¢ºèª
                        </button>
                        <button id="cancel-vacation-time-btn" class="flex-1 p-3 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="delete-user-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-red-600">ç¢ºèªåˆªé™¤ç”¨æˆ¶</h2>
                    <button id="close-delete-user-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-4">
                    <p id="delete-user-info" class="text-gray-700">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹ç”¨æˆ¶å—ï¼Ÿ</p>
                    <p class="text-sm text-red-600 font-semibold">è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ç”¨æˆ¶åŠå…¶æ‰€æœ‰ç›¸é—œæ•¸æ“šï¼ŒåŒ…æ‹¬ï¼š</p>
                    <ul class="text-sm text-gray-600 list-disc list-inside ml-4">
                        <li>ç”¨æˆ¶å¸³è™Ÿ</li>
                        <li>æ‰€æœ‰æ’ç­è¨˜éŒ„</li>
                        <li>ä¼‘å‡è¨˜éŒ„</li>
                        <li>ä»£ç­è¨˜éŒ„</li>
                    </ul>
                    <div class="flex gap-3 pt-4">
                        <button id="confirm-delete-user-btn" class="flex-1 p-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
                            ç¢ºèªåˆªé™¤
                        </button>
                        <button id="cancel-delete-user-btn" class="flex-1 p-3 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-8 right-8 bg-gray-900 text-white py-3 px-6 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-500 ease-in-out">
            <p id="toast-message"></p>
        </div>
    </div>

    <script type="module">
        // Firebase v9+ modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            writeBatch,
            getDocs,
            enableIndexedDbPersistence
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===================================================================================
        // === å·¥å…·å‡½æ•¸ (Utility Functions) ===
        // ===================================================================================
        
        // é˜²æŠ–å‡½æ•¸ - ç”¨æ–¼æ¸›å°‘é«˜é »æ“ä½œ
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // é«˜æ•ˆæ·±æ‹·è² (ä½¿ç”¨ structuredClone æˆ–å›é€€æ–¹æ¡ˆ)
        function deepClone(obj) {
            if (typeof structuredClone === 'function') {
                return structuredClone(obj);
            }
            return JSON.parse(JSON.stringify(obj));
        }

        // æ—¥æœŸæ ¼å¼åŒ–å¿«å–
        const dateFormatCache = new Map();
        function formatDateString(year, month, day) {
            const key = `${year}-${month}-${day}`;
            if (!dateFormatCache.has(key)) {
                dateFormatCache.set(key, `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
            }
            return dateFormatCache.get(key);
        }

        // ===================================================================================
        // === å„ªåŒ– 2.3: æœ¬åœ°å¿«å–ç®¡ç†å™¨ (LocalCacheManager) ===
        // ===================================================================================
        class LocalCacheManager {
            constructor(prefix = 'schedule_app_') {
                this.prefix = prefix;
                this.memoryCache = new Map(); // è¨˜æ†¶é«”å¿«å–å±¤
            }

            // ç”Ÿæˆå®Œæ•´çš„å¿«å–éµ
            _getKey(key) {
                return `${this.prefix}${key}`;
            }

            // è¨­ç½®å¿«å– (å¸¶éæœŸæ™‚é–“)
            set(key, data, ttlMinutes = 60) {
                const cacheData = {
                    data: data,
                    timestamp: Date.now(),
                    expiry: Date.now() + (ttlMinutes * 60 * 1000)
                };
                
                // åŒæ™‚å­˜å…¥è¨˜æ†¶é«”å’Œ localStorage
                this.memoryCache.set(key, cacheData);
                
                try {
                    localStorage.setItem(this._getKey(key), JSON.stringify(cacheData));
                } catch (e) {
                    // localStorage å¯èƒ½å·²æ»¿æˆ–è¢«ç¦ç”¨
                    console.warn('LocalStorage å¯«å…¥å¤±æ•—:', e.message);
                    this._cleanupOldCache();
                }
            }

            // è®€å–å¿«å–
            get(key) {
                // å„ªå…ˆå¾è¨˜æ†¶é«”å¿«å–è®€å–
                if (this.memoryCache.has(key)) {
                    const memData = this.memoryCache.get(key);
                    if (memData.expiry > Date.now()) {
                        return memData.data;
                    }
                    this.memoryCache.delete(key);
                }

                // å¾ localStorage è®€å–
                try {
                    const cached = localStorage.getItem(this._getKey(key));
                    if (cached) {
                        const cacheData = JSON.parse(cached);
                        if (cacheData.expiry > Date.now()) {
                            // å›å¡«è¨˜æ†¶é«”å¿«å–
                            this.memoryCache.set(key, cacheData);
                            return cacheData.data;
                        }
                        // éæœŸäº†ï¼Œåˆªé™¤
                        this.remove(key);
                    }
                } catch (e) {
                    console.warn('LocalStorage è®€å–å¤±æ•—:', e.message);
                }
                
                return null;
            }

            // æª¢æŸ¥å¿«å–æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
            has(key) {
                return this.get(key) !== null;
            }

            // ç§»é™¤å¿«å–
            remove(key) {
                this.memoryCache.delete(key);
                try {
                    localStorage.removeItem(this._getKey(key));
                } catch (e) {
                    // å¿½ç•¥éŒ¯èª¤
                }
            }

            // æ¸…ç†éæœŸçš„å¿«å–
            _cleanupOldCache() {
                try {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith(this.prefix)) {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                if (data.expiry && data.expiry < Date.now()) {
                                    keysToRemove.push(key);
                                }
                            } catch (e) {
                                keysToRemove.push(key);
                            }
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    console.log(`ğŸ§¹ å·²æ¸…ç† ${keysToRemove.length} å€‹éæœŸå¿«å–`);
                } catch (e) {
                    console.warn('æ¸…ç†å¿«å–å¤±æ•—:', e.message);
                }
            }

            // æ¸…é™¤æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼å¿«å–
            clearAll() {
                this.memoryCache.clear();
                try {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith(this.prefix)) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                } catch (e) {
                    console.warn('æ¸…é™¤å¿«å–å¤±æ•—:', e.message);
                }
            }
        }

        // å»ºç«‹å…¨åŸŸå¿«å–å¯¦ä¾‹
        const localCache = new LocalCacheManager();

        // === æ•ˆèƒ½ç›£æ§å·¥å…· (é–‹ç™¼æ™‚ä½¿ç”¨) ===
        const perfMonitor = {
            marks: {},
            start(name) {
                this.marks[name] = performance.now();
            },
            end(name) {
                if (this.marks[name]) {
                    const duration = performance.now() - this.marks[name];
                    if (duration > 50) { // åªè¨˜éŒ„è¶…é 50ms çš„æ“ä½œ
                        console.log(`â±ï¸ ${name}: ${duration.toFixed(2)}ms`);
                    }
                    delete this.marks[name];
                    return duration;
                }
                return 0;
            }
        };

        // ===================================================================================
        // === èªè­‰ç®¡ç†é¡åˆ¥ (AuthManager) ===
        // ===================================================================================
        class AuthManager {
            constructor(auth, db) {
                this.auth = auth;
                this.db = db;
                this.currentUser = null;
                this.currentUserData = null;
            }

            async register(username, password, passwordConfirm, role) {
                if (!username || !password || !role || !passwordConfirm) {
                    throw new Error('æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«ã€‚');
                }
                if (password.length < 6) {
                    throw new Error('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½æ•¸ã€‚');
                }
                if (password !== passwordConfirm) {
                    throw new Error('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ã€‚');
                }
                
                const q = query(collection(this.db, "users"), where("username_lowercase", "==", username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    throw new Error('æ­¤ç”¨æˆ¶åç¨±å·²è¢«ä½¿ç”¨ã€‚');
                }
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(this.auth, `${username.toLowerCase()}@schedule-app.com`, password);
                    const user = userCredential.user;
                    await setDoc(doc(this.db, "users", user.uid), {
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        role: role
                    });
                } catch (error) {
                    console.error("Register error:", error);
                    throw new Error("è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
            }

            async login(username, password) {
                try {
                    await signInWithEmailAndPassword(this.auth, `${username.trim().toLowerCase()}@schedule-app.com`, password);
                } catch (error) {
                    console.error("Login error:", error);
                    throw new Error("ç”¨æˆ¶åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚");
                }
            }

            async logout() {
                await signOut(this.auth);
            }

            async changePassword(newPassword, confirmNewPassword) {
                if (newPassword.length < 6) {
                    throw new Error('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½æ•¸ã€‚');
                }
                if (newPassword !== confirmNewPassword) {
                    throw new Error('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ã€‚');
                }

                try {
                    await updatePassword(this.currentUser, newPassword);
                } catch (error) {
                    console.error("Password change error:", error);
                    throw new Error('å¯†ç¢¼æ›´æ–°å¤±æ•—ã€‚é€™å¯èƒ½æ˜¯å› ç‚ºæ‚¨ç™»å…¥æ™‚é–“éä¹…ï¼Œè«‹å…ˆç™»å‡ºå†é‡æ–°ç™»å…¥ä¸€æ¬¡å¾Œå†è©¦ã€‚');
                }
            }

            async changeUsername(newUsername) {
                if (!newUsername) {
                    throw new Error('å§“åä¸èƒ½ç‚ºç©ºã€‚');
                }
                if (newUsername === this.currentUserData.username) {
                    throw new Error('æ–°èˆŠåç¨±ç›¸åŒã€‚');
                }

                const q = query(collection(this.db, "users"), where("username_lowercase", "==", newUsername.toLowerCase()));
                const querySnapshot = await getDocs(q);
                
                let isTaken = false;
                querySnapshot.forEach(doc => {
                    if (doc.id !== this.currentUser.uid) {
                        isTaken = true;
                    }
                });

                if (isTaken) {
                    throw new Error('æ­¤åç¨±å·²è¢«å…¶ä»–ä½¿ç”¨è€…å ç”¨ã€‚');
                }

                try {
                    const userDocRef = doc(this.db, "users", this.currentUser.uid);
                    await setDoc(userDocRef, {
                        username: newUsername,
                        username_lowercase: newUsername.toLowerCase()
                    }, { merge: true });
                } catch (error) {
                    console.error("Username change error:", error);
                    throw new Error('åç¨±æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            }

            async getUserData(user) {
                if (!user) return null;
                
                const userDocRef = doc(this.db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    return { uid: user.uid, ...userDocSnap.data() };
                }
                return null;
            }

            setCurrentUser(user) {
                this.currentUser = user;
            }

            setCurrentUserData(userData) {
                this.currentUserData = userData;
            }

            getCurrentUser() {
                return this.currentUser;
            }

            getCurrentUserData() {
                return this.currentUserData;
            }
        }

        // ===================================================================================
        // === æœˆæ›†ç®¡ç†é¡åˆ¥ (CalendarManager) ===
        // ===================================================================================
        class CalendarManager {
            constructor() {
                this.calendarDate = new Date();
                this.holidaysCache = {};
            }

            async fetchHolidays(year) {
                // 1. å…ˆæª¢æŸ¥è¨˜æ†¶é«”å¿«å–
                if (this.holidaysCache[year]) {
                    return this.holidaysCache[year];
                }

                // === å„ªåŒ– 2.3: æª¢æŸ¥æœ¬åœ°å¿«å– ===
                const cacheKey = `holidays_${year}`;
                const cachedData = localCache.get(cacheKey);
                if (cachedData) {
                    console.log(`ğŸ“… å¾æœ¬åœ°å¿«å–è¼‰å…¥ ${year} å¹´å‡æ—¥è³‡æ–™`);
                    const holidaysMap = new Map(cachedData);
                    this.holidaysCache[year] = holidaysMap;
                    return holidaysMap;
                }

                // å°ç£åœ‹å®šå‡æ—¥å‚™ç”¨è³‡æ–™
                const fallbackHolidays = {
                    2024: new Map([
                        ['2024-01-01', 'ä¸­è¯æ°‘åœ‹é–‹åœ‹ç´€å¿µæ—¥'], ['2024-02-08', 'è¾²æ›†é™¤å¤•'], ['2024-02-09', 'è¾²æ›†æ˜¥ç¯€'],
                        ['2024-02-10', 'è¾²æ›†æ˜¥ç¯€'], ['2024-02-11', 'è¾²æ›†æ˜¥ç¯€'], ['2024-02-12', 'è¾²æ›†æ˜¥ç¯€'],
                        ['2024-02-13', 'è¾²æ›†æ˜¥ç¯€'], ['2024-02-14', 'è¾²æ›†æ˜¥ç¯€'], ['2024-02-28', 'å’Œå¹³ç´€å¿µæ—¥'],
                        ['2024-04-04', 'å…’ç«¥ç¯€'], ['2024-04-05', 'æ¸…æ˜ç¯€'], ['2024-05-01', 'å‹å‹•ç¯€'],
                        ['2024-06-10', 'ç«¯åˆç¯€'], ['2024-09-17', 'ä¸­ç§‹ç¯€'], ['2024-10-10', 'åœ‹æ…¶æ—¥']
                    ]),
                    2025: new Map([
                        ['2025-01-01', 'ä¸­è¯æ°‘åœ‹é–‹åœ‹ç´€å¿µæ—¥'], ['2025-01-28', 'è¾²æ›†é™¤å¤•'], ['2025-01-29', 'è¾²æ›†æ˜¥ç¯€'],
                        ['2025-01-30', 'è¾²æ›†æ˜¥ç¯€'], ['2025-01-31', 'è¾²æ›†æ˜¥ç¯€'], ['2025-02-28', 'å’Œå¹³ç´€å¿µæ—¥'],
                        ['2025-04-04', 'å…’ç«¥ç¯€'], ['2025-04-05', 'æ¸…æ˜ç¯€'], ['2025-05-01', 'å‹å‹•ç¯€'],
                        ['2025-05-31', 'ç«¯åˆç¯€'], ['2025-10-06', 'ä¸­ç§‹ç¯€'], ['2025-10-10', 'åœ‹æ…¶æ—¥'],['2025-10-24', 'å…‰å¾©ç¯€è£œå‡'],['2025-12-25', 'è¡Œæ†²ç´€å¿µæ—¥']
                    ]),
                    2026: new Map([
                        ['2026-01-01', 'ä¸­è¯æ°‘åœ‹é–‹åœ‹ç´€å¿µæ—¥'], ['2026-02-28', 'å’Œå¹³ç´€å¿µæ—¥'],
                        ['2026-04-04', 'å…’ç«¥ç¯€'], ['2026-04-05', 'æ¸…æ˜ç¯€'], ['2026-05-01', 'å‹å‹•ç¯€'],
                        ['2026-05-20', 'ç«¯åˆç¯€'], ['2026-09-25', 'ä¸­ç§‹ç¯€'], ['2026-10-10', 'åœ‹æ…¶æ—¥']
                    ])
                };

                // === å„ªåŒ– 2.2: ä¸¦è¡Œè«‹æ±‚å¤šå€‹ API ä¾†æº ===
                const apiUrls = [
                    `https://cdn.jsdelivr.net/gh/g0v/tw-holiday@master/data/${year}.json`,
                    `https://raw.githubusercontent.com/g0v/tw-holiday/master/data/${year}.json`
                ];

                // å‰µå»ºå¸¶è¶…æ™‚çš„ fetch è«‹æ±‚
                const fetchWithTimeout = (url, timeout = 5000) => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);
                    
                    return fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: controller.signal
                    }).then(response => {
                        clearTimeout(timeoutId);
                        return response;
                    }).catch(err => {
                        clearTimeout(timeoutId);
                        throw err;
                    });
                };

                // è™•ç† API å›æ‡‰
                const processResponse = async (response) => {
                    if (!response.ok) throw new Error('Response not ok');
                    const data = await response.json();
                    const holidaysMap = new Map();
                    
                    // è™•ç†ä¸åŒAPIæ ¼å¼
                    const holidaysArray = data.holidays || (Array.isArray(data) ? data : []);
                    holidaysArray.forEach(holiday => {
                        if (holiday.isHoliday) { 
                           holidaysMap.set(holiday.date, holiday.name);
                        }
                    });
                    
                    if (holidaysMap.size === 0) throw new Error('No holidays found');
                    return holidaysMap;
                };

                try {
                    console.log(`ğŸŒ ä¸¦è¡Œè«‹æ±‚ ${year} å¹´å‡æ—¥è³‡æ–™...`);
                    
                    // === å„ªåŒ– 2.2: ä½¿ç”¨ Promise.any ä¸¦è¡Œè«‹æ±‚ï¼Œå–æœ€å¿«æˆåŠŸçš„ ===
                    const fetchPromises = apiUrls.map(url => 
                        fetchWithTimeout(url, 5000).then(processResponse)
                    );
                    
                    // Promise.any - åªè¦æœ‰ä¸€å€‹æˆåŠŸå°±è¿”å›
                    const holidaysMap = await Promise.any(fetchPromises);
                    
                    console.log(`âœ… æˆåŠŸç²å– ${year} å¹´å‡æ—¥è³‡æ–™ï¼Œå…± ${holidaysMap.size} å€‹å‡æ—¥`);
                    
                    // å­˜å…¥è¨˜æ†¶é«”å¿«å–
                    this.holidaysCache[year] = holidaysMap;
                    
                    // === å„ªåŒ– 2.3: å­˜å…¥æœ¬åœ°å¿«å– (7å¤©éæœŸ) ===
                    localCache.set(cacheKey, Array.from(holidaysMap.entries()), 60 * 24 * 7);
                    
                    return holidaysMap;
                    
                } catch (error) {
                    console.warn(`âš ï¸ æ‰€æœ‰ API è«‹æ±‚å¤±æ•—:`, error.message);
                }

                // å¦‚æœæ‰€æœ‰APIéƒ½å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨è³‡æ–™
                if (fallbackHolidays[year]) {
                    console.warn(`ğŸ“‹ ä½¿ç”¨ ${year} å¹´çš„å…§å»ºå‚™ç”¨è³‡æ–™`);
                    this.holidaysCache[year] = fallbackHolidays[year];
                    // å‚™ç”¨è³‡æ–™ä¹Ÿå­˜å…¥å¿«å– (1å¤©éæœŸï¼Œä»¥ä¾¿æ˜å¤©é‡è©¦)
                    localCache.set(cacheKey, Array.from(fallbackHolidays[year].entries()), 60 * 24);
                    return this.holidaysCache[year];
                } else {
                    console.warn(`âŒ æ²’æœ‰ ${year} å¹´çš„å‚™ç”¨å‡æ—¥è³‡æ–™ï¼Œè¿”å›ç©ºè³‡æ–™`);
                    this.holidaysCache[year] = new Map();
                    return this.holidaysCache[year];
                }
            }

            getCalendarDate() {
                return this.calendarDate;
            }

            setCalendarDate(date) {
                this.calendarDate = date;
            }

            getMonth() {
                return this.calendarDate.getMonth();
            }

            getYear() {
                return this.calendarDate.getFullYear();
            }

            previousMonth() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() - 1);
            }

            nextMonth() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() + 1);
            }
        }

        // ===================================================================================
        // === æ’ç­ç®¡ç†é¡åˆ¥ (ScheduleManager) ===
        // ===================================================================================
        class ScheduleManager {
            constructor(db) {
                this.db = db;
                this.allData = {};
                this.allUsers = [];
                this.unsubscribeListeners = [];
                this.onDataChangeCallback = null;
                
                // === å„ªåŒ– 2.5: å¾æœ¬åœ°å¿«å–é å…ˆè¼‰å…¥è³‡æ–™ ===
                this._loadFromLocalCache();
            }
            
            // å¾æœ¬åœ°å¿«å–è¼‰å…¥è³‡æ–™ï¼ˆç”¨æ–¼é¦–æ¬¡æ¸²æŸ“å‰çš„å¿«é€Ÿé¡¯ç¤ºï¼‰
            _loadFromLocalCache() {
                const cachedData = localCache.get('scheduleData');
                const cachedUsers = localCache.get('usersList');
                
                if (cachedData) {
                    this.allData = cachedData;
                    console.log('ğŸ“¦ å¾æœ¬åœ°å¿«å–è¼‰å…¥æ’ç­è³‡æ–™');
                }
                if (cachedUsers) {
                    this.allUsers = cachedUsers;
                    console.log('ğŸ‘¥ å¾æœ¬åœ°å¿«å–è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨');
                }
            }
            
            // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°å¿«å–
            _saveToLocalCache() {
                // æ’ç­è³‡æ–™å¿«å– 30 åˆ†é˜
                localCache.set('scheduleData', this.allData, 30);
                // ç”¨æˆ¶åˆ—è¡¨å¿«å– 60 åˆ†é˜
                localCache.set('usersList', this.allUsers, 60);
            }

            setOnDataChangeCallback(callback) {
                this.onDataChangeCallback = callback;
            }

            setupRealtimeListeners() {
                const dataDocRef = doc(this.db, "scheduleData", "main");

                const unsubData = onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.allData = docSnap.data();
                        // === å„ªåŒ– 2.5: æ›´æ–°æœ¬åœ°å¿«å– ===
                        this._saveToLocalCache();
                    } else {
                        // Initialize data if it doesn't exist
                        setDoc(doc(this.db, "scheduleData", "main"), {
                            userVacations: {},
                            userAvailability: {},
                            coverSignups: {},
                            adminHolidays: [],
                            manualAssignments: {},
                            outsideSchedule: {}
                        });
                    }
                    // è§¸ç™¼é‡æ–°æ¸²æŸ“
                    if (this.onDataChangeCallback) {
                        this.onDataChangeCallback();
                    }
                });

                const unsubUsers = onSnapshot(query(collection(this.db, "users")), (snapshot) => {
                    this.allUsers = [];
                    snapshot.forEach(doc => this.allUsers.push({ id: doc.id, ...doc.data() }));
                    // === å„ªåŒ– 2.5: æ›´æ–°æœ¬åœ°å¿«å– ===
                    this._saveToLocalCache();
                    // è§¸ç™¼é‡æ–°æ¸²æŸ“
                    if (this.onDataChangeCallback) {
                        this.onDataChangeCallback();
                    }
                });
                
                this.unsubscribeListeners.push(unsubData, unsubUsers);
            }

            cleanupListeners() {
                this.unsubscribeListeners.forEach(unsub => unsub());
                this.unsubscribeListeners = [];
            }

            getAllData() {
                return this.allData;
            }

            getAllUsers() {
                return this.allUsers;
            }

            async updateUserVacation(userId, year, month, vacations) {
                const vacationKey = `${userId}-${year}-${month}`;
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userVacations: { ...this.allData.userVacations, [vacationKey]: vacations } 
                }, { merge: true });
            }

            async updateUserAvailability(userId, year, month, availability) {
                const availabilityKey = `${userId}-${year}-${month}`;
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userAvailability: { ...this.allData.userAvailability, [availabilityKey]: availability } 
                }, { merge: true });
            }

            async updateUserVacationTime(userId, year, month, date, vacationData) {
                // month å¯èƒ½å¸¶æœ‰å‰å° 0ï¼Œçµ±ä¸€è½‰ç‚ºæ•¸å­—ï¼Œé¿å… key ä¸ä¸€è‡´
                const numericMonth = parseInt(month, 10);
                const normalizedKey = `${userId}-${year}-${numericMonth}`;
                const legacyKey = `${userId}-${year}-${String(numericMonth).padStart(2, '0')}`;
                const currentVacationTimes = this.allData.userVacationTimes || {};

                // åˆä½µèˆŠçš„å‰å° 0 key èˆ‡æ–°çš„æ¨™æº– keyï¼Œé¿å…èˆŠè³‡æ–™éºå¤±
                const legacyData = currentVacationTimes[legacyKey] || {};
                const normalizedData = currentVacationTimes[normalizedKey] || {};
                const userVacationTimes = { ...legacyData, ...normalizedData };
                
                // ============================================================
                // === [ä¿®å¾© BUG] æ ¸å¿ƒä¿®æ”¹ä½ç½® ===
                // ============================================================
                // èˆŠå¯«æ³•ï¼šdelete userVacationTimes[date]; 
                // å•é¡Œï¼šdelete ä¹‹å¾Œï¼Œfirebase merge æœƒå¿½ç•¥é€™å€‹æ¬„ä½ï¼Œå°è‡´è³‡æ–™åº«èˆŠçš„ true æ²’è¢«æ´—æ‰ã€‚
                
                // æ–°å¯«æ³•ï¼šä¸ç®¡æ˜¯ä¸æ˜¯ falseï¼Œéƒ½ç›´æ¥å¯«å…¥ã€‚
                // é€™æ¨£è³‡æ–™åº«æ‰æœƒæ˜ç¢ºæ”¶åˆ° { morning: false, evening: false } çš„æŒ‡ä»¤ï¼Œå»è¦†è“‹åŸæœ¬çš„ trueã€‚
                userVacationTimes[date] = vacationData;
                
                // ============================================================
                
                // æº–å‚™è¦æ›´æ–°åˆ°è³‡æ–™åº«çš„å¤§ç‰©ä»¶
                const updatedVacationTimes = { ...currentVacationTimes };
                updatedVacationTimes[normalizedKey] = userVacationTimes;
                
                // å¦‚æœ legacyKey å­˜åœ¨ä¸”èˆ‡ normalizedKey ä¸åŒï¼Œä¹Ÿè¦åŒæ­¥æ›´æ–°å®ƒ
                // é€™æ˜¯ç‚ºäº†ä¿æŒè³‡æ–™ä¸€è‡´æ€§ï¼Œé¿å…èˆŠç‰ˆç¨‹å¼è®€å–éŒ¯èª¤
                if (legacyKey !== normalizedKey && currentVacationTimes[legacyKey]) {
                    const updatedLegacyData = { ...currentVacationTimes[legacyKey] };
                    updatedLegacyData[date] = vacationData; // åŒæ¨£å¼·åˆ¶å¯«å…¥ false
                    updatedVacationTimes[legacyKey] = updatedLegacyData;
                }
                
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userVacationTimes: updatedVacationTimes
                }, { merge: true });
                
                // ç«‹å³æ›´æ–°æœ¬åœ°æ•¸æ“šï¼Œç¢ºä¿æœˆæ›†èƒ½ç«‹å³åæ˜ è®Šæ›´
                this.allData.userVacationTimes = updatedVacationTimes;
            }

            async updateAdminHolidays(holidays) {
                await setDoc(doc(this.db, "scheduleData", "main"), { adminHolidays: holidays }, { merge: true });
            }

            async updateCoverSignups(signups) {
                try {
                    // ç²å–ç•¶å‰æ‰€æœ‰è³‡æ–™
                    const currentData = this.allData;
                    // æ›´æ–° coverSignups ä¸¦ä¿æŒå…¶ä»–è³‡æ–™ä¸è®Š
                    const updatedData = { ...currentData, coverSignups: signups };
                    
                    console.log('æ›´æ–°ä»£ç­è³‡æ–™åˆ°è³‡æ–™åº«:', updatedData.coverSignups);
                    
                    await setDoc(doc(this.db, "scheduleData", "main"), updatedData);
                    
                    console.log('ä»£ç­è³‡æ–™æ›´æ–°æˆåŠŸ');
                } catch (error) {
                    console.error('æ›´æ–°ä»£ç­è³‡æ–™å¤±æ•—:', error);
                    throw error;
                }
            }

            async updateManualAssignments(assignments) {
                await setDoc(doc(this.db, "scheduleData", "main"), { manualAssignments: assignments }, { merge: true });
            }

            async updateOutsideSchedule(schedule) {
                await setDoc(doc(this.db, "scheduleData", "main"), { outsideSchedule: schedule }, { merge: true });
            }

            async updateMultiple(fields) {
                // === å„ªåŒ– 2.4: ä½¿ç”¨ writeBatch æ‰¹é‡å¯«å…¥ ===
                // ä½¿ç”¨ merge:true åŒæ­¥æ›´æ–°å¤šå€‹æ¬„ä½ï¼Œé¿å…è³‡æ–™å½¼æ­¤è¦†è“‹
                console.log('updateMultiple è¢«å‘¼å«ï¼Œæº–å‚™æ›´æ–°æ¬„ä½:', Object.keys(fields));
                try {
                    const batch = writeBatch(this.db);
                    const docRef = doc(this.db, "scheduleData", "main");
                    batch.set(docRef, fields, { merge: true });
                    await batch.commit();
                    console.log('updateMultiple æ‰¹é‡æ›´æ–°æˆåŠŸ');
                } catch (error) {
                    console.error('updateMultiple æ›´æ–°å¤±æ•—:', error);
                    throw error;
                }
            }

            async deleteUser(userId) {
                // === å„ªåŒ– 2.4: ä½¿ç”¨ writeBatch æ‰¹é‡å¯«å…¥ ===
                try {
                    console.log('é–‹å§‹åˆªé™¤ç”¨æˆ¶:', userId);
                    
                    const batch = writeBatch(this.db);
                    
                    // 1. åˆªé™¤ç”¨æˆ¶æ–‡æª”
                    batch.delete(doc(this.db, "users", userId));
                    
                    // 2. æ¸…ç†æ‰€æœ‰ç›¸é—œæ•¸æ“š
                    const currentData = this.allData;
                    const updatedData = deepClone(currentData); // ä½¿ç”¨å„ªåŒ–çš„æ·±æ‹·è²
                    
                    // æ¸…ç† userVacations
                    const userVacationKeys = Object.keys(updatedData.userVacations || {}).filter(key => key.startsWith(`${userId}-`));
                    userVacationKeys.forEach(key => {
                        delete updatedData.userVacations[key];
                    });
                    
                    // æ¸…ç† userAvailability
                    const userAvailabilityKeys = Object.keys(updatedData.userAvailability || {}).filter(key => key.startsWith(`${userId}-`));
                    userAvailabilityKeys.forEach(key => {
                        delete updatedData.userAvailability[key];
                    });
                    
                    // æ¸…ç† coverSignups ä¸­è©²ç”¨æˆ¶çš„ä»£ç­è¨˜éŒ„
                    const updatedCoverSignups = { ...updatedData.coverSignups };
                    Object.keys(updatedCoverSignups).forEach(key => {
                        if (updatedCoverSignups[key] === userId) {
                            delete updatedCoverSignups[key];
                        }
                    });
                    updatedData.coverSignups = updatedCoverSignups;
                    
                    // æ¸…ç† manualAssignments ä¸­è©²ç”¨æˆ¶çš„æ’ç­è¨˜éŒ„
                    const updatedManualAssignments = { ...updatedData.manualAssignments };
                    Object.keys(updatedManualAssignments).forEach(dateKey => {
                        if (Array.isArray(updatedManualAssignments[dateKey])) {
                            updatedManualAssignments[dateKey] = updatedManualAssignments[dateKey].filter(assignment => assignment.userId !== userId);
                        }
                    });
                    updatedData.manualAssignments = updatedManualAssignments;
                    
                    // æ¸…ç† outsideSchedule ä¸­è©²ç”¨æˆ¶çš„æ’ç­è¨˜éŒ„
                    const updatedOutsideSchedule = { ...updatedData.outsideSchedule };
                    Object.keys(updatedOutsideSchedule).forEach(dateKey => {
                        if (Array.isArray(updatedOutsideSchedule[dateKey])) {
                            updatedOutsideSchedule[dateKey] = updatedOutsideSchedule[dateKey].filter(shift => shift.userId !== userId);
                        }
                    });
                    updatedData.outsideSchedule = updatedOutsideSchedule;
                    
                    // 3. æ‰¹é‡æ›´æ–°æ•¸æ“šåº«
                    batch.set(doc(this.db, "scheduleData", "main"), updatedData);
                    
                    // 4. åŸ·è¡Œæ‰¹é‡æ“ä½œ (åŸå­æ€§ï¼šå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±æ•—)
                    await batch.commit();
                    console.log('âœ… ç”¨æˆ¶åŠç›¸é—œæ•¸æ“šå·²æ‰¹é‡åˆªé™¤å®Œæˆ');
                    
                } catch (error) {
                    console.error('åˆªé™¤ç”¨æˆ¶å¤±æ•—:', error);
                    throw error;
                }
            }
        }

        // ===================================================================================
        // === UIç®¡ç†é¡åˆ¥ (UIManager) ===
        // ===================================================================================
        class UIManager {
            constructor() {
                this.initializeElements();
            }

            initializeElements() {
                // Auth elements
                this.authContainer = document.getElementById('auth-container');
                this.appContainer = document.getElementById('app');
                this.loginView = document.getElementById('login-view');
                this.registerView = document.getElementById('register-view');
                this.loginForm = document.getElementById('login-form');
                this.registerForm = document.getElementById('register-form');
                this.authError = document.getElementById('auth-error');
                this.showRegisterBtn = document.getElementById('show-register');
                this.showLoginBtn = document.getElementById('show-login');
                this.logoutBtn = document.getElementById('logout-btn');
                this.userNameSpan = document.getElementById('userName');
                this.userRoleSpan = document.getElementById('userRole');
                this.appSubtitle = document.getElementById('app-subtitle');
                this.calendarView = document.getElementById('calendar-view');
                this.settingsBtn = document.getElementById('settings-btn');
                this.settingsModal = document.getElementById('settings-modal');
                this.closeSettingsBtn = document.getElementById('close-settings-btn');
                this.changePasswordForm = document.getElementById('change-password-form');
                this.changeUsernameForm = document.getElementById('change-username-form');
                this.passwordSettingsError = document.getElementById('password-settings-error');
                this.usernameSettingsError = document.getElementById('username-settings-error');

                // ç­æ¬¡é¸æ“‡ Modal
                this.shiftSelectModal = document.getElementById('shift-select-modal');
                this.closeShiftSelectBtn = document.getElementById('close-shift-select-btn');
                this.shiftSelectInfo = document.getElementById('shift-select-info');
                this.shiftSelectOptions = document.getElementById('shift-select-options');
                
                // ä»£ç­äººé¸æ“‡ Modal
                this.coverShiftModal = document.getElementById('cover-shift-modal');
                this.closeCoverShiftBtn = document.getElementById('close-cover-shift-btn');
                this.coverShiftForm = document.getElementById('cover-shift-form');
                this.coverShiftInfo = document.getElementById('cover-shift-info');
                this.coverShiftSelect = document.getElementById('cover-shift-replacement-select');
                
                // ä¼‘å‡æ™‚é–“é¸æ“‡ Modal
                this.vacationTimeModal = document.getElementById('vacation-time-modal');
                this.closeVacationTimeBtn = document.getElementById('close-vacation-time-btn');
                this.confirmVacationTimeBtn = document.getElementById('confirm-vacation-time-btn');
                this.cancelVacationTimeBtn = document.getElementById('cancel-vacation-time-btn');
                this.vacationTimeInfo = document.getElementById('vacation-time-info');
                this.vacationMorningCheckbox = document.getElementById('vacation-morning');
                this.vacationEveningCheckbox = document.getElementById('vacation-evening');
                
                // åˆªé™¤ç”¨æˆ¶ Modal
                this.deleteUserModal = document.getElementById('delete-user-modal');
                this.closeDeleteUserBtn = document.getElementById('close-delete-user-btn');
                this.confirmDeleteUserBtn = document.getElementById('confirm-delete-user-btn');
                this.cancelDeleteUserBtn = document.getElementById('cancel-delete-user-btn');
                this.deleteUserInfo = document.getElementById('delete-user-info');
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.remove('translate-y-20', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            showAuthView() {
                this.authContainer.classList.remove('hidden');
                this.appContainer.classList.add('hidden');
            }

            showAppView() {
                this.authContainer.classList.add('hidden');
                this.appContainer.classList.remove('hidden');
            }

            showLoginForm() {
                this.loginView.classList.remove('hidden');
                this.registerView.classList.add('hidden');
                this.authError.textContent = '';
            }

            showRegisterForm() {
                this.registerView.classList.remove('hidden');
                this.loginView.classList.add('hidden');
                this.authError.textContent = '';
            }

            showSettingsModal() {
                this.settingsModal.classList.remove('hidden');
                this.passwordSettingsError.textContent = '';
                this.usernameSettingsError.textContent = '';
                this.changePasswordForm.reset();
            }

            hideSettingsModal() {
                this.settingsModal.classList.add('hidden');
            }

            // é¡¯ç¤ºç­æ¬¡é¸æ“‡ Modal
            showShiftSelectModal(date, shifts) {
                this.shiftSelectInfo.textContent = `æ‚¨åœ¨ ${date} æœ‰ ${shifts.length} å€‹ç­æ¬¡ï¼Œè«‹é¸æ“‡è¦æ‰¾äººä»£ç­çš„ç­æ¬¡ï¼š`;
                this.shiftSelectOptions.innerHTML = ''; // æ¸…ç©ºèˆŠæŒ‰éˆ•

                shifts.forEach(shiftData => {
                    const button = document.createElement('button');
                    button.className = "w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700";
                    button.textContent = `ç­æ¬¡: (${shiftData.shift})`;
                    // å°‡è³‡æ–™å­˜åœ¨æŒ‰éˆ•ä¸Šï¼Œä»¥ä¾¿äº‹ä»¶ç›£è½å™¨æŠ“å–
                    button.dataset.date = date;
                    button.dataset.shift = shiftData.shift;
                    button.classList.add('shift-select-btn'); // åŠ ä¸Š class ä¾›äº‹ä»¶å§”æ´¾ä½¿ç”¨
                    this.shiftSelectOptions.appendChild(button);
                });

                this.shiftSelectModal.classList.remove('hidden');
            }

            // éš±è—ç­æ¬¡é¸æ“‡ Modal
            hideShiftSelectModal() {
                this.shiftSelectModal.classList.add('hidden');
                this.shiftSelectOptions.innerHTML = ''; // æ¸…ç©ºæŒ‰éˆ•
            }

            // é¡¯ç¤ºä»£ç­äººé¸æ“‡ Modal
            showCoverShiftModal(date, shift, replacementOptions) {
                // å„²å­˜è³‡è¨Šï¼Œä»¥ä¾¿è¡¨å–®æäº¤æ™‚ä½¿ç”¨
                this.coverShiftForm.dataset.date = date;
                this.coverShiftForm.dataset.shift = shift;

                // é¡¯ç¤ºç­æ¬¡è³‡è¨Š
                this.coverShiftInfo.textContent = `æ‚¨åœ¨ ${date} çš„ (${shift}) ç­ï¼Œè¦æ‰¾èª°ä»£ç­ï¼Ÿ`;

                // æ¸…ç©ºä¸¦å¡«å……ä¸‹æ‹‰é¸å–®
                this.coverShiftSelect.innerHTML = '<option value="" disabled selected>é¸æ“‡ä¸€ä½å¤–å ´å·¥è®€ç”Ÿ</option>';
                replacementOptions.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    this.coverShiftSelect.appendChild(option);
                });

                this.coverShiftModal.classList.remove('hidden');
            }

            // éš±è—ä»£ç­äººé¸æ“‡ Modal
            hideCoverShiftModal() {
                this.coverShiftModal.classList.add('hidden');
                this.coverShiftForm.reset();
            }

            // é¡¯ç¤ºåˆªé™¤ç”¨æˆ¶ Modal
            showDeleteUserModal(userInfo) {
                this.deleteUserInfo.textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${userInfo.username}ã€(${userInfo.role}) å—ï¼Ÿ`;
                this.deleteUserModal.classList.remove('hidden');
            }

            // éš±è—åˆªé™¤ç”¨æˆ¶ Modal
            hideDeleteUserModal() {
                this.deleteUserModal.classList.add('hidden');
            }

            // é¡¯ç¤ºä¼‘å‡æ™‚é–“é¸æ“‡ Modal
            showVacationTimeModal(date, currentVacationData = null) {
                this.vacationTimeInfo.textContent = `è«‹é¸æ“‡æ‚¨åœ¨ ${date} çš„ä¼‘å‡æ™‚é–“æ®µï¼š`;
                
                // è¨­ç½®é»˜èªå€¼ï¼ˆå…©å€‹éƒ½å‹¾é¸è¡¨ç¤ºå…¨å¤©ä¼‘å‡ï¼‰
                this.vacationMorningCheckbox.checked = true;
                this.vacationEveningCheckbox.checked = true;
                
                // å¦‚æœæœ‰ç¾æœ‰çš„ä¼‘å‡æ•¸æ“šï¼Œæ ¹æ“šæ•¸æ“šè¨­ç½®å‹¾é¸ç‹€æ…‹
                if (currentVacationData) {
                    this.vacationMorningCheckbox.checked = currentVacationData.morning || false;
                    this.vacationEveningCheckbox.checked = currentVacationData.evening || false;
                }
                
                this.vacationTimeModal.classList.remove('hidden');
            }

            // éš±è—ä¼‘å‡æ™‚é–“é¸æ“‡ Modal
            hideVacationTimeModal() {
                this.vacationTimeModal.classList.add('hidden');
            }

            updateUserInfo(username, role) {
                this.userNameSpan.textContent = username;
                this.userRoleSpan.textContent = role;
            }

            updateAppSubtitle(text) {
                this.appSubtitle.textContent = text;
            }

            toggleSettingsButton(show) {
                if (show) {
                    this.settingsBtn.classList.remove('hidden');
                } else {
                    this.settingsBtn.classList.add('hidden');
                }
            }

            showCalendarView() {
                this.calendarView.classList.remove('hidden');
            }

            hideCalendarView() {
                this.calendarView.classList.add('hidden');
            }

            setAuthError(message) {
                this.authError.textContent = message;
            }

            setPasswordError(message) {
                this.passwordSettingsError.textContent = message;
            }

            setUsernameError(message) {
                this.usernameSettingsError.textContent = message;
            }
        }

        // ===================================================================================
        // === ä¸»æ‡‰ç”¨ç¨‹å¼é¡åˆ¥ (ScheduleApp) ===
        // ===================================================================================
        class ScheduleApp {
            constructor() {
                this.initializeFirebase();
                this.initializeManagers();
                this.initializeConstants();
                this.setupEventListeners();
                this.setupAuthStateListener();
                this.setupAutoSchedule();
                this.pendingDeleteUser = null;
                this.pendingVacationDate = null;
                this.currentCalendarView = 'outside'; // åˆå§‹åŒ–æœˆæ›†è¦–åœ–é¡å‹ï¼Œé»˜èªé¡¯ç¤ºå¤–å ´æœˆæ›†
                this._dayClickInProgress = false; // é˜²æ­¢å¿«é€Ÿé‡è¤‡é»æ“Šçš„æ¨™è¨˜
                
                // === å„ªåŒ– 1.4: æœˆæ›†å¿«å–ç³»çµ± (Diff Rendering) ===
                this.calendarCache = {
                    inside: new Map(), // å…§å ´æœˆæ›†å¿«å–: dateString -> cellHTML
                    outside: new Map(), // å¤–å ´æœˆæ›†å¿«å–: dateString -> cellHTML
                    lastRenderedMonth: null, // ä¸Šæ¬¡æ¸²æŸ“çš„æœˆä»½
                    lastRenderedYear: null, // ä¸Šæ¬¡æ¸²æŸ“çš„å¹´ä»½
                    dataHash: null // è³‡æ–™é›œæ¹Šå€¼ï¼Œç”¨æ–¼æª¢æ¸¬è®Šæ›´
                };
                
                // === (NEW) Define shift options ===
                this.insideShifts = [
                    "å‚™èœç­ (æ—©)", "å‚™èœç­ (æ™š)", "å‚™èœç­ (å…¨æ—¥)",
                    "ç‚¸çˆç­ (æ—©)", "ç‚¸çˆç­ (æ™š)", "ç‚¸çˆç­ (å…¨æ—¥)",
                    "æ”¶ç­", // å†…å ´å·¥è®€ç”Ÿï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                    "æ”¶ç­ï¼ˆå…§å ´ï¼‰" // å†…å ´å·¥è®€ç”Ÿ
                ];
                this.outsideShifts = [
                    "æ—©æ«ƒ", "æ—©ç­", "æ™šæ«ƒ", "æ´—ç¢—", "æ”¶ç­", // å¤–å ´å·¥è®€ç”Ÿï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                    "æ”¶ç­ï¼ˆå¤–å ´ï¼‰", // å¤–å ´å·¥è®€ç”Ÿ
                    "æ«ƒæª¯" // å¤–å ´æ«ƒæª¯
                ];
            }
            
            // === å„ªåŒ– 1.4: è¨ˆç®—è³‡æ–™é›œæ¹Šå€¼ï¼Œå¿«é€Ÿæª¢æ¸¬è®Šæ›´ ===
            calculateDataHash(data) {
                // ç°¡å–®çš„é›œæ¹Šè¨ˆç®—ï¼Œç”¨æ–¼å¿«é€Ÿæ¯”è¼ƒè³‡æ–™æ˜¯å¦è®Šæ›´
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash;
            }
            
            // === å„ªåŒ– 1.4: æ¸…é™¤æœˆæ›†å¿«å– ===
            clearCalendarCache() {
                this.calendarCache.inside.clear();
                this.calendarCache.outside.clear();
                this.calendarCache.dataHash = null;
            }

            initializeFirebase() {
                // ===================================================================================
                // === é‡è¦ï¼šè«‹å°‡ä¸‹æ–¹çš„ firebaseConfig ç‰©ä»¶æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆè¨­å®š ===
                // ===================================================================================
                const firebaseConfig = {
                apiKey: "AIzaSyBEMnLL-ppl8-jQnA1RzZW8JfsUjCqEOFQ",
                authDomain: "schedule-hantaitai.firebaseapp.com",
                databaseURL: "https://schedule-hantaitai-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "schedule-hantaitai",
                storageBucket: "schedule-hantaitai.firebasestorage.app",
                messagingSenderId: "600535535784",
                appId: "1:600535535784:web:397ad1387e60f87479b29d"
                };
                // ===================================================================================

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                this.auth = getAuth(app);
                this.db = getFirestore(app);
                
                // === å•Ÿç”¨ Firestore é›¢ç·šæŒä¹…åŒ– (å„ªåŒ– 2.6) ===
                // é€™è®“è³‡æ–™åœ¨æœ¬åœ° IndexedDB å¿«å–ï¼Œå¤§å¹…æ¸›å°‘ç¶²è·¯è«‹æ±‚
                enableIndexedDbPersistence(this.db)
                    .then(() => {
                        console.log('âœ… Firestore é›¢ç·šæŒä¹…åŒ–å·²å•Ÿç”¨');
                    })
                    .catch((err) => {
                        if (err.code === 'failed-precondition') {
                            // å¤šå€‹åˆ†é åŒæ™‚é–‹å•Ÿæ™‚æœƒç™¼ç”Ÿ
                            console.warn('âš ï¸ é›¢ç·šæŒä¹…åŒ–å¤±æ•—ï¼šå¤šå€‹åˆ†é åŒæ™‚é–‹å•Ÿ');
                        } else if (err.code === 'unimplemented') {
                            // ç€è¦½å™¨ä¸æ”¯æ´
                            console.warn('âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´é›¢ç·šæŒä¹…åŒ–');
                        }
                    });
            }

            initializeManagers() {
                this.authManager = new AuthManager(this.auth, this.db);
                this.calendarManager = new CalendarManager();
                this.scheduleManager = new ScheduleManager(this.db);
                this.uiManager = new UIManager();
            }

            initializeConstants() {
                this.ADMIN_ROLE = "ç®¡ç†è€…";
                this.FULLTIME_ROLES = ["å†…å ´å‚™èœç­", "å†…å ´ç‚¸çˆç­"];
                this.PART_TIMER_ROLE = "å†…å ´å·¥è®€ç”Ÿ";
                this.OUTSIDE_ROLES = ["å¤–å ´å·¥è®€ç”Ÿ", "å¤–å ´æ«ƒæª¯"];
                this.INSIDE_ROLES = ["å†…å ´å·¥è®€ç”Ÿ", "å†…å ´å‚™èœç­", "å†…å ´ç‚¸çˆç­"];
            }

            setupAutoSchedule() {
                // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦è‡ªå‹•æ’ç­
                setInterval(() => {
                    this.checkAutoSchedule();
                }, 60000); // 60ç§’æª¢æŸ¥ä¸€æ¬¡
                
                // é é¢è¼‰å…¥æ™‚ä¹Ÿæª¢æŸ¥ä¸€æ¬¡
                this.checkAutoSchedule();
            }

            async checkAutoSchedule() {
                const now = new Date();
                const currentDay = now.getDate();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentMonth = now.getMonth() + 1;
                const currentYear = now.getFullYear();
                
                // æª¢æŸ¥æ˜¯å¦ç‚º25è™Ÿæ—©ä¸Š8é»ï¼ˆå…è¨±8:00-8:01ä¹‹é–“åŸ·è¡Œï¼‰
                if (currentDay === 25 && currentHour === 8 && currentMinute <= 1) {
                    const lastRunKey = `autoSchedule_25_${currentYear}_${currentMonth}`;
                    const lastRun = localStorage.getItem(lastRunKey);
                    const today = now.toDateString();
                    
                    if (lastRun !== today) {
                        localStorage.setItem(lastRunKey, today);
                        await this.autoScheduleNextMonth();
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚º10è™Ÿæ—©ä¸Š8é»ï¼ˆå…è¨±8:00-8:01ä¹‹é–“åŸ·è¡Œï¼‰
                if (currentDay === 10 && currentHour === 8 && currentMinute <= 1) {
                    const lastRunKey = `autoSchedule_10_${currentYear}_${currentMonth}`;
                    const lastRun = localStorage.getItem(lastRunKey);
                    const today = now.toDateString();
                    
                    if (lastRun !== today) {
                        localStorage.setItem(lastRunKey, today);
                        await this.autoScheduleCurrentMonthSecondHalf();
                    }
                }
            }

            async autoScheduleNextMonth() {
                try {
                    const now = new Date();
                    const nextMonth = now.getMonth() + 1 === 12 ? 0 : now.getMonth() + 1;
                    const nextYear = now.getMonth() + 1 === 12 ? now.getFullYear() + 1 : now.getFullYear();
                    
                    console.log(`è‡ªå‹•æ’ç­ï¼š${nextYear}å¹´${nextMonth + 1}æœˆ1-15è™Ÿ`);
                    await this.generateOutsideScheduleAuto(nextYear, nextMonth + 1, 1, 15);
                    
                    // ç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    if (this.uiManager) {
                        this.uiManager.showToast(`å·²è‡ªå‹•æ’ä¸‹å€‹æœˆ1-15è™Ÿçš„ç­è¡¨`);
                    }
                } catch (error) {
                    console.error('è‡ªå‹•æ’ç­å¤±æ•—:', error);
                }
            }

            async autoScheduleCurrentMonthSecondHalf() {
                try {
                    const now = new Date();
                    const currentMonth = now.getMonth() + 1;
                    const currentYear = now.getFullYear();
                    
                    console.log(`è‡ªå‹•æ’ç­ï¼š${currentYear}å¹´${currentMonth}æœˆ16-31è™Ÿ`);
                    await this.generateOutsideScheduleAuto(currentYear, currentMonth, 16);
                    
                    // ç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    if (this.uiManager) {
                        this.uiManager.showToast(`å·²è‡ªå‹•æ’æœ¬æœˆ16-31è™Ÿçš„ç­è¡¨`);
                    }
                } catch (error) {
                    console.error('è‡ªå‹•æ’ç­å¤±æ•—:', error);
                }
            }

            // çµ±ä¸€çš„æ’ç­é‚è¼¯æ ¸å¿ƒå‡½æ•¸
            generateDaySchedule(dateString, dayOfWeek, counterVacation, availableWorkers, workerUnavailability, workerVacationTimes, workerWorkDays) {
                const daySchedule = [];
                
                if (counterVacation) {
                    // æ«ƒæª¯ä¼‘å‡ï¼šå¹³æ—¥ä¸æ’ã€Œæ—©ç­ã€ï¼Œå‡æ—¥ç¶­æŒå«ã€Œæ—©ç­ã€
                    const dayAvailableWorkers = availableWorkers.filter(worker => 
                        !workerUnavailability[worker.username].includes(dateString)
                    );
                    
                    if (dayAvailableWorkers.length > 0) {
                        // å¹³æ—¥ï¼ˆé€±ä¸€è‡³é€±äº”ï¼‰ï¼šæ—©æ«ƒã€æ™šæ«ƒã€æ´—ç¢—ã€æ”¶ç­ï¼›å‡æ—¥ï¼šå«æ—©ç­å…±äº”ç­
                        const shifts = (dayOfWeek >= 1 && dayOfWeek <= 5)
                            ? ["æ—©æ«ƒ", "æ™šæ«ƒ", "æ´—ç¢—", "æ”¶ç­"]
                            : ["æ—©æ«ƒ", "æ—©ç­", "æ™šæ«ƒ", "æ´—ç¢—", "æ”¶ç­"];
                        
                        // å¹³å‡åˆ†é…ç­åˆ¥çµ¦å¯ç”¨çš„å·¥è®€ç”Ÿ
                        const sortedWorkers = dayAvailableWorkers.sort((a, b) => 
                            workerWorkDays[a.username] - workerWorkDays[b.username]
                        );
                        // æ‰“äº‚ç­åˆ¥ä»¥éš¨æ©Ÿåˆ†é…
                        const shuffledShifts = [...shifts].sort(() => Math.random() - 0.5);
                        
                        // åˆ†é…é‚è¼¯ï¼š
                        // 1. å„ªå…ˆæŠŠç­åˆ¥åˆ†é…çµ¦ä¸åŒçš„äºº
                        // 2. å¦‚æœäººæ•¸ä¸è¶³ï¼Œå…è¨±åŒä¸€å€‹äººä¸Šå¤šå€‹ç­ï¼Œä½†è¦æª¢æŸ¥è¡çª
                        let workerIndex = 0;
                        for (const shift of shuffledShifts) {
                            let assigned = false;
                            let attempt = 0;
                            
                            // å˜—è©¦åˆ†é…çµ¦ä¸‹ä¸€å€‹å·¥äººï¼Œæœ€å¤šç¹ä¸€åœˆ
                            while (!assigned && attempt < sortedWorkers.length) {
                                const worker = sortedWorkers[workerIndex % sortedWorkers.length];
                                
                                let hasConflict = false;
                                const morningGroup = ["æ—©æ«ƒ", "æ—©ç­"];
                                const eveningGroup = ["æ™šæ«ƒ", "æ´—ç¢—", "æ”¶ç­"];

                                // Check for conflicts
                                for (const existing of daySchedule) {
                                    if (existing.username === worker.username) {
                                        // Rule 1: "æ—©æ«ƒ" and "æ—©ç­" cannot be the same person
                                        if (morningGroup.includes(shift) && morningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                        
                                        // Rule 2: "æ™šæ«ƒ", "æ´—ç¢—", and "æ”¶ç­" cannot be the same person
                                        if (eveningGroup.includes(shift) && eveningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                    }
                                }
                                
                                // æª¢æŸ¥å·¥äººæ˜¯å¦å¯ä»¥åœ¨é€™å€‹ç­æ¬¡å·¥ä½œï¼ˆè€ƒæ…®åˆ†æ™‚æ®µä¼‘å‡ï¼‰
                                if (!hasConflict && this.isWorkerAvailableForShift(worker, dateString, shift, workerVacationTimes)) {
                                    daySchedule.push({
                                        username: worker.username,
                                        role: "å¤–å ´å·¥è®€ç”Ÿ",
                                        shift: shift
                                    });
                                    workerWorkDays[worker.username]++;
                                    assigned = true;
                                }
                                
                                workerIndex++;
                                attempt++;
                            }
                        }
                    }
                } else {
                    // æ­£å¸¸æ’ç­
                    const dayAvailableWorkers = availableWorkers.filter(worker => 
                        !workerUnavailability[worker.username].includes(dateString)
                    );
                    
                    if (dayAvailableWorkers.length > 0) {
                        // æ ¹æ“šæ˜ŸæœŸå¹¾æ±ºå®šç­åˆ¥ï¼ˆä¸åŒ…å«æ«ƒæª¯ï¼Œå› ç‚ºæ«ƒæª¯äººå“¡å·²ç¶“ä¸Šç­ï¼‰
                        let shifts = [];
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            // æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸäº”ï¼šæ”¶ç­ã€æ´—ç¢—ï¼ˆæ«ƒæª¯ç”±æ«ƒæª¯äººå“¡æ“”ä»»ï¼‰
                            shifts = ["æ”¶ç­", "æ´—ç¢—"];
                        } else {
                            // æ˜ŸæœŸå…­ã€æ˜ŸæœŸæ—¥ï¼šæ—©ç­ã€æ”¶ç­ã€æ´—ç¢—ï¼ˆæ«ƒæª¯ç”±æ«ƒæª¯äººå“¡æ“”ä»»ï¼‰
                            shifts = ["æ—©ç­", "æ”¶ç­", "æ´—ç¢—"];
                        }
                        
                        // å¹³å‡åˆ†é…ç­åˆ¥çµ¦å¯ç”¨çš„å·¥è®€ç”Ÿ
                        const sortedWorkers = dayAvailableWorkers.sort((a, b) => 
                            workerWorkDays[a.username] - workerWorkDays[b.username]
                        );
                        const shuffledShifts = [...shifts].sort(() => Math.random() - 0.5);
                        
                        // ä¿®å¾©ï¼šç‚ºæ¯å€‹ç­æ¬¡å°‹æ‰¾åˆé©çš„å·¥äººï¼Œè€Œä¸æ˜¯ç¶å®šç´¢å¼•
                        let workerIndex = 0;
                        for (const shift of shuffledShifts) {
                            let assigned = false;
                            let attempt = 0;
                            
                            // å˜—è©¦åˆ†é…çµ¦ä¸‹ä¸€å€‹å·¥äººï¼Œæœ€å¤šç¹ä¸€åœˆ
                            while (!assigned && attempt < sortedWorkers.length) {
                                const worker = sortedWorkers[workerIndex % sortedWorkers.length];
                                
                                // æª¢æŸ¥å·¥äººæ˜¯å¦å¯ä»¥åœ¨é€™å€‹ç­æ¬¡å·¥ä½œï¼ˆè€ƒæ…®åˆ†æ™‚æ®µä¼‘å‡ï¼‰
                                const canWork = this.isWorkerAvailableForShift(worker, dateString, shift, workerVacationTimes);
                                
                                // æª¢æŸ¥è¡çªï¼šä½¿ç”¨èˆ‡æ«ƒæª¯ä¼‘å‡ç›¸åŒçš„åˆ†çµ„è¦å‰‡
                                let hasConflict = false;
                                const morningGroup = ["æ—©ç­"];  // æ­£å¸¸æ’ç­æ™‚ï¼Œåªæœ‰æ—©ç­å±¬æ–¼æ—©ç­çµ„
                                const eveningGroup = ["æ´—ç¢—", "æ”¶ç­"];  // æ´—ç¢—ã€æ”¶ç­å±¬æ–¼æ™šç­çµ„
                                
                                for (const existing of daySchedule) {
                                    if (existing.username === worker.username) {
                                        // Rule 1: æ—©ç­çµ„å…§ä¸èƒ½é‡è¤‡ï¼ˆé€™è£¡åªæœ‰ä¸€å€‹æ—©ç­ï¼Œæ‰€ä»¥ä¸æœƒè¡çªï¼‰
                                        if (morningGroup.includes(shift) && morningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                        
                                        // Rule 2: æ™šç­çµ„å…§ä¸èƒ½é‡è¤‡ï¼ˆæ´—ç¢—ã€æ”¶ç­ä¸èƒ½åŒä¸€äººï¼‰
                                        if (eveningGroup.includes(shift) && eveningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                    }
                                }
                                
                                if (canWork && !hasConflict) {
                                    daySchedule.push({
                                        username: worker.username,
                                        role: "å¤–å ´å·¥è®€ç”Ÿ",
                                        shift: shift
                                    });
                                    workerWorkDays[worker.username]++;
                                    assigned = true;
                                }
                                
                                workerIndex++;
                                attempt++;
                            }
                        }
                    }
                }
                
                return daySchedule;
            }

            // å°ˆé–€ç”¨æ–¼è‡ªå‹•æ’ç­çš„æ–¹æ³•ï¼Œä¸ä¾è³´å‹¾é¸æ¡†ç‹€æ…‹
            async generateOutsideScheduleAuto(year, month, startDay = 1, endDay = null) {
                const allUsers = this.scheduleManager.getAllUsers();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, userAvailability = {}, outsideSchedule = {}, userVacationTimes = {} } = allData;
                
                const outsideWorkers = allUsers.filter(u => u.role === "å¤–å ´å·¥è®€ç”Ÿ");
                const counterStaff = allUsers.filter(u => u.role === "å¤–å ´æ«ƒæª¯");
                
                if (outsideWorkers.length === 0) {
                    console.log('æ²’æœ‰å¤–å ´å·¥è®€ç”Ÿå¯ä»¥æ’ç­');
                    return;
                }
                
                const lastDayOfMonth = new Date(year, month, 0).getDate();
                const actualEndDay = endDay || lastDayOfMonth;
                
                // è¤‡è£½èˆŠæ’ç­è³‡æ–™ï¼Œä½†æ¸…ç©ºå³å°‡ç”Ÿæˆçš„æ—¥æœŸç¯„åœ
                const newSchedule = { ...outsideSchedule };
                
                // æ¸…é™¤æŒ‡å®šæ—¥æœŸç¯„åœçš„èˆŠæ’ç­æ•¸æ“š
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    delete newSchedule[dateString];
                }
                
                // ç²å–æ«ƒæª¯ä¼‘å‡æ—¥æœŸ
                const counterVacations = [];
                counterStaff.forEach(staff => {
                    const vacationKey = `${staff.id}-${year}-${month}`;
                    const vacations = userVacations[vacationKey] || [];
                    vacations.forEach(date => {
                        counterVacations.push({ date, staff: staff.username });
                    });
                });
                
                // ç²å–å·¥è®€ç”Ÿä¸å¯ä¸Šç­æ—¥æœŸå’Œåˆ†æ™‚æ®µä¼‘å‡
                const workerUnavailability = {};
                const workerVacationTimes = {};
                outsideWorkers.forEach(worker => {
                    const numericMonth = parseInt(month, 10);
                    const availabilityKey = `${worker.id}-${year}-${numericMonth}`;
                    const vacationTimeKey = `${worker.id}-${year}-${numericMonth}`;
                    const legacyVacationTimeKey = `${worker.id}-${year}-${String(numericMonth).padStart(2, '0')}`;
                    workerUnavailability[worker.username] = userAvailability[availabilityKey] || [];
                    workerVacationTimes[worker.username] = userVacationTimes[vacationTimeKey] 
                        || userVacationTimes[legacyVacationTimeKey] 
                        || {};
                });
                
                // è¨ˆç®—æ¯å€‹å·¥è®€ç”Ÿçš„å·¥ä½œå¤©æ•¸
                const workerWorkDays = {};
                outsideWorkers.forEach(worker => {
                    workerWorkDays[worker.username] = 0;
                });
                
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay();
                    
                    // è·³éæ˜ŸæœŸå››ï¼ˆå…¬ä¼‘æ—¥ï¼‰
                    if (dayOfWeek === 4) continue;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰æ«ƒæª¯ä¼‘å‡
                    const counterVacation = counterVacations.find(cv => cv.date === dateString);
                    
                    // ä½¿ç”¨çµ±ä¸€çš„æ’ç­é‚è¼¯
                    const daySchedule = this.generateDaySchedule(
                        dateString, 
                        dayOfWeek, 
                        counterVacation, 
                        outsideWorkers, 
                        workerUnavailability, 
                        workerVacationTimes, 
                        workerWorkDays
                    );
                    
                    if (daySchedule.length > 0) {
                        newSchedule[dateString] = daySchedule;
                    }
                }
                
                // æ›´æ–°æ’ç­è³‡æ–™
                await this.scheduleManager.updateOutsideSchedule(newSchedule);
                console.log('å¤–å ´æ’ç­å·²è‡ªå‹•ç”Ÿæˆï¼');
            }

            async handleRegister(e) {
                e.preventDefault();
                this.uiManager.setAuthError('');
                
                const username = this.uiManager.registerForm.querySelector('#register-username').value.trim();
                const password = this.uiManager.registerForm.querySelector('#register-password').value;
                const passwordConfirm = this.uiManager.registerForm.querySelector('#register-password-confirm').value;
                const role = this.uiManager.registerForm.querySelector('#register-role').value;
                
                try {
                    await this.authManager.register(username, password, passwordConfirm, role);
                    this.uiManager.showToast('è¨»å†ŠæˆåŠŸï¼');
                } catch (error) {
                    this.uiManager.setAuthError(error.message);
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                this.uiManager.setAuthError('');
                
                const username = this.uiManager.loginForm.querySelector('#login-username').value.trim().toLowerCase();
                const password = this.uiManager.loginForm.querySelector('#login-password').value;
                
                try {
                    await this.authManager.login(username, password);
                } catch (error) {
                    this.uiManager.setAuthError(error.message);
                }
            }

            async handleLogout() {
                await this.authManager.logout();
            }

            async handleChangePassword(e) {
                e.preventDefault();
                this.uiManager.setPasswordError('');
                
                const newPassword = this.uiManager.changePasswordForm.querySelector('#new-password').value;
                const confirmNewPassword = this.uiManager.changePasswordForm.querySelector('#confirm-new-password').value;

                try {
                    await this.authManager.changePassword(newPassword, confirmNewPassword);
                    this.uiManager.showToast('å¯†ç¢¼æ›´æ–°æˆåŠŸï¼');
                    this.uiManager.hideSettingsModal();
                    this.uiManager.changePasswordForm.reset();
                } catch (error) {
                    this.uiManager.setPasswordError(error.message);
                }
            }

            async handleChangeUsername(e) {
                e.preventDefault();
                this.uiManager.setUsernameError('');
                
                const newUsernameInput = this.uiManager.changeUsernameForm.querySelector('#new-username');
                const newUsername = newUsernameInput.value.trim();

                try {
                    await this.authManager.changeUsername(newUsername);
                    this.uiManager.showToast('åç¨±æ›´æ–°æˆåŠŸï¼');
                    this.uiManager.hideSettingsModal();
                } catch (error) {
                    this.uiManager.setUsernameError(error.message);
                }
            }

            async handleDayClick(e) {
                // === å„ªåŒ– 4.3: é˜²æ­¢å¿«é€Ÿé‡è¤‡é»æ“Š ===
                if (this._dayClickInProgress) return;
                this._dayClickInProgress = true;
                setTimeout(() => { this._dayClickInProgress = false; }, 300);
                
                const dayDiv = e.target.closest('.calendar-day');
                if (!dayDiv || !dayDiv.dataset.date) return;
                
                const clickedDateStr = dayDiv.dataset.date;
                const [year, month, day] = clickedDateStr.split('-').map(Number);
                const clickedDate = new Date(year, month - 1, day);
                const allData = this.scheduleManager.getAllData();
                const { adminHolidays: currentAdminHolidays = [], userVacations = {} } = allData;
                
                if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                    if (clickedDate.getDay() === 4) return this.uiManager.showToast("æ˜ŸæœŸå››æ˜¯å›ºå®šå…¬ä¼‘æ—¥ï¼Œç„¡æ³•æ›´æ”¹ã€‚");
                    
                    const newAdminHolidays = currentAdminHolidays.includes(clickedDateStr)
                        ? currentAdminHolidays.filter(d => d !== clickedDateStr)
                        : [...currentAdminHolidays, clickedDateStr];
                    
                    await this.scheduleManager.updateAdminHolidays(newAdminHolidays);
                    this.uiManager.showToast(currentAdminHolidays.includes(clickedDateStr) ? `${clickedDateStr} å·²å–æ¶ˆå…¬ä¼‘ã€‚` : `${clickedDateStr} å·²è¨­å®šç‚ºå…¬ä¼‘æ—¥ã€‚`);
                    return;
                }
                
                if (clickedDate.getDay() === 4 || currentAdminHolidays.includes(clickedDateStr)) {
                    return this.uiManager.showToast("æ­¤æ—¥ç‚ºå…¬ä¼‘æ—¥ï¼Œç„¡æ³•æ’ç­");
                }
                
                const [yearFromStr, monthFromStr] = clickedDateStr.split('-');

                if (this.FULLTIME_ROLES.includes(this.authManager.getCurrentUserData().role)) {
                    await this.handleFullTimeDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations);
                } else if (this.authManager.getCurrentUserData().role === this.PART_TIMER_ROLE) {
                    await this.handlePartTimerDayClick(clickedDateStr, yearFromStr, monthFromStr);
                } else if (this.OUTSIDE_ROLES.includes(this.authManager.getCurrentUserData().role)) {
                    await this.handleOutsideDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations);
                }
            }

            async handleFullTimeDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations) {
                const vacationKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                const currentVacations = userVacations[vacationKey] || [];
                const isVacation = currentVacations.includes(clickedDateStr);
                
                let newVacations;

                if (isVacation) {
                    newVacations = currentVacations.filter(d => d !== clickedDateStr);
                } else {
                    if(currentVacations.length >= 5) return this.uiManager.showToast('æœ¬æœˆä¼‘å‡å·²é¸æ»¿5å¤©');
                    
                    const allUsers = this.scheduleManager.getAllUsers();
                    const otherFullTimers = allUsers.filter(u => u.id !== this.authManager.getCurrentUser().uid && this.FULLTIME_ROLES.includes(u.role));
                    let isDayTaken = false;
                    for (const otherUser of otherFullTimers) {
                        const otherUserVacationKey = `${otherUser.id}-${yearFromStr}-${parseInt(monthFromStr)}`;
                        const otherUserVacations = userVacations[otherUserVacationKey] || [];
                        if (otherUserVacations.includes(clickedDateStr)) {
                            isDayTaken = true;
                            break;
                        }
                    }

                    if (isDayTaken) {
                        return this.uiManager.showToast(`å·²æœ‰å…¶ä»–æ­£è·äººå“¡æ–¼æ­¤æ—¥æ’ä¼‘ï¼Œç„¡æ³•é¸æ“‡ã€‚`);
                    }
                    
                    newVacations = [...currentVacations, clickedDateStr];
                }
                
                await this.scheduleManager.updateUserVacation(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newVacations);
            }

            async handlePartTimerDayClick(clickedDateStr, yearFromStr, monthFromStr) {
                const availabilityKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                const allData = this.scheduleManager.getAllData();
                const currentAvailability = allData.userAvailability?.[availabilityKey] || [];
                const newAvailability = currentAvailability.includes(clickedDateStr)
                    ? currentAvailability.filter(d => d !== clickedDateStr)
                    : [...currentAvailability, clickedDateStr];
                    
                await this.scheduleManager.updateUserAvailability(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newAvailability);
            }

            async handleOutsideDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations) {
                const currentUserData = this.authManager.getCurrentUserData();
                
                if (currentUserData.role === "å¤–å ´æ«ƒæª¯") {
                    // å¤–å ´æ«ƒæª¯çš„ä¼‘å‡é‚è¼¯ï¼ˆé¡ä¼¼å…§å ´å‚™èœç­ï¼‰
                    const vacationKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                    const currentVacations = userVacations[vacationKey] || [];
                    const isVacation = currentVacations.includes(clickedDateStr);
                    
                    let newVacations;

                    if (isVacation) {
                        newVacations = currentVacations.filter(d => d !== clickedDateStr);
                    } else {
                        if(currentVacations.length >= 5) return this.uiManager.showToast('æœ¬æœˆä¼‘å‡å·²é¸æ»¿5å¤©');
                        
                        const allUsers = this.scheduleManager.getAllUsers();
                        const otherCounterStaff = allUsers.filter(u => u.id !== this.authManager.getCurrentUser().uid && u.role === "å¤–å ´æ«ƒæª¯");
                        let isDayTaken = false;
                        for (const otherUser of otherCounterStaff) {
                            const otherUserVacationKey = `${otherUser.id}-${yearFromStr}-${parseInt(monthFromStr)}`;
                            const otherUserVacations = userVacations[otherUserVacationKey] || [];
                            if (otherUserVacations.includes(clickedDateStr)) {
                                isDayTaken = true;
                                break;
                            }
                        }

                        if (isDayTaken) {
                            return this.uiManager.showToast(`å·²æœ‰å…¶ä»–å¤–å ´æ«ƒæª¯æ–¼æ­¤æ—¥æ’ä¼‘ï¼Œç„¡æ³•é¸æ“‡ã€‚`);
                        }
                        
                        newVacations = [...currentVacations, clickedDateStr];
                    }
                    
                    await this.scheduleManager.updateUserVacation(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newVacations);
                
                // =======================
                // === (MODIFIED) Block ===
                // =======================
                } else if (currentUserData.role === "å¤–å ´å·¥è®€ç”Ÿ") {
                    
                    const allData = this.scheduleManager.getAllData();
                    const { outsideSchedule = {}, userAvailability = {} } = allData;
                    
                    // æª¢æŸ¥ç•¶å¤©è‡ªå·±è¢«æ’äº†å“ªäº›ç­
                    const myShifts = (outsideSchedule[clickedDateStr] || []).filter(
                        s => s.username === currentUserData.username
                    );
                    
                    // --- NEW LOGIC ---
                    if (myShifts.length > 1) {
                        // === æƒ…å¢ƒ1: å¤šå€‹ç­æ¬¡ï¼Œé¡¯ç¤ºç­æ¬¡é¸æ“‡å™¨ ===
                        this.uiManager.showShiftSelectModal(clickedDateStr, myShifts);
                    
                    } else if (myShifts.length === 1) {
                        // === æƒ…å¢ƒ2: ä¸€å€‹ç­æ¬¡ï¼Œç›´æ¥é¡¯ç¤ºåŒäº‹é¸æ“‡å™¨ ===
                        const allUsers = this.scheduleManager.getAllUsers();
                        const replacementOptions = allUsers.filter(u => 
                            u.role === "å¤–å ´å·¥è®€ç”Ÿ" && u.id !== this.authManager.getCurrentUser().uid
                        );
                        const shiftToCover = myShifts[0].shift;
                        this.uiManager.showCoverShiftModal(clickedDateStr, shiftToCover, replacementOptions);

                    } else {
                        // === æƒ…å¢ƒ3: æ²’æœ‰ç­æ¬¡ï¼Œé¡¯ç¤ºä¼‘å‡æ™‚é–“é¸æ“‡ ===
                        this.showVacationTimeModal(clickedDateStr, yearFromStr, monthFromStr);
                    }
                    // --- END NEW LOGIC ---
                }
                // =======================
                // === End Modified Block ===
                // =======================
            }

            // è™•ç†ç­æ¬¡é¸æ“‡çš„å‡½å¼
            handleShiftSelect(date, shift) {
                // 1. éš±è—ç­æ¬¡é¸æ“‡ modal
                this.uiManager.hideShiftSelectModal();

                // 2. æº–å‚™ä¸¦é¡¯ç¤ºåŒäº‹é¸æ“‡ modal
                const allUsers = this.scheduleManager.getAllUsers();
                const replacementOptions = allUsers.filter(u => 
                    u.role === "å¤–å ´å·¥è®€ç”Ÿ" && u.id !== this.authManager.getCurrentUser().uid
                );

                this.uiManager.showCoverShiftModal(date, shift, replacementOptions);
            }

            // è™•ç†ä»£ç­äººæŒ‡æ´¾çš„å‡½å¼
            async handleAssignCoverShift(e) {
                e.preventDefault();
                
                // å¾è¡¨å–®çš„ dataset ç²å–è³‡è¨Š
                const date = this.uiManager.coverShiftForm.dataset.date;
                const shift = this.uiManager.coverShiftForm.dataset.shift;
                
                // ç²å–é¸æ“‡çš„ä»£ç­äººå“¡
                const replacementUserId = this.uiManager.coverShiftSelect.value;
                if (!replacementUserId) {
                    return this.uiManager.showToast("è«‹é¸æ“‡ä¸€ä½ä»£ç­äººå“¡");
                }
                
                const replacementUser = this.scheduleManager.getAllUsers().find(u => u.id === replacementUserId);
                if (!replacementUser) {
                    return this.uiManager.showToast("ä»£ç­äººå“¡è³‡æ–™éŒ¯èª¤");
                }

                this.uiManager.showToast("æ­£åœ¨è™•ç†æ›ç­...");

                try {
                    // é€™æ˜¯é—œéµçš„ Read-Modify-Write é‚è¼¯
                    const allData = this.scheduleManager.getAllData();
                    // === å„ªåŒ– 1.2: ä½¿ç”¨å„ªåŒ–çš„æ·±æ‹·è² ===
                    const newOutsideSchedule = deepClone(allData.outsideSchedule || {});
                    
                    const daySchedule = newOutsideSchedule[date];
                    if (!daySchedule) {
                        throw new Error("æ‰¾ä¸åˆ°ç•¶å¤©çš„æ’ç­è³‡æ–™");
                    }
                    
                    // æ‰¾åˆ°ä½¿ç”¨è€…åŸæœ‰çš„ç­æ¬¡
                    const originalShiftIndex = daySchedule.findIndex(s => 
                        s.username === this.authManager.getCurrentUserData().username && 
                        s.shift === shift
                    );
                    
                    if (originalShiftIndex === -1) {
                        throw new Error("æ‰¾ä¸åˆ°æ‚¨åŸæœ‰çš„ç­æ¬¡ï¼Œå¯èƒ½å·²è¢«æ›´å‹•");
                    }
                    
                    // === åŸ·è¡Œæ›ç­ ===
                    // å°‡è©²ç­æ¬¡çš„ username æ›æˆä»£ç­äººçš„ username
                    daySchedule[originalShiftIndex].username = replacementUser.username;
                    
                    // å°‡ä¿®æ”¹å¾Œçš„æ’ç­è¡¨å¯«å›è³‡æ–™åº«
                    await this.scheduleManager.updateOutsideSchedule(newOutsideSchedule);
                    
                    this.uiManager.showToast("æ›ç­æˆåŠŸï¼");
                    this.uiManager.hideCoverShiftModal();
                    
                    // åˆ·æ–°æœˆæ›†é¡¯ç¤ºæœ€æ–°çš„æ’ç­è³‡æ–™
                    await this.renderOutsideCalendar();

                } catch (error) {
                    console.error("æ›ç­å¤±æ•—:", error);
                    this.uiManager.showToast(`æ›ç­å¤±æ•—ï¼š${error.message}`);
                }
            }

            // è™•ç†åˆªé™¤ç”¨æˆ¶é»æ“Š
            handleDeleteUserClick(userId, username, role) {
                this.pendingDeleteUser = { id: userId, username, role };
                this.uiManager.showDeleteUserModal({ username, role });
            }

            // è™•ç†ç¢ºèªåˆªé™¤ç”¨æˆ¶
            async handleDeleteUser() {
                if (!this.pendingDeleteUser) {
                    this.uiManager.showToast('æ²’æœ‰é¸æ“‡è¦åˆªé™¤çš„ç”¨æˆ¶');
                    return;
                }

                try {
                    this.uiManager.showToast('æ­£åœ¨åˆªé™¤ç”¨æˆ¶...');
                    await this.scheduleManager.deleteUser(this.pendingDeleteUser.id);
                    this.uiManager.showToast(`ç”¨æˆ¶ã€Œ${this.pendingDeleteUser.username}ã€å·²æˆåŠŸåˆªé™¤`);
                    this.uiManager.hideDeleteUserModal();
                    
                    // é‡æ–°ç”Ÿæˆç”¨æˆ¶ç®¡ç†åˆ—è¡¨
                    this.generateUserManagementLists();
                    
                    // æ¸…é™¤å¾…åˆªé™¤ç”¨æˆ¶
                    this.pendingDeleteUser = null;
                    
                } catch (error) {
                    console.error('åˆªé™¤ç”¨æˆ¶å¤±æ•—:', error);
                    this.uiManager.showToast(`åˆªé™¤ç”¨æˆ¶å¤±æ•—ï¼š${error.message}`);
                }
            }

            // é¡¯ç¤ºä¼‘å‡æ™‚é–“é¸æ“‡
            showVacationTimeModal(date, year, month) {
                // month å¯èƒ½å«å‰å° 0ï¼Œè½‰ç‚ºæ•¸å­—é¿å… key ä¸ä¸€è‡´
                const numericMonth = parseInt(month, 10);
                this.pendingVacationDate = { date, year, month: numericMonth };
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„ä¼‘å‡æ•¸æ“š
                const allData = this.scheduleManager.getAllData();
                const vacationTimeKey = `${this.authManager.getCurrentUser().uid}-${year}-${numericMonth}`;
                const legacyVacationTimeKey = `${this.authManager.getCurrentUser().uid}-${year}-${String(numericMonth).padStart(2, '0')}`;
                const userVacationTimes = allData.userVacationTimes?.[vacationTimeKey] 
                    || allData.userVacationTimes?.[legacyVacationTimeKey] 
                    || {};
                const currentVacationData = userVacationTimes[date];
                
                this.uiManager.showVacationTimeModal(date, currentVacationData);
            }

            // è™•ç†ç¢ºèªä¼‘å‡æ™‚é–“é¸æ“‡
            async handleVacationTimeConfirm() {
                if (!this.pendingVacationDate) {
                    this.uiManager.showToast('æ²’æœ‰é¸æ“‡ä¼‘å‡æ—¥æœŸ');
                    return;
                }

                const { date, year, month } = this.pendingVacationDate;
                const morningVacation = this.uiManager.vacationMorningCheckbox.checked;
                const eveningVacation = this.uiManager.vacationEveningCheckbox.checked;

                // ========== æ™ºèƒ½ä¼‘å‡é™åˆ¶æª¢æŸ¥ ==========
                if (morningVacation || eveningVacation) {
                    const canVacation = await this.checkOutsideWorkerVacationLimit(date, year, month, morningVacation, eveningVacation);
                    if (!canVacation.allowed) {
                        this.uiManager.showToast(canVacation.message);
                        return;
                    }
                }
                // =====================================

                try {
                    await this.scheduleManager.updateUserVacationTime(
                        this.authManager.getCurrentUser().uid,
                        year,
                        month,
                        date,
                        { morning: morningVacation, evening: eveningVacation }
                    );
                    const allData = this.scheduleManager.getAllData();
                    const availabilityKey = `${this.authManager.getCurrentUser().uid}-${year}-${month}`;
                    const currentAvailability = allData.userAvailability?.[availabilityKey] || [];
                    
                    if (currentAvailability.includes(date)) {
                        const newAvailability = currentAvailability.filter(d => d !== date);
                        await this.scheduleManager.updateUserAvailability(
                            this.authManager.getCurrentUser().uid, 
                            year, 
                            month, 
                            newAvailability
                        );
                    }

                    let message = '';
                    if (morningVacation && eveningVacation) {
                        message = `${date} å·²è¨­å®šç‚ºå…¨å¤©ä¼‘å‡`;
                    } else if (morningVacation) {
                        message = `${date} å·²è¨­å®šç‚ºæ—©ä¸Šä¼‘å‡`;
                    } else if (eveningVacation) {
                        message = `${date} å·²è¨­å®šç‚ºæ™šä¸Šä¼‘å‡`;
                    } else {
                        message = `${date} å·²å–æ¶ˆä¼‘å‡ï¼Œå¯ä»¥æ­£å¸¸æ’ç­`;
                    }

                    this.uiManager.showToast(message);
                    this.uiManager.hideVacationTimeModal();
                    
                    // æ¸…é™¤å¾…è™•ç†çš„ä¼‘å‡æ—¥æœŸ
                    this.pendingVacationDate = null;
                    
                    // æ‰‹å‹•è§¸ç™¼æœˆæ›†é‡æ–°æ¸²æŸ“ï¼Œç¢ºä¿ä¼‘å‡æ™‚é–“ç«‹å³æ›´æ–°
                    this.renderAppView();
                    
                } catch (error) {
                    console.error('æ›´æ–°ä¼‘å‡æ™‚é–“å¤±æ•—:', error);
                    this.uiManager.showToast(`æ›´æ–°ä¼‘å‡æ™‚é–“å¤±æ•—ï¼š${error.message}`);
                }
            }
            
            // æª¢æŸ¥å¤–å ´å·¥è®€ç”Ÿä¼‘å‡æ˜¯å¦è¶…éé™åˆ¶
            async checkOutsideWorkerVacationLimit(dateString, year, month, requestMorning, requestEvening) {
                const allUsers = this.scheduleManager.getAllUsers();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, userVacationTimes = {} } = allData;
                
                // 1. ç²å–æ‰€æœ‰å¤–å ´å·¥è®€ç”Ÿ
                const outsideWorkers = allUsers.filter(u => u.role === "å¤–å ´å·¥è®€ç”Ÿ");
                const totalWorkers = outsideWorkers.length;
                
                if (totalWorkers === 0) {
                    return { allowed: false, message: 'æ²’æœ‰å¤–å ´å·¥è®€ç”Ÿ' };
                }
                
                // 2. åˆ¤æ–·è©²æ—¥æœŸæ˜¯å¹³æ—¥é‚„æ˜¯å‡æ—¥
                const [yearStr, monthStr, dayStr] = dateString.split('-');
                const targetDate = new Date(parseInt(yearStr), parseInt(monthStr) - 1, parseInt(dayStr));
                const dayOfWeek = targetDate.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // é€±å…­æˆ–é€±æ—¥
                const isWeekday = (dayOfWeek >= 1 && dayOfWeek <= 5); // é€±ä¸€åˆ°é€±äº”
                
                // 3. æª¢æŸ¥å¤–å ´æ«ƒæª¯æ˜¯å¦ä¼‘å‡
                const counterStaff = allUsers.filter(u => u.role === "å¤–å ´æ«ƒæª¯");
                let isCounterVacation = false;
                for (const staff of counterStaff) {
                    const vacationKey = `${staff.id}-${year}-${month}`;
                    const vacations = userVacations[vacationKey] || [];
                    if (vacations.includes(dateString)) {
                        isCounterVacation = true;
                        break;
                    }
                }
                
                // 4. æ ¹æ“šæ¢ä»¶æ±ºå®šéœ€è¦å¤šå°‘ä½å·¥è®€ç”Ÿä¸Šç­
                let requiredMorningWorkers = 0;
                let requiredEveningWorkers = 0;
                
                if (isWeekday && !isCounterVacation) {
                    // å¹³æ—¥ + æ«ƒæª¯ä¸Šç­ï¼šéœ€è¦2ä½ï¼ˆæ´—ç¢—ã€æ”¶ç­ï¼‰- éƒ½æ˜¯æ™šä¸Šç­æ¬¡
                    requiredMorningWorkers = 0;
                    requiredEveningWorkers = 2;
                } else if (isWeekday && isCounterVacation) {
                    // å¹³æ—¥ + æ«ƒæª¯ä¼‘å‡ï¼šéœ€è¦4ä½ï¼ˆæ—©æ«ƒã€æ™šæ«ƒã€æ´—ç¢—ã€æ”¶ç­ï¼‰
                    requiredMorningWorkers = 1; // æ—©æ«ƒ
                    requiredEveningWorkers = 3; // æ™šæ«ƒã€æ´—ç¢—ã€æ”¶ç­
                } else if (isWeekend && !isCounterVacation) {
                    // å‡æ—¥ + æ«ƒæª¯ä¸Šç­ï¼šéœ€è¦3ä½ï¼ˆæ—©ç­ã€æ´—ç¢—ã€æ”¶ç­ï¼‰
                    requiredMorningWorkers = 1; // æ—©ç­
                    requiredEveningWorkers = 2; // æ´—ç¢—ã€æ”¶ç­
                } else if (isWeekend && isCounterVacation) {
                    // å‡æ—¥ + æ«ƒæª¯ä¼‘å‡ï¼šéœ€è¦5ä½ï¼ˆæ—©æ«ƒã€æ—©ç­ã€æ™šæ«ƒã€æ´—ç¢—ã€æ”¶ç­ï¼‰
                    requiredMorningWorkers = 2; // æ—©æ«ƒã€æ—©ç­
                    requiredEveningWorkers = 3; // æ™šæ«ƒã€æ´—ç¢—ã€æ”¶ç­
                }
                
                // 5. è¨ˆç®—å·²ç¶“ä¼‘å‡çš„å·¥è®€ç”Ÿäººæ•¸ï¼ˆä¸åŒ…æ‹¬ç•¶å‰ç”¨æˆ¶ï¼‰
                let morningVacationCount = 0;
                let eveningVacationCount = 0;
                
                const currentUserId = this.authManager.getCurrentUser().uid;
                
                for (const worker of outsideWorkers) {
                    if (worker.id === currentUserId) continue; // ä¸è¨ˆç®—è‡ªå·±
                    
                    const numericMonth = parseInt(month, 10);
                    const vacationTimeKey = `${worker.id}-${year}-${numericMonth}`;
                    const legacyVacationTimeKey = `${worker.id}-${year}-${String(numericMonth).padStart(2, '0')}`;
                    const workerVacationTimes = userVacationTimes[vacationTimeKey] 
                        || userVacationTimes[legacyVacationTimeKey] 
                        || {};
                    const vacationData = workerVacationTimes[dateString];
                    
                    if (vacationData) {
                        if (vacationData.morning) {
                            morningVacationCount++;
                        }
                        if (vacationData.evening) {
                            eveningVacationCount++;
                        }
                    }
                }
                
                // 6. è¨ˆç®—å¯ç”¨çš„å·¥è®€ç”Ÿäººæ•¸
                const availableMorningWorkers = totalWorkers - morningVacationCount - 1; // -1 æ˜¯ç•¶å‰ç”¨æˆ¶
                const availableEveningWorkers = totalWorkers - eveningVacationCount - 1;
                
                // 7. åˆ¤æ–·æ˜¯å¦å…è¨±ä¼‘å‡
                if (requestMorning && requiredMorningWorkers > 0) {
                    if (availableMorningWorkers < requiredMorningWorkers) {
                        return { 
                            allowed: false, 
                            message: `ç•¶æ—¥æ—©ä¸Šå·¥è®€ç”Ÿå·²ä¼‘æ»¿ï¼Œéœ€è¦è‡³å°‘${requiredMorningWorkers}ä½å·¥è®€ç”Ÿä¸Šæ—©ç­` 
                        };
                    }
                }
                
                if (requestEvening && requiredEveningWorkers > 0) {
                    if (availableEveningWorkers < requiredEveningWorkers) {
                        return { 
                            allowed: false, 
                            message: `ç•¶æ—¥æ™šä¸Šå·¥è®€ç”Ÿå·²ä¼‘æ»¿ï¼Œéœ€è¦è‡³å°‘${requiredEveningWorkers}ä½å·¥è®€ç”Ÿä¸Šæ™šç­` 
                        };
                    }
                }
                
                return { allowed: true };
            }

            // æª¢æŸ¥å·¥äººæ˜¯å¦å¯ä»¥åœ¨ç‰¹å®šæ™‚é–“å·¥ä½œ
            isWorkerAvailableForShift(worker, dateString, shift, workerVacationTimes) {
                const workerVacationData = workerVacationTimes[worker.username]?.[dateString];
                
                if (!workerVacationData) {
                    // æ²’æœ‰ä¼‘å‡è¨˜éŒ„ï¼Œå¯ä»¥å·¥ä½œ
                    return true;
                }
                
                const morningShifts = ["æ—©æ«ƒ", "æ—©ç­"];
                const eveningShifts = ["æ™šæ«ƒ", "æ™šç­", "æ´—ç¢—", "æ”¶ç­"];
                
                if (morningShifts.includes(shift)) {
                    // æ—©ä¸Šç­æ¬¡ï¼Œæª¢æŸ¥æ˜¯å¦æ—©ä¸Šä¼‘å‡
                    return !workerVacationData.morning;
                } else if (eveningShifts.includes(shift)) {
                    // æ™šä¸Šç­æ¬¡ï¼Œæª¢æŸ¥æ˜¯å¦æ™šä¸Šä¼‘å‡
                    return !workerVacationData.evening;
                }
                
                return true;
            }
            
            // å¤–å ´æ’ç­ç³»çµ± (Generator - ç„¡è®Šå‹•)
            async generateOutsideSchedule(year, month, startDay = 1, endDay = null) {
                const allUsers = this.scheduleManager.getAllUsers();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, userAvailability = {}, outsideSchedule = {} } = allData;
                
                const outsideWorkers = allUsers.filter(u => u.role === "å¤–å ´å·¥è®€ç”Ÿ");
                const counterStaff = allUsers.filter(u => u.role === "å¤–å ´æ«ƒæª¯");
                
                // ç²å–å‹¾é¸æ¡†ç‹€æ…‹ï¼Œåªæ’æœ‰å‹¾é¸çš„å·¥è®€ç”Ÿ
                const availableWorkers = outsideWorkers.filter(worker => {
                    const checkbox = document.getElementById(`worker-${worker.id}`);
                    return checkbox ? checkbox.checked : true;
                });
                
                if (availableWorkers.length === 0) {
                    this.uiManager.showToast('æ²’æœ‰å¤–å ´å·¥è®€ç”Ÿå¯ä»¥æ’ç­');
                    return;
                }
                
                const lastDayOfMonth = new Date(year, month, 0).getDate();
                const actualEndDay = endDay || lastDayOfMonth;
                
                // è¤‡è£½èˆŠæ’ç­è³‡æ–™ï¼Œä½†æ¸…ç©ºå³å°‡ç”Ÿæˆçš„æ—¥æœŸç¯„åœ
                const newSchedule = { ...outsideSchedule };
                
                // æ¸…é™¤æŒ‡å®šæ—¥æœŸç¯„åœçš„èˆŠæ’ç­æ•¸æ“š
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    delete newSchedule[dateString];
                }
                
                // ç²å–æ«ƒæª¯ä¼‘å‡æ—¥æœŸ
                const counterVacations = [];
                counterStaff.forEach(staff => {
                    const vacationKey = `${staff.id}-${year}-${month}`;
                    const vacations = userVacations[vacationKey] || [];
                    vacations.forEach(date => {
                        counterVacations.push({ date, staff: staff.username });
                    });
                });
                
                // ç²å–å·¥è®€ç”Ÿä¸å¯ä¸Šç­æ—¥æœŸå’Œåˆ†æ™‚æ®µä¼‘å‡
                const workerUnavailability = {};
                const workerVacationTimes = {};
                availableWorkers.forEach(worker => {
                    const numericMonth = parseInt(month, 10);
                    const availabilityKey = `${worker.id}-${year}-${numericMonth}`;
                    const vacationTimeKey = `${worker.id}-${year}-${numericMonth}`;
                    const legacyVacationTimeKey = `${worker.id}-${year}-${String(numericMonth).padStart(2, '0')}`;
                    workerUnavailability[worker.username] = userAvailability[availabilityKey] || [];
                    workerVacationTimes[worker.username] = allData.userVacationTimes?.[vacationTimeKey] 
                        || allData.userVacationTimes?.[legacyVacationTimeKey] 
                        || {};
                });
                
                // è¨ˆç®—æ¯å€‹å·¥è®€ç”Ÿçš„å·¥ä½œå¤©æ•¸
                const workerWorkDays = {};
                availableWorkers.forEach(worker => {
                    workerWorkDays[worker.username] = 0;
                });
                
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay();
                    
                    // è·³éæ˜ŸæœŸå››ï¼ˆå…¬ä¼‘æ—¥ï¼‰
                    if (dayOfWeek === 4) continue;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰æ«ƒæª¯ä¼‘å‡
                    const counterVacation = counterVacations.find(cv => cv.date === dateString);
                    
                    // ä½¿ç”¨çµ±ä¸€çš„æ’ç­é‚è¼¯
                    const daySchedule = this.generateDaySchedule(
                        dateString, 
                        dayOfWeek, 
                        counterVacation, 
                        availableWorkers, 
                        workerUnavailability, 
                        workerVacationTimes, 
                        workerWorkDays
                    );
                    
                    if (daySchedule.length > 0) {
                        newSchedule[dateString] = daySchedule;
                    }
                }
                
                // æ›´æ–°æ’ç­è³‡æ–™
                await this.scheduleManager.updateOutsideSchedule(newSchedule);
            }

            // å…§å ´å·¥è®€ç”Ÿä»£ç­æŒ‰éˆ• (ç„¡è®Šå‹•)
            async handleCoverShiftAction(e) {
                // é˜²æ­¢é è¨­è¡Œç‚ºå’Œäº‹ä»¶å†’æ³¡
                e.preventDefault();
                e.stopPropagation();
                
                const button = e.target;
                const shiftId = button.dataset.id;
                const allData = this.scheduleManager.getAllData();
                const { coverSignups: currentCoverSignups = {} } = allData;
                
                if (button.classList.contains('signup-cover-btn')) {
                    if (currentCoverSignups[shiftId]) return this.uiManager.showToast('æ­¤ç­æ¬¡å·²è¢«é ç´„ï¼');
                    
                    try {
                        await this.scheduleManager.updateCoverSignups({ ...currentCoverSignups, [shiftId]: this.authManager.getCurrentUser().uid });
                        this.uiManager.showToast('æˆåŠŸé ç´„ä»£ç­ï¼');
                    } catch (error) {
                        console.error('é ç´„ä»£ç­å¤±æ•—:', error);
                        this.uiManager.showToast('é ç´„ä»£ç­å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    }
                } else if (button.classList.contains('cancel-cover-btn')) {
                    if (currentCoverSignups[shiftId] === this.authManager.getCurrentUser().uid) {
                        try {
                            const newCoverSignups = { ...currentCoverSignups };
                            delete newCoverSignups[shiftId];
                            
                            console.log('å–æ¶ˆä»£ç­å‰:', currentCoverSignups);
                            console.log('å–æ¶ˆä»£ç­å¾Œ:', newCoverSignups);
                            
                            await this.scheduleManager.updateCoverSignups(newCoverSignups);
                            this.uiManager.showToast('å·²å–æ¶ˆä»£ç­ã€‚');
                        } catch (error) {
                            console.error('å–æ¶ˆä»£ç­å¤±æ•—:', error);
                            this.uiManager.showToast('å–æ¶ˆä»£ç­å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                        }
                    } else {
                        this.uiManager.showToast('æ‚¨ç„¡æ³•å–æ¶ˆå…¶ä»–äººçš„ä»£ç­ã€‚');
                    }
                }
            }

            // æ‰‹å‹•æ–°å¢æ’ç­
            async handleManualAssignment(e) {
                e.preventDefault();
                const form = document.getElementById('manual-assignment-form');
                const date = form.querySelector('#assignment-date').value;
                const username = form.querySelector('#assignment-user').value.trim();
                let assignedShift = form.querySelector('#assignment-role').value; // Reads the dynamically updated value

                if (!date || !username || !assignedShift) return this.uiManager.showToast('æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«ã€‚');

                // ç‰¹æ®Šè™•ç†ï¼šå¦‚æœæ˜¯ã€Œæ”¶ç­ã€ï¼Œæ ¹æ“šç•¶å‰è¦–åœ–ä¿å­˜ä¸åŒçš„å€¼
                if (assignedShift === 'æ”¶ç­') {
                    if (this.currentCalendarView === 'inside') {
                        assignedShift = 'æ”¶ç­ï¼ˆå…§å ´ï¼‰';
                    } else {
                        assignedShift = 'æ”¶ç­ï¼ˆå¤–å ´ï¼‰';
                    }
                }

                const allData = this.scheduleManager.getAllData();
                const { manualAssignments = {} } = allData;
                
                const dayAssignmentsData = manualAssignments[date] || {};
                const dayAssignments = Array.isArray(dayAssignmentsData) 
                    ? dayAssignmentsData 
                    : Object.values(dayAssignmentsData);
                
                const newAssignment = { username, assignedShift };
                const newDayAssignments = [...dayAssignments, newAssignment];
                const newManualAssignments = { ...manualAssignments, [date]: newDayAssignments };

                await this.scheduleManager.updateManualAssignments(newManualAssignments);
                this.uiManager.showToast('æ‰‹å‹•æ’ç­å·²æ–°å¢ï¼');
                form.reset();
            }

            // åˆªé™¤æ‰‹å‹•æ’ç­
            async handleDeleteManualAssignment(dateString, username, assignedShift) {
                console.log('é–‹å§‹åˆªé™¤æ‰‹å‹•æ’ç­:', { dateString, username, assignedShift });
                
                if (this.authManager.getCurrentUserData()?.role !== this.ADMIN_ROLE) {
                    this.uiManager.showToast('åƒ…ç®¡ç†è€…å¯åˆªé™¤æ­¤ç­æ¬¡ã€‚');
                    return;
                }

                const allData = this.scheduleManager.getAllData();
                const { manualAssignments = {}, userAvailability = {}, userVacations = {}, coverSignups = {} } = allData;
                
                if (!manualAssignments[dateString]) {
                    this.uiManager.showToast('è©²æ—¥æœŸæ²’æœ‰æ‰‹å‹•æ’ç­è³‡æ–™ã€‚');
                    return;
                }

                const dayAssignmentsData = manualAssignments[dateString] || {};
                const dayAssignments = Array.isArray(dayAssignmentsData) 
                    ? dayAssignmentsData 
                    : Object.values(dayAssignmentsData);
                
                // æ”¹é€²åŒ¹é…é‚è¼¯ï¼šè™•ç†ã€Œæ”¶ç­ã€çš„ä¸åŒè®Šé«”å’Œç²¾ç¢ºåŒ¹é…
                const targetIndex = dayAssignments.findIndex(a => {
                    if (a.username !== username) return false;
                    
                    // ç²¾ç¢ºåŒ¹é…
                    if (a.assignedShift === assignedShift) {
                        return true;
                    }
                    
                    // è™•ç†ã€Œæ”¶ç­ã€çš„ä¸åŒè®Šé«”
                    const shiftVariants = ['æ”¶ç­', 'æ”¶ç­ï¼ˆå…§å ´ï¼‰', 'æ”¶ç­ï¼ˆå¤–å ´ï¼‰'];
                    const isClosingShift = shiftVariants.includes(a.assignedShift) && shiftVariants.includes(assignedShift);
                    if (isClosingShift) {
                        return true;
                    }
                    
                    return false;
                });
                
                if (targetIndex === -1) {
                    this.uiManager.showToast('æ‰¾ä¸åˆ°åŒ¹é…çš„æ’ç­è¨˜éŒ„ã€‚');
                    return;
                }
                
                // è¤‡è£½ä¸¦ç§»é™¤è©²ç­†è³‡æ–™
                const newManualAssignments = { ...manualAssignments };
                const updatedDayAssignments = [...dayAssignments];
                updatedDayAssignments.splice(targetIndex, 1); 
                
                // ============================================================
                // === [ä¿®å¾© BUG] æ ¸å¿ƒä¿®æ”¹ä½ç½® ===
                // ============================================================
                // èˆŠå¯«æ³•ï¼š
                // if (updatedDayAssignments.length > 0) { ... } else { delete ... }
                // å°è‡´æœ€å¾Œä¸€ç­†åˆªä¸æ‰ã€‚
                
                // æ–°å¯«æ³•ï¼š
                // ç›´æ¥æŠŠçµæœ (updatedDayAssignments) å¯«å›å»ï¼Œå³ä½¿å®ƒæ˜¯ç©ºé™£åˆ— []ã€‚
                // é€™æ¨£ Firebase æ‰æœƒæ”¶åˆ°ã€Œå°‡æ­¤æ—¥æœŸè¨­ç‚ºç©ºã€çš„æŒ‡ä»¤ï¼Œè¦†è“‹æ‰åŸæœ¬çš„è³‡æ–™ã€‚
                newManualAssignments[dateString] = updatedDayAssignments;
                
                // ============================================================

                // --- ä»¥ä¸‹ç‚ºé€£å‹•æ¸…ç†é‚è¼¯ (ä¿æŒä¸è®Š) ---
                const allUsers = this.scheduleManager.getAllUsers();
                const targetUser = allUsers.find(u => u.username === username);

                const [yearStr, monthStr] = dateString.split('-');
                const year = parseInt(yearStr, 10);
                const month = parseInt(monthStr, 10); 

                let newUserAvailability = { ...userAvailability };
                let newUserVacations = { ...userVacations };
                const currentCoverSignups = coverSignups;
                let newCoverSignups = { ...currentCoverSignups };

                if (targetUser) {
                    if (targetUser.role === this.PART_TIMER_ROLE || targetUser.role === "å¤–å ´å·¥è®€ç”Ÿ") { 
                        const availabilityKey = `${targetUser.id}-${year}-${month}`;
                        const currentAvail = newUserAvailability[availabilityKey] || [];
                        const filteredAvail = currentAvail.filter(d => d !== dateString);
                        // é€™è£¡ç‚ºäº†ä¿éšªèµ·è¦‹ï¼Œæˆ‘å€‘ä¹Ÿæ”¹ç”¨å¯«å…¥ç©ºé™£åˆ—çš„æ–¹å¼ï¼Œé¿å…åŒæ¨£çš„ bug ç™¼ç”Ÿåœ¨ availability
                        newUserAvailability[availabilityKey] = filteredAvail;
                        
                        // æ¸…ç†ä»£ç­
                        const coverKeysToDelete = [];
                        Object.keys(newCoverSignups).forEach(signupId => {
                            const parts = signupId.split('-');
                            if (parts.length >= 5) {
                                const dateInId = parts.slice(parts.length - 4, parts.length - 1).join('-');
                                if (dateInId === dateString && newCoverSignups[signupId] === targetUser.id) {
                                    coverKeysToDelete.push(signupId);
                                }
                            }
                        });
                        // æ³¨æ„ï¼šcoverSignups æ˜¯ä¸€å±¤ç‰©ä»¶ï¼Œé€™è£¡ç”¨ delete æ˜¯å®‰å…¨çš„ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯æ›´æ–°æ•´å€‹ coverSignups ç‰©ä»¶
                        coverKeysToDelete.forEach(key => delete newCoverSignups[key]);
                        
                    } else if (this.FULLTIME_ROLES.includes(targetUser.role) || targetUser.role === "å¤–å ´æ«ƒæª¯") {
                        const vacationKey = `${targetUser.id}-${year}-${month}`;
                        const currentVac = newUserVacations[vacationKey] || [];
                        if (!currentVac.includes(dateString)) {
                            newUserVacations[vacationKey] = [...currentVac, dateString];
                        }
                    }
                }
                
                try {
                    await this.scheduleManager.updateMultiple({
                        manualAssignments: newManualAssignments,
                        userAvailability: newUserAvailability,
                        userVacations: newUserVacations,
                        coverSignups: newCoverSignups
                    });
                    
                    // é‡æ–°æ¸²æŸ“æœˆæ›†
                    if (this.authManager.getCurrentUserData()?.role === this.ADMIN_ROLE) {
                        if (this.currentCalendarView === 'inside') {
                            await this.renderFullCalendar();
                        } else {
                            await this.renderOutsideCalendar();
                        }
                    }
                    this.uiManager.showToast('æ‰‹å‹•æ’ç­å·²åˆªé™¤ï¼');
                } catch (error) {
                    console.error('æ‰€æœ‰æ¬„ä½æ›´æ–°å¤±æ•—:', error);
                    this.uiManager.showToast('æ›´æ–°è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            }

            // ä¸»æ¸²æŸ“é‚è¼¯ (ç„¡è®Šå‹•)
            renderAppView() {
                const currentUserData = this.authManager.getCurrentUserData();
                if(!currentUserData) return;
                
                if (currentUserData.role !== this.ADMIN_ROLE) {
                    this.uiManager.toggleSettingsButton(true);
                } else {
                    this.uiManager.toggleSettingsButton(false);
                }

                if (this.FULLTIME_ROLES.includes(currentUserData.role) || currentUserData.role === this.ADMIN_ROLE) {
                    this.uiManager.showCalendarView();
                    if (currentUserData.role === this.ADMIN_ROLE) {
                        this.uiManager.updateAppSubtitle("åœ˜éšŠæ’ç­ç¸½è¦½");
                        this.renderAdminView();
                    } else {
                        this.uiManager.updateAppSubtitle("è«‹åœ¨ä¸‹æ–¹æœˆæ›†é¸æ“‡æ‚¨çš„ä¼‘å‡æ—¥ã€‚");
                        this.renderFullTimeView();
                    }
                } else if (currentUserData.role === this.PART_TIMER_ROLE) {
                    this.uiManager.showCalendarView();
                    this.uiManager.updateAppSubtitle("è«‹å¾å·¦æ–¹åˆ—è¡¨é¸æ“‡æ‚¨è¦ä»£ç­çš„æ™‚æ®µã€‚");
                    this.renderPartTimerView();
                } else if (this.OUTSIDE_ROLES.includes(currentUserData.role)) {
                    this.uiManager.showCalendarView();
                    if (currentUserData.role === "å¤–å ´æ«ƒæª¯") {
                        this.uiManager.updateAppSubtitle("è«‹åœ¨ä¸‹æ–¹æœˆæ›†é¸æ“‡æ‚¨çš„ä¼‘å‡æ—¥ (æ¯æœˆæœ€å¤š5å¤©)ã€‚");
                    } else {
                        this.uiManager.updateAppSubtitle("è«‹åœ¨ä¸‹æ–¹æœˆæ›†æ¨™ç¤ºæ‚¨ä¸èƒ½ä¸Šç­çš„æ—¥å­ã€‚");
                    }
                    this.renderOutsideView();
                }
            }

            // å…§å ´å·¥è®€ç”Ÿè¦–åœ– (ç„¡è®Šå‹•)
            async renderPartTimerView() {
                // ... (code remains the same) ...
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], coverSignups = {} } = allData;
                
                let availableCoverShifts = [];
                const allUsers = this.scheduleManager.getAllUsers();
                const fullTimeUsers = allUsers.filter(u => this.FULLTIME_ROLES.includes(u.role));
                
                fullTimeUsers.forEach(user => {
                    const vacationKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[vacationKey] || [];
                    monthlyVacations.forEach(dateString => {
                        const vacationDate = new Date(...dateString.split('-').map((n, i) => i === 1 ? n - 1 : n));
                        if (vacationDate.getDay() === 4 || adminHolidays.includes(dateString)) return;

                        const slots = (user.role === 'å†…å ´å‚™èœç­') 
                            ? [{ key: 'AM', time: '10:00 - 14:00' }, { key: 'PM', time: '16:30 - 20:00' }]
                            : [{ key: 'AM', time: '10:30 - 14:00' }, { key: 'PM', time: '17:00 - 21:00' }];
                        
                        slots.forEach(slot => {
                            availableCoverShifts.push({
                                id: `cover-${user.id}-${dateString}-${slot.key}`,
                                date: dateString,
                                time: slot.time,
                                fullTimerName: user.username,
                                fullTimerRole: user.role,
                            });
                        });
                    });
                });
                
                availableCoverShifts.sort((a, b) => {
                    const roleOrder = { 'å†…å ´å‚™èœç­': 1, 'å†…å ´ç‚¸çˆç­': 2 };
                    if (roleOrder[a.fullTimerRole] !== roleOrder[b.fullTimerRole]) {
                        return roleOrder[a.fullTimerRole] - roleOrder[b.fullTimerRole];
                    }
                    return new Date(a.date) - new Date(b.date);
                });

                this.uiManager.calendarView.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8">
                        <div id="cover-shifts-panel" class="md:col-span-1 bg-gray-50 p-2 sm:p-4 rounded-lg h-fit">
                            <h3 class="font-bold text-lg mb-4 text-center">å¯ä»£ç­åˆ—è¡¨</h3>
                            <div id="cover-shifts-list" class="space-y-3 max-h-[50vh] md:max-h-[60vh] overflow-y-auto"></div>
                        </div>
                        <div class="md:col-span-2">
                            <div id="calendar-header" class="flex items-center justify-between mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                                <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                            </div>
                            <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                            </div>
                            <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                            <p class="text-center text-sm text-gray-500 mt-4">é»æ“Šæœˆæ›†æ—¥æœŸä¾†æ¨™ç¤ºæ‚¨çš„å¯ä¸Šç­æ™‚é–“ã€‚</p>
                        </div>
                    </div>
                `;

                const coverShiftsList = document.getElementById('cover-shifts-list');
                if (availableCoverShifts.length === 0) {
                    coverShiftsList.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆå°šç„¡ä»£ç­éœ€æ±‚ã€‚</p>`;
                } else {
                    availableCoverShifts.forEach(shift => {
                        const isSignedUpByCurrentUser = coverSignups[shift.id] === this.authManager.getCurrentUser().uid;
                        const isTakenByOther = coverSignups[shift.id] && !isSignedUpByCurrentUser;
                        const card = document.createElement('div');
                        card.className = 'bg-white p-3 rounded-md shadow-sm border-l-4';
                        
                        let buttonHtml;
                        if (isSignedUpByCurrentUser) {
                            card.classList.add('border-green-500');
                            buttonHtml = `<button data-id="${shift.id}" class="cancel-cover-btn w-full mt-2 text-sm bg-red-500 text-white py-1 rounded hover:bg-red-600">å–æ¶ˆä»£ç­</button>`;
                        } else if (isTakenByOther) {
                            card.classList.add('border-gray-300');
                            const taker = allUsers.find(u => u.id === coverSignups[shift.id]);
                            buttonHtml = `<div class="mt-2 text-sm text-center font-semibold bg-gray-200 text-gray-600 py-1 rounded">å·²è¢« ${taker ? taker.username : ''} é ç´„</div>`;
                        } else {
                            card.classList.add('border-indigo-500');
                            buttonHtml = `<button data-id="${shift.id}" class="signup-cover-btn w-full mt-2 text-sm bg-indigo-600 text-white py-1 rounded hover:bg-indigo-700">æˆ‘è¦ä»£ç­</button>`;
                        }

                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <p class="font-bold">${shift.date}</p>
                                <p class="text-sm font-semibold bg-gray-200 px-2 py-1 rounded">${shift.time}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">ä¼‘å‡äººå“¡: ${shift.fullTimerName} (${shift.fullTimerRole})</p>
                            ${buttonHtml}
                        `;
                        coverShiftsList.appendChild(card);
                    });
                }
                
                await this.renderFullCalendar();
            }
            
            // ç®¡ç†å“¡è¦–åœ– (ç„¡è®Šå‹•)
            async renderAdminView() {
                this.uiManager.calendarView.innerHTML = `
                    <div>
                        <div class="flex items-center justify-center mb-6">
                            <div class="bg-gray-100 rounded-lg p-1">
                                <button id="inside-calendar-btn" class="px-4 py-2 rounded-md bg-indigo-600 text-white font-semibold">å†…å ´æœˆæ›†</button>
                                <button id="outside-calendar-btn" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-200">å¤–å ´æœˆæ›†</button>
                            </div>
                        </div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                        <div id="admin-assignment-panel" class="mt-8 bg-indigo-50 border border-indigo-200 rounded-xl">
                            <button id="manual-assignment-toggle" class="w-full p-4 sm:p-6 text-left flex items-center justify-between hover:bg-indigo-100 transition-colors">
                                <h3 class="text-lg font-bold text-indigo-800">æ‰‹å‹•æ–°å¢æ’ç­</h3>
                                <span id="manual-assignment-icon" class="material-icons-outlined text-indigo-600 transition-transform">expand_more</span>
                            </button>
                            <div id="manual-assignment-content" class="hidden px-4 sm:px-6 pb-4 sm:pb-6">
                                <form id="manual-assignment-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                                    <input type="date" id="assignment-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <input type="text" id="assignment-user" placeholder="è¼¸å…¥å§“å" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <select id="assignment-role" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="" disabled selected>é¸æ“‡ç­åˆ¥</option>
                                    </select>
                                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">æ–°å¢</button>
                                </form>
                            </div>
                        </div>
                        <div id="user-management-panel" class="mt-4 bg-red-50 border border-red-200 rounded-xl">
                            <button id="user-management-toggle" class="w-full p-4 sm:p-6 text-left flex items-center justify-between hover:bg-red-100 transition-colors">
                                <h3 class="text-lg font-bold text-red-800">ç”¨æˆ¶ç®¡ç†</h3>
                                <span id="user-management-icon" class="material-icons-outlined text-red-600 transition-transform">expand_more</span>
                            </button>
                            <div id="user-management-content" class="hidden px-4 sm:px-6 pb-4 sm:pb-6">
                                <div class="mb-4">
                                    <h4 class="text-md font-semibold mb-3 text-red-800">å…§å ´å·¥è®€ç”Ÿ</h4>
                                    <div id="inside-workers-list" class="space-y-2">
                                        <!-- å…§å ´å·¥è®€ç”Ÿåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h4 class="text-md font-semibold mb-3 text-red-800">å¤–å ´å·¥è®€ç”Ÿ</h4>
                                    <div id="outside-workers-list" class="space-y-2">
                                        <!-- å¤–å ´å·¥è®€ç”Ÿåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="outside-schedule-panel" class="mt-4 bg-green-50 border border-green-200 rounded-xl">
                            <button id="outside-schedule-toggle" class="w-full p-4 sm:p-6 text-left flex items-center justify-between hover:bg-green-100 transition-colors">
                                <h3 class="text-lg font-bold text-green-800">å¤–å ´æ’ç­ç®¡ç†</h3>
                                <span id="outside-schedule-icon" class="material-icons-outlined text-green-600 transition-transform">expand_more</span>
                            </button>
                            <div id="outside-schedule-content" class="hidden px-4 sm:px-6 pb-4 sm:pb-6">
                                <div class="flex flex-col sm:flex-row gap-4 items-center mb-4">
                                    <button id="generate-outside-schedule-btn" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                                        ç”Ÿæˆå¤–å ´æ’ç­
                                    </button>
                                    <p class="text-sm text-green-700">æ ¹æ“šæ«ƒæª¯ä¼‘å‡å’Œå·¥è®€ç”Ÿä¸å¯ä¸Šç­æ—¥è‡ªå‹•æ’ç­</p>
                                </div>
                                <div id="worker-availability-panel" class="mt-4">
                                    <h4 class="text-md font-semibold mb-3 text-green-800">å·¥è®€ç”Ÿå¯ä¸Šæ«ƒæª¯</h4>
                                    <div id="worker-checkboxes" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                                        </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-center text-sm text-gray-500 mt-4">é»æ“Šæ—¥æœŸä»¥è¨­å®šæˆ–å–æ¶ˆè©²æ—¥ç‚ºå…¨é«”å…¬ä¼‘æ—¥ã€‚</p>
                    </div>
                `;
                
                // è¨­ç½®åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
                document.getElementById('inside-calendar-btn').addEventListener('click', () => {
                    this.currentCalendarView = 'inside';
                    this.updateCalendarToggleButtons(); // Will update dropdown
                    this.renderFullCalendar();
                });
                
                document.getElementById('outside-calendar-btn').addEventListener('click', () => {
                    this.currentCalendarView = 'outside';
                    this.updateCalendarToggleButtons(); // Will update dropdown
                    this.renderOutsideCalendar();
                });
                
                document.getElementById('generate-outside-schedule-btn').addEventListener('click', async () => {
                    // ä½¿ç”¨å°ç£ç•¶å‰çš„å¯¦éš›æ—¥æœŸï¼Œè€Œä¸æ˜¯æœˆæ›†é¡¯ç¤ºçš„æœˆä»½
                    const today = new Date();
                    const currentDay = today.getDate();
                    const currentMonth = today.getMonth() + 1; // 1-12
                    const currentYear = today.getFullYear();
                    
                    let targetYear, targetMonth;
                    
                    if (currentDay >= 25) {
                        // 25è™Ÿä¹‹å¾Œï¼šæ’ä¸‹å€‹æœˆ1-15è™Ÿ
                        targetMonth = currentMonth === 12 ? 1 : currentMonth + 1;
                        targetYear = currentMonth === 12 ? currentYear + 1 : currentYear;
                        await this.generateOutsideSchedule(targetYear, targetMonth, 1, 15);
                        this.uiManager.showToast(`å·²æ’${targetYear}å¹´${targetMonth}æœˆ1-15è™Ÿçš„ç­è¡¨`);
                    } else if (currentDay >= 10) {
                        // 10è™Ÿä¹‹å¾Œï¼šæ’æœ¬æœˆ16-31è™Ÿ
                        targetYear = currentYear;
                        targetMonth = currentMonth;
                        await this.generateOutsideSchedule(targetYear, targetMonth, 16);
                        this.uiManager.showToast(`å·²æ’${targetYear}å¹´${targetMonth}æœˆ16-31è™Ÿçš„ç­è¡¨`);
                    } else {
                        // 10è™Ÿå‰ï¼šæ’æ•´å€‹æœˆ
                        targetYear = currentYear;
                        targetMonth = currentMonth;
                        await this.generateOutsideSchedule(targetYear, targetMonth);
                        this.uiManager.showToast(`å·²æ’${targetYear}å¹´${targetMonth}æœˆæ•´æœˆçš„ç­è¡¨`);
                    }
                    
                    // åˆ‡æ›æœˆæ›†åˆ°æ’å¥½ç­çš„æœˆä»½
                    this.calendarManager.setCalendarDate(new Date(targetYear, targetMonth - 1, 1));
                    
                    // åˆ‡æ›åˆ°å¤–å ´æœˆæ›†è¦–åœ–ä¸¦æ›´æ–°æŒ‰éˆ•æ¨£å¼
                    this.currentCalendarView = 'outside';
                    this.updateCalendarToggleButtons();
                    this.renderOutsideCalendar();
                });
                
                // ç”¨æˆ¶ç®¡ç†é¢æ¿æŠ˜å /å±•å¼€
                document.getElementById('user-management-toggle').addEventListener('click', () => {
                    const content = document.getElementById('user-management-content');
                    const icon = document.getElementById('user-management-icon');
                    
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.classList.add('hidden');
                        icon.textContent = 'expand_more';
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // å¤–å ´æ’ç­ç®¡ç†é¢æ¿æŠ˜å /å±•å¼€
                document.getElementById('outside-schedule-toggle').addEventListener('click', () => {
                    const content = document.getElementById('outside-schedule-content');
                    const icon = document.getElementById('outside-schedule-icon');
                    
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.classList.add('hidden');
                        icon.textContent = 'expand_more';
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // æ‰‹å‹•æ–°å¢æ’ç­é¢æ¿æŠ˜å /å±•å¼€
                document.getElementById('manual-assignment-toggle').addEventListener('click', () => {
                    const content = document.getElementById('manual-assignment-content');
                    const icon = document.getElementById('manual-assignment-icon');
                    
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.classList.add('hidden');
                        icon.textContent = 'expand_more';
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // åˆå§‹åŒ–ç‚ºå…§å ´æœˆæ›†
                this.currentCalendarView = 'inside';
                this.updateCalendarToggleButtons(); // Initial dropdown population
                await this.renderFullCalendar();
                
                // ç”Ÿæˆå·¥è®€ç”Ÿå‹¾é¸æ¡†
                this.generateWorkerCheckboxes();
                
                // ç”Ÿæˆç”¨æˆ¶ç®¡ç†åˆ—è¡¨
                this.generateUserManagementLists();
            }

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼ + æ›´æ–°ä¸‹æ‹‰é¸å–® (ç„¡è®Šå‹•)
            updateCalendarToggleButtons() {
                const insideBtn = document.getElementById('inside-calendar-btn');
                const outsideBtn = document.getElementById('outside-calendar-btn');
                const assignmentRoleSelect = document.getElementById('assignment-role');
            const outsideSchedulePanel = document.getElementById('outside-schedule-panel');
                
                // Clear existing options except the first disabled one
                assignmentRoleSelect.innerHTML = '<option value="" disabled selected>é¸æ“‡ç­åˆ¥</option>';

                let shiftsToAdd = [];
                if (this.currentCalendarView === 'inside') {
                    insideBtn.className = 'px-4 py-2 rounded-md bg-indigo-600 text-white font-semibold';
                    outsideBtn.className = 'px-4 py-2 rounded-md text-gray-600 hover:bg-gray-200';
                    shiftsToAdd = this.insideShifts; // Use inside shifts
                // ç®¡ç†è€…è™•æ–¼å…§å ´æœˆæ›†æ™‚ï¼Œéš±è—å¤–å ´æ’ç­ç®¡ç†
                if (outsideSchedulePanel) outsideSchedulePanel.classList.add('hidden');
                } else {
                    insideBtn.className = 'px-4 py-2 rounded-md text-gray-600 hover:bg-gray-200';
                    outsideBtn.className = 'px-4 py-2 rounded-md bg-indigo-600 text-white font-semibold';
                    shiftsToAdd = this.outsideShifts; // Use outside shifts
                // ç®¡ç†è€…è™•æ–¼å¤–å ´æœˆæ›†æ™‚ï¼Œé¡¯ç¤ºå¤–å ´æ’ç­ç®¡ç†
                if (outsideSchedulePanel) outsideSchedulePanel.classList.remove('hidden');
                }

                // Add new options
                shiftsToAdd.forEach(shift => {
                    // è·³éæœªæ¨™è¨˜çš„ã€Œæ”¶ç­ã€ï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“æœ‰ã€Œæ”¶ç­ï¼ˆå…§å ´ï¼‰ã€æˆ–ã€Œæ”¶ç­ï¼ˆå¤–å ´ï¼‰ã€äº†
                    if (shift === 'æ”¶ç­') {
                        return; // è·³éï¼Œé¿å…é‡è¤‡
                    }
                    
                    const option = document.createElement('option');
                    option.value = shift;
                    option.textContent = shift;
                    assignmentRoleSelect.appendChild(option);
                });

            // åŒæ­¥æ›´æ–°ç”¨æˆ¶ç®¡ç†åˆ—è¡¨çš„å¯è¦‹å€å¡Šï¼ˆåªé¡¯ç¤ºç•¶å‰è¦–åœ–å°æ‡‰çš„äººå“¡ï¼‰
            if (typeof this.generateUserManagementLists === 'function') {
                this.generateUserManagementLists();
            }
            }

            // ç”Ÿæˆå·¥è®€ç”Ÿå‹¾é¸æ¡† (ç„¡è®Šå‹•)
            generateWorkerCheckboxes() {
                // ... (code remains the same) ...
                const workerCheckboxesContainer = document.getElementById('worker-checkboxes');
                if (!workerCheckboxesContainer) return;
                
                const allUsers = this.scheduleManager.getAllUsers();
                const outsideWorkers = allUsers.filter(u => u.role === "å¤–å ´å·¥è®€ç”Ÿ");
                
                workerCheckboxesContainer.innerHTML = '';
                
                outsideWorkers.forEach(worker => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center space-x-2 p-2 bg-white rounded border';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `worker-${worker.id}`;
                    checkbox.className = 'rounded border-gray-300 text-green-600 focus:ring-green-500';
                    checkbox.checked = true; // é è¨­ç‚ºå¯ä¸Šç­
                    
                    const label = document.createElement('label');
                    label.htmlFor = `worker-${worker.id}`;
                    label.className = 'text-sm font-medium text-gray-700';
                    label.textContent = worker.username;
                    
                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    workerCheckboxesContainer.appendChild(checkboxDiv);
                });
            }

            // ç”Ÿæˆç”¨æˆ¶ç®¡ç†åˆ—è¡¨
            generateUserManagementLists() {
                const allUsers = this.scheduleManager.getAllUsers();
                const insideWorkers = allUsers.filter(u => u.role === "å†…å ´å·¥è®€ç”Ÿ");
                const outsideWorkers = allUsers.filter(u => u.role === "å¤–å ´å·¥è®€ç”Ÿ");
                
                // ç”Ÿæˆå…§å ´å·¥è®€ç”Ÿåˆ—è¡¨
                const insideWorkersList = document.getElementById('inside-workers-list');
                const insideSection = insideWorkersList ? insideWorkersList.parentElement : null;
                if (insideWorkersList) {
                    insideWorkersList.innerHTML = '';
                    if (insideWorkers.length === 0) {
                        insideWorkersList.innerHTML = '<p class="text-gray-500 text-sm">æš«ç„¡å…§å ´å·¥è®€ç”Ÿ</p>';
                    } else {
                        insideWorkers.forEach(worker => {
                            const workerDiv = document.createElement('div');
                            workerDiv.className = 'flex items-center justify-between p-3 bg-white rounded border';
                            workerDiv.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <span class="material-icons-outlined text-gray-600">person</span>
                                    <div>
                                        <p class="font-semibold text-gray-800">${worker.username}</p>
                                        <p class="text-sm text-gray-500">${worker.role}</p>
                                    </div>
                                </div>
                                <button class="delete-user-btn px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600" 
                                        data-user-id="${worker.id}" 
                                        data-username="${worker.username}" 
                                        data-role="${worker.role}">
                                    åˆªé™¤
                                </button>
                            `;
                            insideWorkersList.appendChild(workerDiv);
                        });
                    }
                }
                
                // ç”Ÿæˆå¤–å ´å·¥è®€ç”Ÿåˆ—è¡¨
                const outsideWorkersList = document.getElementById('outside-workers-list');
                const outsideSection = outsideWorkersList ? outsideWorkersList.parentElement : null;
                if (outsideWorkersList) {
                    outsideWorkersList.innerHTML = '';
                    if (outsideWorkers.length === 0) {
                        outsideWorkersList.innerHTML = '<p class="text-gray-500 text-sm">æš«ç„¡å¤–å ´å·¥è®€ç”Ÿ</p>';
                    } else {
                        outsideWorkers.forEach(worker => {
                            const workerDiv = document.createElement('div');
                            workerDiv.className = 'flex items-center justify-between p-3 bg-white rounded border';
                            workerDiv.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <span class="material-icons-outlined text-gray-600">person</span>
                                    <div>
                                        <p class="font-semibold text-gray-800">${worker.username}</p>
                                        <p class="text-sm text-gray-500">${worker.role}</p>
                                    </div>
                                </div>
                                <button class="delete-user-btn px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600" 
                                        data-user-id="${worker.id}" 
                                        data-username="${worker.username}" 
                                        data-role="${worker.role}">
                                    åˆªé™¤
                                </button>
                            `;
                            outsideWorkersList.appendChild(workerDiv);
                        });
                    }
                }

                // æ ¹æ“šç›®å‰æœˆæ›†è¦–åœ–åªé¡¯ç¤ºå°æ‡‰å€å¡Š
                if (this.currentCalendarView === 'inside') {
                    if (insideSection) insideSection.classList.remove('hidden');
                    if (outsideSection) outsideSection.classList.add('hidden');
                } else {
                    if (insideSection) insideSection.classList.add('hidden');
                    if (outsideSection) outsideSection.classList.remove('hidden');
                }
            }

            // æ­£è·äººå“¡è¦–åœ– (ç„¡è®Šå‹•)
            async renderFullTimeView() {
                // ... (code remains the same) ...
                this.uiManager.calendarView.innerHTML = `
                    <div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                        <p class="text-center text-sm text-gray-500 mt-4"></p>
                    </div>
                `;
                 const instructions = this.uiManager.calendarView.querySelector('p');
                 instructions.textContent = "è«‹é»æ“Šæ—¥æœŸé¸æ“‡æ‚¨çš„ä¼‘å‡æ—¥ (æ¯æœˆæœ€å¤š5å¤©)ã€‚"; // Simplified for non-admin
                 await this.renderFullCalendar();
            }

            // å¤–å ´äººå“¡è¦–åœ– (ç„¡è®Šå‹•)
            async renderOutsideView() {
                // ... (code remains the same) ...
                const currentUserData = this.authManager.getCurrentUserData();
                const isWorker = currentUserData.role === "å¤–å ´å·¥è®€ç”Ÿ";
                
                 this.uiManager.calendarView.innerHTML = `
                    <div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                        <p class="text-center text-sm text-gray-500 mt-4"></p>
                        ${isWorker ? `
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h3 class="text-center font-bold text-blue-900 mb-3">ğŸ“‹ ç­æ¬¡æ™‚é–“è¡¨</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-purple-700">æ—©æ«ƒ</span>
                                    <span class="text-gray-700">10:30 - 14:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-purple-700">æ™šæ«ƒ</span>
                                    <span class="text-gray-700">16:40 - 21:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-blue-700">æ—©ç­</span>
                                    <span class="text-gray-700">11:30 - 14:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-orange-700">æ´—ç¢—</span>
                                    <span class="text-gray-700">17:30 - 20:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-green-700">æ”¶ç­</span>
                                    <span class="text-gray-700">18:00 - 22:00</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                const instructions = this.uiManager.calendarView.querySelector('p');
                if (currentUserData.role === "å¤–å ´æ«ƒæª¯") {
                    instructions.textContent = "è«‹é»æ“Šæ—¥æœŸé¸æ“‡æ‚¨çš„ä¼‘å‡æ—¥ (æ¯æœˆæœ€å¤š5å¤©)ã€‚";
                } else {
                    instructions.textContent = "è«‹é»æ“Šæ—¥æœŸæ¨™ç¤ºæ‚¨ä¸èƒ½ä¸Šç­çš„æ—¥å­ / é»æ“Šå·²æ’ç­æ—¥æœŸæ‰¾äººä»£ç­ã€‚"; // Updated instruction
                }
                
                await this.renderOutsideCalendar();
            }

            // æ¸²æŸ“å…§å ´å®Œæ•´æœˆæ›† (å„ªåŒ–ç‰ˆ)
            async renderFullCalendar() {
                perfMonitor.start('renderFullCalendar');
                this.calendarManager.getCalendarDate().setDate(1);
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                
                document.getElementById('calendar-month-year').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const holidays = await this.calendarManager.fetchHolidays(year);
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], coverSignups = {}, userAvailability = {}, manualAssignments = {} } = allData;

                const dailySchedule = {};
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dailySchedule[dateString] = [];
                }

                const allUsers = this.scheduleManager.getAllUsers();
                allUsers.filter(u => this.FULLTIME_ROLES.includes(u.role)).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[userMonthKey] || [];
                    for (let i = 1; i <= lastDayOfMonth; i++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        if (!monthlyVacations.includes(dateString)) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    }
                });

                Object.keys(coverSignups).forEach(coverId => {
                    const parts = coverId.split('-');
                    if (parts.length < 5) return;
                    const dateString = parts.slice(parts.length - 4, parts.length - 1).join('-');
                    const timeSlot = parts[parts.length - 1];
                    const date = new Date(dateString);

                    if (date.getFullYear() === year && date.getMonth() === month) {
                         const ptUserId = coverSignups[coverId];
                         const ptUser = allUsers.find(u => u.id === ptUserId);
                         const fullTimerId = parts.slice(1, parts.length - 4).join('-');
                         const originalFullTimer = allUsers.find(u => u.id === fullTimerId);

                         if(ptUser && originalFullTimer) {
                            dailySchedule[dateString].push({ username: ptUser.username, role: originalFullTimer.role, isCover: true, timeSlot });
                         }
                    }
                });
                
                allUsers.filter(u => u.role === this.PART_TIMER_ROLE).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyAvailability = userAvailability[userMonthKey] || [];
                    monthlyAvailability.forEach(dateString => {
                        const alreadyScheduled = dailySchedule[dateString].some(s => s.username === user.username);
                        if (!alreadyScheduled) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    });
                });

                // --- Render Manual Assignments ---
                Object.keys(manualAssignments).forEach(dateString => {
                    const assignments = manualAssignments[dateString] || [];
                    // Ensure assignments is always an array
                    const assignmentsArray = Array.isArray(assignments) ? assignments : Object.values(assignments);

                    if (dailySchedule[dateString] && assignmentsArray.length > 0) {
                         assignmentsArray.forEach(assignment => {
                            // Check if this shift belongs to the inside view
                            const assignedShift = assignment.assignedShift;
                            
                            // å…§å ´æœˆæ›†ï¼šåªé¡¯ç¤ºå…§å ´çš„æ”¶ç­ï¼Œä¸é¡¯ç¤ºå¤–å ´çš„æ”¶ç­
                            if (assignedShift === 'æ”¶ç­ï¼ˆå¤–å ´ï¼‰') {
                                return; // è·³éå¤–å ´çš„æ”¶ç­
                            }
                            
                            if (this.insideShifts.includes(assignedShift)) {
                                let role = '';
                                let timeSlot = 'FullDay';

                                if (assignedShift.includes('å‚™èœç­')) role = 'å†…å ´å‚™èœç­';
                                else if (assignedShift.includes('ç‚¸çˆç­')) role = 'å†…å ´ç‚¸çˆç­';
                                else if (assignedShift === 'æ”¶ç­' || assignedShift === 'æ”¶ç­ï¼ˆå…§å ´ï¼‰') role = 'å†…å ´å·¥è®€ç”Ÿ';

                                if (assignedShift.includes('æ—©')) timeSlot = 'AM';
                                else if (assignedShift.includes('æ™š')) timeSlot = 'PM';

                                dailySchedule[dateString].push({ 
                                    username: assignment.username, 
                                    role: role, 
                                    isCover: true, // Treat as cover for simplicity in logic
                                    timeSlot: timeSlot,
                                    isManual: true,
                                    assignedShift: assignment.assignedShift
                                });
                            }
                        });
                    }
                });
                // --- End Render Manual Assignments ---


                const calendarGrid = document.getElementById('calendar-grid');
                
                // === å„ªåŒ– 1.5: ä½¿ç”¨ DocumentFragment æ‰¹é‡ DOM æ“ä½œ (å…§å ´æœˆæ›†) ===
                const fragment = document.createDocumentFragment();
                
                const firstDayIndex = this.calendarManager.getCalendarDate().getDay();
                const prevLastDay = new Date(year, month, 0).getDate();
                
                // æ·»åŠ ä¸Šå€‹æœˆçš„æ—¥æœŸä½”ä½
                for (let i = firstDayIndex; i > 0; i--) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'p-1 sm:p-2 text-center text-gray-300 no-hover';
                    emptyDay.textContent = prevLastDay - i + 1;
                    fragment.appendChild(emptyDay);
                }

                const todayString = new Date().toISOString().split('T')[0];
                const currentUserData = this.authManager.getCurrentUserData();
                
                // === å„ªåŒ–: é å…ˆè¨ˆç®— adminHolidays Set åŠ é€ŸæŸ¥æ‰¾ ===
                const adminHolidaysSet = new Set(adminHolidays);

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = formatDateString(year, month + 1, i); // ä½¿ç”¨å¿«å–çš„æ—¥æœŸæ ¼å¼åŒ–
                    const day = document.createElement('div');
                    const isThursday = new Date(year, month, i).getDay() === 4;
                    const holidayName = holidays.get(dateString);
                    const isAdminHoliday = adminHolidaysSet.has(dateString);

                    day.className = `calendar-day p-1 rounded-lg text-left text-[10px] sm:text-xs`;
                    day.dataset.date = dateString;

                    if (isThursday || isAdminHoliday) {
                        day.classList.add('bg-red-100');
                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800">${i}</span></div><div class="flex-grow flex items-center justify-center"><p class="font-bold text-red-700 text-xs sm:text-sm">å…¬ä¼‘æ—¥</p></div>`;
                        if (currentUserData.role === this.ADMIN_ROLE && !isThursday) day.classList.add('cursor-pointer'); 
                    } else {
                        // ======================================================
                        // === (MODIFIED) Inside Shift Shortage Check (Orange BG) ===
                        // ======================================================
                        const workingUsers = dailySchedule[dateString] || [];
                        let isShortage = false;

                        // Helper function to check for AM/PM/FullDay presence
                        const hasShift = (role, time) => {
                            // 'role' will be 'å†…å ´å‚™èœç­' or 'å†…å ´ç‚¸çˆç­'
                            
                            if (time === 'FullDay') {
                                return workingUsers.some(w => 
                                    (w.role === role && w.timeSlot === 'FullDay' && !w.isCover) || // Full-timer
                                    (w.isManual && w.assignedShift === `${role.replace('å†…å ´', '')} (å…¨æ—¥)`) // *** FIX *** e.g., 'å‚™èœç­ (å…¨æ—¥)'
                                );
                            }
                            if (time === 'AM') {
                                return workingUsers.some(w => 
                                    (w.role === role && w.isCover && w.timeSlot === 'AM' && !w.isManual) || // PT Cover (from vacation)
                                    (w.isManual && w.assignedShift === `${role.replace('å†…å ´', '')} (æ—©)`) // *** FIX *** e.g., 'å‚™èœç­ (æ—©)'
                                );
                            }
                            if (time === 'PM') {
                                return workingUsers.some(w => 
                                    (w.role === role && w.isCover && w.timeSlot === 'PM' && !w.isManual) || // PT Cover (from vacation)
                                    (w.isManual && w.assignedShift === `${role.replace('å†…å ´', '')} (æ™š)`) // *** FIX *** e.g., 'å‚™èœç­ (æ™š)'
                                );
                            }
                            return false;
                        };
                        
                        // 1. Check å‚™èœç­
                        const isBekaiCovered = hasShift('å†…å ´å‚™èœç­', 'FullDay') || (hasShift('å†…å ´å‚™èœç­', 'AM') && hasShift('å†…å ´å‚™èœç­', 'PM'));
                        
                        // 2. Check ç‚¸çˆç­
                        const isJaluCovered = hasShift('å†…å ´ç‚¸çˆç­', 'FullDay') || (hasShift('å†…å ´ç‚¸çˆç­', 'AM') && hasShift('å†…å ´ç‚¸çˆç­', 'PM'));

                        // 3. Check æ”¶ç­ (PT availability or manual)
                        const isShoubanCovered = workingUsers.some(w => 
                            (w.role === this.PART_TIMER_ROLE && w.timeSlot === 'FullDay' && !w.isCover) || // From userAvailability
                            (w.isManual && (w.assignedShift === 'æ”¶ç­' || w.assignedShift === 'æ”¶ç­ï¼ˆå…§å ´ï¼‰')) // Manual 'æ”¶ç­' or 'æ”¶ç­ï¼ˆå…§å ´ï¼‰'
                        );
                        
                        if (!(isBekaiCovered && isJaluCovered && isShoubanCovered)) {
                            isShortage = true;
                        }

                        if (isShortage) {
                            day.classList.add('bg-orange-100');
                        } else if (holidayName) {
                            day.classList.add('bg-yellow-100');
                        }
                        // ===============================================
                        // === (END) Modified Inside Shift Shortage Check ===
                        // ===============================================
                        
                        // Make clickable for relevant roles
                        if (this.FULLTIME_ROLES.includes(currentUserData.role) || currentUserData.role === this.PART_TIMER_ROLE || currentUserData.role === this.ADMIN_ROLE) {
                            day.classList.add('cursor-pointer');
                        }

                        // const workingUsers = dailySchedule[dateString] || []; // (Moved up)
                        let usersHtml = '<div class="flex-grow"></div>';
                        if (workingUsers.length > 0) {
                            // Sort logic remains the same for inside view
                             const getSortOrder = (workInfo) => {
                                const { role, isCover, timeSlot, isManual, assignedShift } = workInfo;
                                
                                // Handle manual shifts first
                                if (isManual) {
                                    if (assignedShift.includes('å‚™èœç­ (æ—©)')) return 1;
                                    if (assignedShift.includes('å‚™èœç­ (æ™š)')) return 2;
                                    if (assignedShift.includes('å‚™èœç­ (å…¨æ—¥)')) return 3;
                                    if (assignedShift.includes('ç‚¸çˆç­ (æ—©)')) return 4;
                                    if (assignedShift.includes('ç‚¸çˆç­ (æ™š)')) return 5;
                                    if (assignedShift.includes('ç‚¸çˆç­ (å…¨æ—¥)')) return 6;
                                    if (assignedShift === 'æ”¶ç­' || assignedShift === 'æ”¶ç­ï¼ˆå…§å ´ï¼‰') return 7;
                                }

                                // Handle non-manual shifts
                                if (role === 'å†…å ´å‚™èœç­') {
                                    if (isCover) return timeSlot === 'AM' ? 1 : 2; // PT Cover
                                    return 3; // Full-timer
                                }
                                if (role === 'å†…å ´ç‚¸çˆç­') {
                                    if (isCover) return timeSlot === 'AM' ? 4 : 5; // PT Cover
                                    return 6; // Full-timer
                                }
                                if (role === this.PART_TIMER_ROLE) {
                                    return 7; // æ”¶ (from availability)
                                }
                                return 99;
                            };
                            workingUsers.sort((a, b) => getSortOrder(a) - getSortOrder(b));

                            const userListHtml = workingUsers.map(workInfo => {
                                const { username, role, isCover, timeSlot, isManual, assignedShift } = workInfo; // Added assignedShift
                                let displayLabel = '';
                                let colorClass = '';
                                
                                const originalUser = allUsers.find(u => u.username === username);
                                const userRole = originalUser ? originalUser.role : (role === this.PART_TIMER_ROLE ? this.PART_TIMER_ROLE : null);

                                if (userRole === this.PART_TIMER_ROLE || isManual) {
                                     if (isManual) { // Handle manual assignment labels
                                        if (assignedShift === 'å‚™èœç­ (æ—©)') displayLabel = '(æ—©å‚™)';
                                        else if (assignedShift === 'å‚™èœç­ (æ™š)') displayLabel = '(æ™šå‚™)';
                                        else if (assignedShift === 'å‚™èœç­ (å…¨æ—¥)') displayLabel = '(å‚™)';
                                        else if (assignedShift === 'ç‚¸çˆç­ (æ—©)') displayLabel = '(æ—©ç‚¸)';
                                        else if (assignedShift === 'ç‚¸çˆç­ (æ™š)') displayLabel = '(æ™šç‚¸)';
                                        else if (assignedShift === 'ç‚¸çˆç­ (å…¨æ—¥)') displayLabel = '(ç‚¸)';
                                        else if (assignedShift === 'æ”¶ç­' || assignedShift === 'æ”¶ç­ï¼ˆå…§å ´ï¼‰') displayLabel = '(æ”¶)';
                                    } else if (isCover) { // Handle cover shift labels
                                        if (role === 'å†…å ´å‚™èœç­') displayLabel = `(${timeSlot === 'AM' ? 'æ—©å‚™' : 'æ™šå‚™'})`;
                                        else if (role === 'å†…å ´ç‚¸çˆç­') displayLabel = `(${timeSlot === 'AM' ? 'æ—©ç‚¸' : 'æ™šç‚¸'})`;
                                    } else { // Handle regular part-timer shift (from availability)
                                        displayLabel = '(æ”¶)';
                                    }
                                } else { // Handle full-time regular shift
                                    if (role === 'å†…å ´å‚™èœç­') displayLabel = '(å‚™)';
                                    else if (role === 'å†…å ´ç‚¸çˆç­') displayLabel = '(ç‚¸)';
                                }
                                
                                // Assign color based on the final determined role/shift
                                if (displayLabel.includes('å‚™')) colorClass = 'font-semibold text-green-800';
                                else if (displayLabel.includes('ç‚¸')) colorClass = 'font-semibold text-amber-800';
                                else if (displayLabel.includes('æ”¶')) colorClass = 'font-semibold text-blue-800';
                                else colorClass = 'text-gray-800'; // Default color
                                
                                const deleteButtonHtml = (currentUserData.role === this.ADMIN_ROLE && isManual)
                                    ? `<button data-date="${dateString}" data-username="${username}" data-shift="${assignedShift || ''}" class="delete-manual-assignment-btn text-red-400 hover:text-red-700 font-bold">&times;</button>`
                                    : '';

                                return `<div class="flex items-center justify-between w-full">
                                            <span class="${colorClass}">${username}${displayLabel}</span>
                                            ${deleteButtonHtml}
                                        </div>`;

                            }).join('');
                            usersHtml = `<div class="mt-1 text-gray-600 leading-tight overflow-hidden">${userListHtml}</div>`;
                        }
                        
                        let selfStatusHtml = '';
                        if (currentUserData.role === this.ADMIN_ROLE) {
                            if(!holidayName && !isShortage) day.classList.add('bg-gray-50'); // (MODIFIED)
                        } else if (this.FULLTIME_ROLES.includes(currentUserData.role)) {
                            const vacationKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const isVacation = (userVacations[vacationKey] || []).includes(dateString);
                            if (isVacation) {
                                day.classList.add('bg-red-100', 'border', 'border-red-400');
                                selfStatusHtml = `<p class="font-semibold text-red-700">ä¼‘å‡</p>`;
                            } else {
                                if(!holidayName && !isShortage) day.classList.add('bg-green-100'); // (MODIFIED)
                                day.classList.add('border', 'border-green-400');
                                selfStatusHtml = `<p class="font-semibold text-green-700">ä¸Šç­æ—¥</p>`;
                            }
                        } else if (currentUserData.role === this.PART_TIMER_ROLE) {
                            const availabilityKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const isAvailable = (userAvailability[availabilityKey] || []).includes(dateString);
                            const isWorkingCoverShift = workingUsers.some(w => w.username === currentUserData.username && w.isCover && !w.isManual);
                            const isWorkingManual = workingUsers.some(w => w.username === currentUserData.username && w.isManual);
                            const isWorkingAvailability = workingUsers.some(w => w.username === currentUserData.username && w.role === this.PART_TIMER_ROLE && !w.isCover && !w.isManual);


                            if (isWorkingCoverShift || isWorkingManual || isWorkingAvailability) { // If working (any type)
                                if(!holidayName && !isShortage) day.classList.add('bg-blue-100'); // (MODIFIED)
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="font-bold text-blue-700">ä¸Šç­</p>`;
                            } else if (isAvailable) { // Available but not assigned cover/manual
                                if(!holidayName && !isShortage) day.classList.add('bg-blue-100'); // (MODIFIED)
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="font-semibold text-blue-700">è¦ä¸Šç­</p>`; // Still marked as "è¦ä¸Šç­"
                            } else { // Not available
                                if(!holidayName && !isShortage) day.classList.add('bg-white'); // (MODIFIED)
                                selfStatusHtml = `<p class="text-gray-400">ä¼‘æ¯</p>`;
                            }
                        }

                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800 text-xs sm:text-sm">${i}</span>${holidayName ? `<p class="text-[9px] sm:text-[11px] font-bold text-yellow-800">${holidayName}</p>` : ''}${selfStatusHtml}</div>${usersHtml}`;
                    }
                    
                    if (dateString === todayString) day.classList.add('today');
                    fragment.appendChild(day); // æ·»åŠ åˆ° fragment è€Œéç›´æ¥æ“ä½œ DOM
                }
                
                // === å„ªåŒ– 1.5: ä¸€æ¬¡æ€§æ›´æ–° DOM ===
                calendarGrid.innerHTML = '';
                calendarGrid.appendChild(fragment);
                perfMonitor.end('renderFullCalendar');
            }

            // æ¸²æŸ“å¤–å ´æœˆæ›† (å„ªåŒ–ç‰ˆ)
            async renderOutsideCalendar() {
                perfMonitor.start('renderOutsideCalendar');
                this.calendarManager.getCalendarDate().setDate(1);
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                
                document.getElementById('calendar-month-year').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const holidays = await this.calendarManager.fetchHolidays(year);
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], userAvailability = {}, outsideSchedule = {}, manualAssignments = {}, userVacationTimes = {} } = allData; 

                const dailySchedule = {};
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dailySchedule[dateString] = [];
                }

                // --- Render Auto-Generated Outside Schedule ---
                Object.keys(outsideSchedule).forEach(dateString => {
                    const assignments = outsideSchedule[dateString] || [];
                     const assignmentsArray = Array.isArray(assignments) ? assignments : Object.values(assignments);
                    if (dailySchedule[dateString] && assignmentsArray.length > 0) {
                        assignmentsArray.forEach(assignment => {
                            dailySchedule[dateString].push({
                                username: assignment.username,
                                role: assignment.role, // "å¤–å ´å·¥è®€ç”Ÿ"
                                shift: assignment.shift, // "æ—©ç­", "æ´—ç¢—", etc.
                                isManual: false // Mark as not manual
                            });
                        });
                    }
                });
                
                // --- Render Manual Assignments (for Outside) ---
                 Object.keys(manualAssignments).forEach(dateString => {
                    const assignments = manualAssignments[dateString] || [];
                    const assignmentsArray = Array.isArray(assignments) ? assignments : Object.values(assignments);

                    if (dailySchedule[dateString] && assignmentsArray.length > 0) {
                         assignmentsArray.forEach(assignment => {
                            // Check if this shift belongs to the outside view
                            const assignedShift = assignment.assignedShift;
                            
                            // å¤–å ´æœˆæ›†ï¼šåªé¡¯ç¤ºå¤–å ´çš„æ”¶ç­ï¼Œä¸é¡¯ç¤ºå…§å ´çš„æ”¶ç­
                            if (assignedShift === 'æ”¶ç­ï¼ˆå…§å ´ï¼‰') {
                                return; // è·³éå…§å ´çš„æ”¶ç­
                            }
                            
                            if (this.outsideShifts.includes(assignedShift)) {
                                let role = "å¤–å ´å·¥è®€ç”Ÿ"; // Default
                                if (assignedShift === "æ«ƒæª¯") {
                                    role = "å¤–å ´æ«ƒæª¯";
                                }
                                
                                dailySchedule[dateString].push({ 
                                    username: assignment.username, 
                                    role: role, 
                                    shift: assignedShift, // Use the assigned shift directly
                                    isManual: true // Mark as manual
                                });
                            }
                        });
                    }
                });
                // --- End Render Manual Assignments ---

                // æ·»åŠ æ«ƒæª¯äººå“¡çš„æ­£å¸¸ä¸Šç­ï¼ˆéä¼‘å‡æ—¥æœŸï¼‰
                const allUsers = this.scheduleManager.getAllUsers();
                const counterStaff = allUsers.filter(u => u.role === "å¤–å ´æ«ƒæª¯");
                
                counterStaff.forEach(staff => {
                    const vacationKey = `${staff.id}-${year}-${month + 1}`;
                    const monthlyVacations = userVacations[vacationKey] || [];
                    
                    for (let i = 1; i <= lastDayOfMonth; i++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        const date = new Date(year, month, i);
                        const dayOfWeek = date.getDay();
                        
                        // Skip Thursday, vacation days, AND if already manually assigned as "æ«ƒæª¯"
                        const isManuallyAssignedCounter = dailySchedule[dateString]?.some(s => s.isManual && s.role === "å¤–å ´æ«ƒæª¯" && s.username === staff.username);
                        if (dayOfWeek === 4 || monthlyVacations.includes(dateString) || isManuallyAssignedCounter) continue;
                        
                        // Check if ANY counter is scheduled (auto or manual)
                        const hasCounter = dailySchedule[dateString]?.some(s => s.role === "å¤–å ´æ«ƒæª¯" || s.shift === "æ«ƒæª¯");
                        if (!hasCounter) {
                            dailySchedule[dateString].push({
                                username: staff.username,
                                role: "å¤–å ´æ«ƒæª¯",
                                shift: "æ«ƒæª¯", // Standard shift for non-vacation counter staff
                                isManual: false
                            });
                        }
                    }
                });

                const calendarGrid = document.getElementById('calendar-grid');
                
                // === å„ªåŒ– 1.5: ä½¿ç”¨ DocumentFragment æ‰¹é‡ DOM æ“ä½œ (å¤–å ´æœˆæ›†) ===
                const fragment = document.createDocumentFragment();
                
                const firstDayIndex = this.calendarManager.getCalendarDate().getDay();
                const prevLastDay = new Date(year, month, 0).getDate();
                
                // æ·»åŠ ä¸Šå€‹æœˆçš„æ—¥æœŸä½”ä½
                for (let i = firstDayIndex; i > 0; i--) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'p-1 sm:p-2 text-center text-gray-300 no-hover';
                    emptyDay.textContent = prevLastDay - i + 1;
                    fragment.appendChild(emptyDay);
                }

                const todayString = new Date().toISOString().split('T')[0];
                const currentUserData = this.authManager.getCurrentUserData();
                
                // === å„ªåŒ–: é å…ˆè¨ˆç®— adminHolidays Set åŠ é€ŸæŸ¥æ‰¾ ===
                const adminHolidaysSet = new Set(adminHolidays);

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = formatDateString(year, month + 1, i); // ä½¿ç”¨å¿«å–çš„æ—¥æœŸæ ¼å¼åŒ–
                    const day = document.createElement('div');
                    const isThursday = new Date(year, month, i).getDay() === 4;
                    const holidayName = holidays.get(dateString);
                    const isAdminHoliday = adminHolidaysSet.has(dateString);

                    day.className = `calendar-day p-1 rounded-lg text-left text-[10px] sm:text-xs`;
                    day.dataset.date = dateString;

                    if (isThursday || isAdminHoliday) {
                        day.classList.add('bg-red-100');
                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800">${i}</span></div><div class="flex-grow flex items-center justify-center"><p class="font-bold text-red-700 text-xs sm:text-sm">å…¬ä¼‘æ—¥</p></div>`;
                        // Admins can still click non-Thursday holidays
                        if (currentUserData.role === this.ADMIN_ROLE && !isThursday) day.classList.add('cursor-pointer');
                    } else {
                        // ===============================================
                        // === (NEW) Shift Shortage Check (Orange BG) ===
                        // ===============================================
                        const date = new Date(year, month, i);
                        const dayOfWeek = date.getDay();
                        const workingUsers = dailySchedule[dateString] || [];
                        const numShifts = workingUsers.length;

                        let isCounterVacation = false;
                        for (const staff of counterStaff) { // counterStaff is defined above this loop
                            const vacationKey = `${staff.id}-${year}-${month + 1}`;
                            const monthlyVacations = userVacations[vacationKey] || [];
                            if (monthlyVacations.includes(dateString)) {
                                isCounterVacation = true;
                                break;
                            }
                        }
                        
                        let isShortage = false;
                        if (isCounterVacation) {
                            // æ«ƒæª¯ä¼‘å‡: å¹³æ—¥æ‡‰æœ‰ 4 ç­ã€å‡æ—¥æ‡‰æœ‰ 5 ç­
                            if (dayOfWeek === 0 || dayOfWeek === 6) {
                                // é€±æœ«: æ‡‰æœ‰ 5 ç­ (æ—©æ«ƒ, æ—©ç­, æ™šæ«ƒ, æ´—ç¢—, æ”¶ç­)
                                if (numShifts < 5) { isShortage = true; }
                            } else {
                                // å¹³æ—¥: æ‡‰æœ‰ 4 ç­ (æ—©æ«ƒ, æ™šæ«ƒ, æ´—ç¢—, æ”¶ç­)
                                if (numShifts < 4) { isShortage = true; }
                            }
                        } else {
                            // æ«ƒæª¯æœªä¼‘å‡
                            if (dayOfWeek === 0 || dayOfWeek === 6) { 
                                // é€±æœ«: æ‡‰æœ‰ 4 ç­ (æ«ƒæª¯, æ—©ç­, æ”¶ç­, æ´—ç¢—)
                                if (numShifts < 4) { isShortage = true; }
                            } else { 
                                // å¹³æ—¥: æ‡‰æœ‰ 3 ç­ (æ«ƒæª¯, æ”¶ç­, æ´—ç¢—)
                                if (numShifts < 3) { isShortage = true; }
                            }
                        }

                        if (isShortage) {
                            day.classList.add('bg-orange-100');
                        } else if (holidayName) {
                            day.classList.add('bg-yellow-100');
                        }
                        // ===============================================
                        // === (END) New Shift Shortage Check ===
                        // ===============================================
                        
                        if (this.OUTSIDE_ROLES.includes(currentUserData.role) || currentUserData.role === this.ADMIN_ROLE) { // Admins should also be able to click
                            day.classList.add('cursor-pointer');
                        }

                        // const workingUsers = dailySchedule[dateString] || []; // (Moved up)
                        let usersHtml = '<div class="flex-grow"></div>';
                        if (workingUsers.length > 0) {
                            
                            // Sort Order for Outside View
                            const getSortOrder = (workInfo) => {
                                const { role, shift } = workInfo;
                                if (role === "å¤–å ´æ«ƒæª¯" || shift === "æ«ƒæª¯") return 1;
                                switch (shift) {
                                    case "æ—©æ«ƒ": return 2;
                                    case "æ—©ç­": return 3;
                                    case "æ™šæ«ƒ": return 4;
                                    case "æ´—ç¢—": return 5;
                                    case "æ”¶ç­":
                                    case "æ”¶ç­ï¼ˆå¤–å ´ï¼‰": return 6;
                                }
                                return 99; // Other/Unknown
                            };
                            workingUsers.sort((a, b) => getSortOrder(a) - getSortOrder(b));
                            
                            const userListHtml = workingUsers.map(workInfo => {
                                const { username, role, shift, isManual } = workInfo; // Added isManual
                                let displayLabel = '';
                                let colorClass = '';
                                
                                // Determine label and color based on shift
                                switch(shift) {
                                    case "æ«ƒæª¯":
                                        displayLabel = '(æ«ƒ)';
                                        colorClass = 'font-semibold text-purple-800';
                                        break;
                                    case "æ—©æ«ƒ":
                                        displayLabel = '(æ—©æ«ƒ)';
                                        colorClass = 'font-semibold text-purple-600';
                                        break;
                                     case "æ™šæ«ƒ":
                                        displayLabel = '(æ™šæ«ƒ)';
                                        colorClass = 'font-semibold text-purple-600';
                                        break;
                                    case "æ—©ç­":
                                        displayLabel = '(æ—©)';
                                        colorClass = 'font-semibold text-blue-800';
                                        break;
                                    case "æ”¶ç­":
                                    case "æ”¶ç­ï¼ˆå¤–å ´ï¼‰":
                                        displayLabel = '(æ”¶)';
                                        colorClass = 'font-semibold text-green-800';
                                        break;
                                    case "æ´—ç¢—":
                                        displayLabel = '(æ´—)';
                                        colorClass = 'font-semibold text-orange-800';
                                        break;
                                    default: // Fallback if shift name is unexpected
                                        displayLabel = `(${shift})`;
                                        colorClass = 'text-gray-800';
                                }

                                const deleteButtonHtml = (currentUserData.role === this.ADMIN_ROLE && isManual)
                                    ? `<button data-date="${dateString}" data-username="${username}" data-shift="${shift || ''}" class="delete-manual-assignment-btn text-red-400 hover:text-red-700 font-bold">&times;</button>`
                                    : '';

                                return `<div class="flex items-center justify-between w-full">
                                            <span class="${colorClass}">${username}${displayLabel}</span>
                                            ${deleteButtonHtml}
                                        </div>`;
                            }).join('');
                            usersHtml = `<div class="mt-1 text-gray-600 leading-tight overflow-hidden">${userListHtml}</div>`;
                        }
                        
                        let selfStatusHtml = '';
                         if (currentUserData.role === this.ADMIN_ROLE) {
                             if(!holidayName && !isShortage) day.classList.add('bg-gray-50'); // (MODIFIED) Keep admin background neutral
                         } else if (currentUserData.role === "å¤–å ´æ«ƒæª¯") {
                            const vacationKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const isVacation = (userVacations[vacationKey] || []).includes(dateString);
                            if (isVacation) {
                                day.classList.add('bg-red-100', 'border', 'border-red-400');
                                selfStatusHtml = `<p class="font-semibold text-red-700">ä¼‘å‡</p>`;
                            } else {
                                if(!holidayName && !isShortage) day.classList.add('bg-green-100'); // (MODIFIED)
                                day.classList.add('border', 'border-green-400');
                                selfStatusHtml = `<p class="font-semibold text-green-700">ä¸Šç­æ—¥</p>`;
                            }
                        } else if (currentUserData.role === "å¤–å ´å·¥è®€ç”Ÿ") {
                            const monthNumber = month + 1;
                            const availabilityKey = `${currentUserData.uid}-${year}-${monthNumber}`;
                            const vacationTimeKey = `${currentUserData.uid}-${year}-${monthNumber}`;
                            const legacyVacationTimeKey = `${currentUserData.uid}-${year}-${String(monthNumber).padStart(2, '0')}`;
                            const isUnavailable = (userAvailability[availabilityKey] || []).includes(dateString);
                            const vacationData = userVacationTimes[vacationTimeKey]?.[dateString] 
                                || userVacationTimes[legacyVacationTimeKey]?.[dateString];
                            const isWorking = workingUsers.some(w => w.username === currentUserData.username);

                            if (isWorking) { // Check if working first
                                if(!holidayName && !isShortage) day.classList.add('bg-blue-100'); // (MODIFIED)
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="font-semibold text-blue-700">ä¸Šç­</p>`;
                            } else if (isUnavailable) { // Then check if unavailable (old system)
                                if(!holidayName && !isShortage) day.classList.add('bg-red-100'); // (MODIFIED)
                                day.classList.add('border', 'border-red-400');
                                selfStatusHtml = `<p class="font-semibold text-red-700">ä¸ä¸Šç­</p>`;
                            } else if (vacationData) { // Check new vacation time system
                                if (vacationData.morning && vacationData.evening) {
                                    // å…¨å¤©ä¼‘å‡
                                    if(!holidayName && !isShortage) day.classList.add('bg-red-100');
                                    day.classList.add('border', 'border-red-400');
                                    selfStatusHtml = `<p class="font-semibold text-red-700">å…¨å¤©ä¼‘å‡</p>`;
                                } else if (vacationData.morning) {
                                    // æ—©ä¸Šä¼‘å‡
                                    if(!holidayName && !isShortage) day.classList.add('bg-orange-100');
                                    day.classList.add('border', 'border-orange-400');
                                    selfStatusHtml = `<p class="font-semibold text-orange-700">æ—©ä¸Šä¼‘å‡</p>`;
                                } else if (vacationData.evening) {
                                    // æ™šä¸Šä¼‘å‡
                                    if(!holidayName && !isShortage) day.classList.add('bg-yellow-100');
                                    day.classList.add('border', 'border-yellow-400');
                                    selfStatusHtml = `<p class="font-semibold text-yellow-700">æ™šä¸Šä¼‘å‡</p>`;
                                } else {
                                    // å¯ä»¥å·¥ä½œ
                                    if(!holidayName && !isShortage) day.classList.add('bg-white');
                                    selfStatusHtml = `<p class="text-gray-400">å¾…æ’ç­</p>`;
                                }
                            } else { // Otherwise, available but not scheduled
                                if(!holidayName && !isShortage) day.classList.add('bg-white'); // (MODIFIED)
                                selfStatusHtml = `<p class="text-gray-400">å¾…æ’ç­</p>`;
                            }
                        }

                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800 text-xs sm:text-sm">${i}</span>${holidayName ? `<p class="text-[9px] sm:text-[11px] font-bold text-yellow-800">${holidayName}</p>` : ''}${selfStatusHtml}</div>${usersHtml}`;
                    }
                    
                    if (dateString === todayString) day.classList.add('today');
                    fragment.appendChild(day); // æ·»åŠ åˆ° fragment è€Œéç›´æ¥æ“ä½œ DOM
                }
                
                // === å„ªåŒ– 1.5: ä¸€æ¬¡æ€§æ›´æ–° DOM ===
                calendarGrid.innerHTML = '';
                calendarGrid.appendChild(fragment);
                perfMonitor.end('renderOutsideCalendar');
            }
            
            // äº‹ä»¶ç›£è½å™¨ (å„ªåŒ–ç‰ˆ)
            setupEventListeners() {
                this.uiManager.showRegisterBtn.addEventListener('click', (e) => { 
                    e.preventDefault(); this.uiManager.showRegisterForm(); 
                });
                this.uiManager.showLoginBtn.addEventListener('click', (e) => { 
                    e.preventDefault(); this.uiManager.showLoginForm(); 
                });
                
                this.uiManager.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                this.uiManager.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.uiManager.logoutBtn.addEventListener('click', () => this.handleLogout());

                // Settings Modal Listeners
                this.uiManager.settingsBtn.addEventListener('click', () => {
                    this.uiManager.showSettingsModal();
                    const newUsernameInput = document.getElementById('new-username');
                    if(newUsernameInput && this.authManager.getCurrentUserData()) {
                        newUsernameInput.value = this.authManager.getCurrentUserData().username;
                    }
                });
                this.uiManager.closeSettingsBtn.addEventListener('click', () => this.uiManager.hideSettingsModal());
                this.uiManager.changePasswordForm.addEventListener('submit', (e) => this.handleChangePassword(e));
                this.uiManager.changeUsernameForm.addEventListener('submit', (e) => this.handleChangeUsername(e));

                // Shift Select Modal Listeners
                this.uiManager.closeShiftSelectBtn.addEventListener('click', () => this.uiManager.hideShiftSelectModal());
                this.uiManager.shiftSelectOptions.addEventListener('click', (e) => {
                    const button = e.target.closest('.shift-select-btn');
                    if (button) {
                        this.handleShiftSelect(button.dataset.date, button.dataset.shift);
                    }
                });
                
                // Cover Shift (Replacement) Modal Listeners
                this.uiManager.closeCoverShiftBtn.addEventListener('click', () => this.uiManager.hideCoverShiftModal());
                this.uiManager.coverShiftForm.addEventListener('submit', (e) => this.handleAssignCoverShift(e));
                
                // Vacation Time Modal Listeners
                this.uiManager.closeVacationTimeBtn.addEventListener('click', () => this.uiManager.hideVacationTimeModal());
                this.uiManager.cancelVacationTimeBtn.addEventListener('click', () => this.uiManager.hideVacationTimeModal());
                this.uiManager.confirmVacationTimeBtn.addEventListener('click', () => this.handleVacationTimeConfirm());
                
                // Delete User Modal Listeners
                this.uiManager.closeDeleteUserBtn.addEventListener('click', () => this.uiManager.hideDeleteUserModal());
                this.uiManager.cancelDeleteUserBtn.addEventListener('click', () => this.uiManager.hideDeleteUserModal());
                this.uiManager.confirmDeleteUserBtn.addEventListener('click', () => this.handleDeleteUser());
                
                // Calendar View Event Delegation
                this.uiManager.calendarView.addEventListener('click', async (e) => {
                    // --- Button specific actions first ---
                    if (e.target.closest('.delete-user-btn')) {
                        e.stopPropagation();
                        const btn = e.target.closest('.delete-user-btn');
                        this.handleDeleteUserClick(btn.dataset.userId, btn.dataset.username, btn.dataset.role);
                        return;
                    }
                    if (e.target.closest('.delete-manual-assignment-btn')) {
                        e.stopPropagation();
                        const btn = e.target.closest('.delete-manual-assignment-btn');
                        await this.handleDeleteManualAssignment(btn.dataset.date, btn.dataset.username, btn.dataset.shift);
                        return;
                    }
                    if (e.target.closest('.signup-cover-btn') || e.target.closest('.cancel-cover-btn')) { // Inside PT cover
                        await this.handleCoverShiftAction(e);
                        return;
                    }
                    if (e.target.closest('#prev-month-btn')) {
                        this.calendarManager.previousMonth();
                        if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                             this.currentCalendarView === 'inside' ? this.renderFullCalendar() : this.renderOutsideCalendar();
                        } else { this.renderAppView(); }
                        return;
                    }
                    if (e.target.closest('#next-month-btn')) {
                        this.calendarManager.nextMonth();
                         if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                             this.currentCalendarView === 'inside' ? this.renderFullCalendar() : this.renderOutsideCalendar();
                        } else { this.renderAppView(); }
                        return;
                    }
                    // --- Fallback to day click ---
                    if (e.target.closest('.calendar-day')) {
                        await this.handleDayClick(e);
                        return;
                    }
                });
                
                // Manual Assignment Form Submission
                this.uiManager.calendarView.addEventListener('submit', async (e) => {
                    if (e.target.id === 'manual-assignment-form') {
                       await this.handleManualAssignment(e);
                    }
                });
            }

            // ç™»å…¥ç‹€æ…‹ç›£è½ (å„ªåŒ– 4.3: åŠ å…¥é˜²æŠ–)
            setupAuthStateListener() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.scheduleManager.cleanupListeners(); // Clean up listeners on auth state change
                    this.clearCalendarCache(); // æ¸…é™¤å¿«å–
                    
                    if (user) {
                        this.authManager.setCurrentUser(user);
                        const userData = await this.authManager.getUserData(user);
                        
                        if (userData) {
                            this.authManager.setCurrentUserData(userData);
                            this.uiManager.updateUserInfo(userData.username, userData.role);
                            
                            this.uiManager.showAppView();
                            
                            // === å„ªåŒ– 4.3: ä½¿ç”¨é˜²æŠ–çš„è³‡æ–™è®Šæ›´å›èª¿ ===
                            // é˜²æ­¢çŸ­æ™‚é–“å…§å¤šæ¬¡è³‡æ–™è®Šæ›´å°è‡´é‡è¤‡æ¸²æŸ“
                            const debouncedRender = debounce(() => {
                                // Prevent re-render if modals are open
                                if(!this.uiManager.settingsModal.classList.contains('hidden')) return;
                                if(!this.uiManager.shiftSelectModal.classList.contains('hidden')) return;
                                if(!this.uiManager.coverShiftModal.classList.contains('hidden')) return;
                                if(!this.uiManager.vacationTimeModal.classList.contains('hidden')) return;
                                if(!this.uiManager.deleteUserModal.classList.contains('hidden')) return;
                                
                                // æª¢æŸ¥è³‡æ–™æ˜¯å¦çœŸçš„æœ‰è®Šæ›´
                                const allData = this.scheduleManager.getAllData();
                                const newHash = this.calculateDataHash(allData);
                                
                                if (this.calendarCache.dataHash !== newHash) {
                                    this.calendarCache.dataHash = newHash;
                                    this.clearCalendarCache(); // è³‡æ–™è®Šæ›´æ™‚æ¸…é™¤å¿«å–
                                    this.renderAppView();
                                    console.log('ğŸ“… æœˆæ›†å·²æ›´æ–° (è³‡æ–™è®Šæ›´)');
                                }
                            }, 150); // 150ms é˜²æŠ–å»¶é²
                            
                            this.scheduleManager.setOnDataChangeCallback(debouncedRender);
                            
                            this.scheduleManager.setupRealtimeListeners();
                            // Initial render after setup
                            this.renderAppView();
                        } else {
                            console.error("User data not found in Firestore!");
                            this.handleLogout(); // Log out if user exists in Auth but not Firestore
                        }
                    } else {
                        this.authManager.setCurrentUser(null);
                        this.authManager.setCurrentUserData(null);
                        this.uiManager.showAuthView();
                    }
                });
            }
        }

        // ===================================================================================
        // === åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ===
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // éš±è—è¼‰å…¥ç•«é¢
            const hideLoadingScreen = () => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 300);
                }
            };
            
            // å»¶é²ä¸€å°æ®µæ™‚é–“ç¢ºä¿ Firebase åˆå§‹åŒ–å®Œæˆ
            setTimeout(hideLoadingScreen, 500);
            
            new ScheduleApp();
        });

    </script>
</body>
</html>
