<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>韓泰泰排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }
        .material-icons-outlined {
            font-size: 1.25rem;
        }
        /* 滾動條美化 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 避免 Tailwind CSS JIT 編譯器移除動態 class */
        .bg-blue-100, .bg-green-100, .bg-yellow-100, .bg-indigo-100, .bg-pink-100, .bg-purple-100, .bg-gray-100, .bg-orange-100 {}
        .text-blue-800, .text-green-800, .text-yellow-800, .text-indigo-800, .text-pink-800, .text-purple-800, .text-gray-800, .text-amber-800, .text-orange-800 {} /* Added text-orange-800 */
        .border-blue-400, .border-green-400, .border-yellow-400, .border-indigo-400, .border-pink-400, .border-purple-400, .border-gray-400 {}
        .hidden { display: none; }
        
        /* 月曆樣式 */
        .calendar-day {
            transition: all 0.2s ease-in-out;
            min-height: 6rem; /* 調整手機上的最小高度 */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        @media (min-width: 640px) {
            .calendar-day {
                min-height: 7rem;
            }
        }
        .calendar-day.cursor-pointer:not(.no-hover):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .today {
            box-shadow: inset 0 0 0 2px #4f46e5;
        }
        .custom-calendar-grid {
            display: grid;
            /* 日     一     二     三     四     五     六 */
            grid-template-columns: 1.15fr 1.15fr 1.15fr 1.15fr 0.5fr 1.15fr 1.15fr;
        }
        
        /* Modal Style */
        #cover-shift-modal.hidden,
        #shift-select-modal.hidden {
            display: none;
        }
        #cover-shift-modal:not(.hidden),
        #shift-select-modal:not(.hidden) {
            display: flex;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center">登入系統</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <input type="text" id="login-username" placeholder="用戶名稱" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="login-password" placeholder="密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">登入</button>
                    <p class="text-center text-sm">還沒有帳號？ <a href="#" id="show-register" class="font-medium text-indigo-600 hover:underline">立即註冊</a></p>
                </form>
            </div>
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center">註冊新帳號</h2>
                <form id="register-form" class="mt-8 space-y-6">
                    <input type="text" id="register-username" placeholder="用戶名稱 (登入用)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password" placeholder="密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password-confirm" placeholder="確認密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <div>
                        <label for="register-role" class="block text-sm font-medium text-gray-700 sr-only">選擇您的職位</label>
                        <select id="register-role" required class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>請選擇您的職位</option>
                            <option value="内場工讀生">内場工讀生</option>
                            <option value="外場工讀生">外場工讀生</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">註冊</button>
                    <p class="text-center text-sm">已經有帳號了？ <a href="#" id="show-login" class="font-medium text-indigo-600 hover:underline">返回登入</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-center text-red-500 text-sm mt-4"></p>
        </div>
    </div>
    
    <div id="app" class="hidden min-h-screen p-1 sm:p-4 md:p-8">
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-2 sm:p-6 md:p-8">
            
            <header class="mb-6 md:mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span class="material-icons-outlined text-2xl md:text-3xl text-indigo-600">event_available</span>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">韓泰泰排班系統</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-xs sm:text-sm text-gray-600">使用者: <span id="userName" class="font-semibold bg-gray-100 p-1 rounded"></span> (<span id="userRole" class="font-semibold"></span>)</p>
                        <button id="settings-btn" class="hidden items-center gap-1 text-sm text-gray-600 hover:text-indigo-600">
                            <span class="material-icons-outlined">settings</span>
                            <span class="hidden sm:inline">個人設定</span>
                        </button>
                        <button id="logout-btn" class="flex items-center gap-1 text-sm text-red-500 hover:text-red-700">
                            <span class="material-icons-outlined">logout</span>
                            <span class="hidden sm:inline">登出</span>
                        </button>
                    </div>
                </div>
                <p id="app-subtitle" class="mt-2 text-gray-500 text-sm md:text-base">一個讓團隊合作更順暢的排班解決方案。</p>
            </header>

            <main>
                <div id="standard-view">
                    </div>

                <div id="calendar-view" class="hidden">
                    </div>
            </main>
        </div>

        <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">個人設定</h2>
                    <button id="close-settings-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-8">
                    <form id="change-username-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">修改顯示名稱</h3>
                        <input type="text" id="new-username" placeholder="新的顯示名稱" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">更新名稱</button>
                        <p id="username-settings-error" class="text-center text-red-500 text-sm mt-2"></p>
                    </form>
                    <hr>
                    <form id="change-password-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">修改密碼</h3>
                        <input type="password" id="new-password" placeholder="新密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <input type="password" id="confirm-new-password" placeholder="確認新密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">更新密碼</button>
                        <p id="password-settings-error" class="text-center text-red-500 text-sm mt-2"></p>
                    </form>
                </div>
            </div>
        </div>

        <div id="shift-select-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">選擇班次</h2>
                    <button id="close-shift-select-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <p id="shift-select-info" class="text-gray-700 mb-4">您在這天有多個班次，請選擇要找人代班的班次：</p>
                <div id="shift-select-options" class="space-y-3">
                    </div>
            </div>
        </div>

        <div id="cover-shift-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">指定代班</h2>
                    <button id="close-cover-shift-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <form id="cover-shift-form">
                    <p id="cover-shift-info" class="text-center text-gray-700 mb-4">
                        </p>
                    <div class="space-y-4">
                        <label for="cover-shift-replacement-select" class="block text-sm font-medium text-gray-700">請選擇代班人員：</label>
                        <select id="cover-shift-replacement-select" required class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>選擇一位外場工讀生</option>
                            </select>
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">確認換班</button>
                    </div>
                </form>
            </div>
        </div>


        <div id="vacation-time-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-600">選擇休假時間</h2>
                    <button id="close-vacation-time-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-4">
                    <p id="vacation-time-info" class="text-gray-700">請選擇您要休假的時間段：</p>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="vacation-morning" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">早上休假</span>
                                <p class="text-sm text-gray-500">勾選表示早上休假，不勾選表示可以排早櫃、早班</p>
                            </div>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="vacation-evening" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">晚上休假</span>
                                <p class="text-sm text-gray-500">勾選表示晚上休假，不勾選表示可以排晚櫃、晚班、洗碗、收班</p>
                            </div>
                        </label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button id="confirm-vacation-time-btn" class="flex-1 p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                            確認
                        </button>
                        <button id="cancel-vacation-time-btn" class="flex-1 p-3 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="delete-user-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-red-600">確認刪除用戶</h2>
                    <button id="close-delete-user-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-4">
                    <p id="delete-user-info" class="text-gray-700">您確定要刪除這個用戶嗎？</p>
                    <p class="text-sm text-red-600 font-semibold">警告：此操作將永久刪除用戶及其所有相關數據，包括：</p>
                    <ul class="text-sm text-gray-600 list-disc list-inside ml-4">
                        <li>用戶帳號</li>
                        <li>所有排班記錄</li>
                        <li>休假記錄</li>
                        <li>代班記錄</li>
                    </ul>
                    <div class="flex gap-3 pt-4">
                        <button id="confirm-delete-user-btn" class="flex-1 p-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
                            確認刪除
                        </button>
                        <button id="cancel-delete-user-btn" class="flex-1 p-3 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-8 right-8 bg-gray-900 text-white py-3 px-6 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-500 ease-in-out">
            <p id="toast-message"></p>
        </div>
    </div>

    <script type="module">
        // Firebase v9+ modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            writeBatch,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===================================================================================
        // === 認證管理類別 (AuthManager) ===
        // ===================================================================================
        class AuthManager {
            constructor(auth, db) {
                this.auth = auth;
                this.db = db;
                this.currentUser = null;
                this.currentUserData = null;
            }

            async register(username, password, passwordConfirm, role) {
                if (!username || !password || !role || !passwordConfirm) {
                    throw new Error('所有欄位皆為必填。');
                }
                if (password.length < 6) {
                    throw new Error('密碼長度至少需要6位數。');
                }
                if (password !== passwordConfirm) {
                    throw new Error('兩次輸入的密碼不一致。');
                }
                
                const q = query(collection(this.db, "users"), where("username_lowercase", "==", username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    throw new Error('此用戶名稱已被使用。');
                }
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(this.auth, `${username.toLowerCase()}@schedule-app.com`, password);
                    const user = userCredential.user;
                    await setDoc(doc(this.db, "users", user.uid), {
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        role: role
                    });
                } catch (error) {
                    console.error("Register error:", error);
                    throw new Error("註冊失敗，請稍後再試。");
                }
            }

            async login(username, password) {
                try {
                    await signInWithEmailAndPassword(this.auth, `${username.trim().toLowerCase()}@schedule-app.com`, password);
                } catch (error) {
                    console.error("Login error:", error);
                    throw new Error("用戶名稱或密碼錯誤。");
                }
            }

            async logout() {
                await signOut(this.auth);
            }

            async changePassword(newPassword, confirmNewPassword) {
                if (newPassword.length < 6) {
                    throw new Error('新密碼長度至少需要6位數。');
                }
                if (newPassword !== confirmNewPassword) {
                    throw new Error('兩次輸入的新密碼不一致。');
                }

                try {
                    await updatePassword(this.currentUser, newPassword);
                } catch (error) {
                    console.error("Password change error:", error);
                    throw new Error('密碼更新失敗。這可能是因為您登入時間過久，請先登出再重新登入一次後再試。');
                }
            }

            async changeUsername(newUsername) {
                if (!newUsername) {
                    throw new Error('姓名不能為空。');
                }
                if (newUsername === this.currentUserData.username) {
                    throw new Error('新舊名稱相同。');
                }

                const q = query(collection(this.db, "users"), where("username_lowercase", "==", newUsername.toLowerCase()));
                const querySnapshot = await getDocs(q);
                
                let isTaken = false;
                querySnapshot.forEach(doc => {
                    if (doc.id !== this.currentUser.uid) {
                        isTaken = true;
                    }
                });

                if (isTaken) {
                    throw new Error('此名稱已被其他使用者占用。');
                }

                try {
                    const userDocRef = doc(this.db, "users", this.currentUser.uid);
                    await setDoc(userDocRef, {
                        username: newUsername,
                        username_lowercase: newUsername.toLowerCase()
                    }, { merge: true });
                } catch (error) {
                    console.error("Username change error:", error);
                    throw new Error('名稱更新失敗，請稍後再試。');
                }
            }

            async getUserData(user) {
                if (!user) return null;
                
                const userDocRef = doc(this.db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    return { uid: user.uid, ...userDocSnap.data() };
                }
                return null;
            }

            setCurrentUser(user) {
                this.currentUser = user;
            }

            setCurrentUserData(userData) {
                this.currentUserData = userData;
            }

            getCurrentUser() {
                return this.currentUser;
            }

            getCurrentUserData() {
                return this.currentUserData;
            }
        }

        // ===================================================================================
        // === 月曆管理類別 (CalendarManager) ===
        // ===================================================================================
        class CalendarManager {
            constructor() {
                this.calendarDate = new Date();
                this.holidaysCache = {};
            }

            async fetchHolidays(year) {
                if (this.holidaysCache[year]) {
                    return this.holidaysCache[year];
                }

                // 台灣國定假日備用資料
                const fallbackHolidays = {
                    2024: new Map([
                        ['2024-01-01', '中華民國開國紀念日'], ['2024-02-08', '農曆除夕'], ['2024-02-09', '農曆春節'],
                        ['2024-02-10', '農曆春節'], ['2024-02-11', '農曆春節'], ['2024-02-12', '農曆春節'],
                        ['2024-02-13', '農曆春節'], ['2024-02-14', '農曆春節'], ['2024-02-28', '和平紀念日'],
                        ['2024-04-04', '兒童節'], ['2024-04-05', '清明節'], ['2024-05-01', '勞動節'],
                        ['2024-06-10', '端午節'], ['2024-09-17', '中秋節'], ['2024-10-10', '國慶日']
                    ]),
                    2025: new Map([
                        ['2025-01-01', '中華民國開國紀念日'], ['2025-01-28', '農曆除夕'], ['2025-01-29', '農曆春節'],
                        ['2025-01-30', '農曆春節'], ['2025-01-31', '農曆春節'], ['2025-02-28', '和平紀念日'],
                        ['2025-04-04', '兒童節'], ['2025-04-05', '清明節'], ['2025-05-01', '勞動節'],
                        ['2025-05-31', '端午節'], ['2025-10-06', '中秋節'], ['2025-10-10', '國慶日'],['2025-10-24', '光復節補假'],['2025-12-25', '行憲紀念日']
                    ]),
                    2026: new Map([
                        ['2026-01-01', '中華民國開國紀念日'], ['2026-01-28', '農曆除夕'], ['2026-01-29', '農曆春節'],
                        ['2026-01-30', '農曆春節'], ['2026-01-31', '農曆春節'], ['2026-02-28', '和平紀念日'],
                        ['2026-04-04', '兒童節'], ['2026-04-05', '清明節'], ['2026-05-01', '勞動節'],
                        ['2026-05-20', '端午節'], ['2026-09-25', '中秋節'], ['2026-10-10', '國慶日']
                    ])
                };

                // 嘗試多個API來源
                const apiUrls = [
                    `https://cdn.jsdelivr.net/gh/g0v/tw-holiday@master/data/${year}.json`,
                    `https://raw.githubusercontent.com/g0v/tw-holiday/master/data/${year}.json`,
                    `https://holidays.moes.tw/api/holidays/${year}`
                ];

                for (const url of apiUrls) {
                    try {
                        console.log(`嘗試從 ${url} 獲取 ${year} 年假日資料...`);
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            },
                            timeout: 5000 // 5秒超時
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const holidaysMap = new Map();
                            
                            // 處理不同API格式
                            if (data.holidays && Array.isArray(data.holidays)) {
                                data.holidays.forEach(holiday => {
                                    if (holiday.isHoliday) { 
                                       holidaysMap.set(holiday.date, holiday.name);
                                    }
                                });
                            } else if (Array.isArray(data)) {
                                data.forEach(holiday => {
                                    if (holiday.isHoliday) { 
                                       holidaysMap.set(holiday.date, holiday.name);
                                    }
                                });
                            }
                            
                            if (holidaysMap.size > 0) {
                                console.log(`成功從 ${url} 獲取 ${year} 年假日資料，共 ${holidaysMap.size} 個假日`);
                                this.holidaysCache[year] = holidaysMap;
                                return holidaysMap;
                            }
                        }
                    } catch (error) {
                        console.warn(`從 ${url} 獲取假日資料失敗:`, error.message);
                        continue;
                    }
                }

                // 如果所有API都失敗，使用備用資料
                if (fallbackHolidays[year]) {
                    console.warn(`無法從網路獲取 ${year} 年的假日資訊，使用內建的備用資料。`);
                    this.holidaysCache[year] = fallbackHolidays[year];
                    return this.holidaysCache[year];
                } else {
                    console.warn(`沒有 ${year} 年的備用假日資料，返回空資料。`);
                    this.holidaysCache[year] = new Map();
                    return this.holidaysCache[year];
                }
            }

            getCalendarDate() {
                return this.calendarDate;
            }

            setCalendarDate(date) {
                this.calendarDate = date;
            }

            getMonth() {
                return this.calendarDate.getMonth();
            }

            getYear() {
                return this.calendarDate.getFullYear();
            }

            previousMonth() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() - 1);
            }

            nextMonth() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() + 1);
            }
        }

        // ===================================================================================
        // === 排班管理類別 (ScheduleManager) ===
        // ===================================================================================
        class ScheduleManager {
            constructor(db) {
                this.db = db;
                this.allData = {};
                this.allUsers = [];
                this.unsubscribeListeners = [];
                this.onDataChangeCallback = null;
            }

            setOnDataChangeCallback(callback) {
                this.onDataChangeCallback = callback;
            }

            setupRealtimeListeners() {
                const dataDocRef = doc(this.db, "scheduleData", "main");
                const usersColRef = collection(this.db, "users");

                const unsubData = onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.allData = docSnap.data();
                    } else {
                        // Initialize data if it doesn't exist
                        setDoc(doc(this.db, "scheduleData", "main"), {
                            userVacations: {},
                            userAvailability: {},
                            coverSignups: {},
                            adminHolidays: [],
                            manualAssignments: {},
                            outsideSchedule: {}
                        });
                    }
                    // 觸發重新渲染
                    if (this.onDataChangeCallback) {
                        this.onDataChangeCallback();
                    }
                });

                const unsubUsers = onSnapshot(query(collection(this.db, "users")), (snapshot) => {
                    this.allUsers = [];
                    snapshot.forEach(doc => this.allUsers.push({ id: doc.id, ...doc.data() }));
                    // 觸發重新渲染
                    if (this.onDataChangeCallback) {
                        this.onDataChangeCallback();
                    }
                });
                
                this.unsubscribeListeners.push(unsubData, unsubUsers);
            }

            cleanupListeners() {
                this.unsubscribeListeners.forEach(unsub => unsub());
                this.unsubscribeListeners = [];
            }

            getAllData() {
                return this.allData;
            }

            getAllUsers() {
                return this.allUsers;
            }

            async updateUserVacation(userId, year, month, vacations) {
                const vacationKey = `${userId}-${year}-${month}`;
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userVacations: { ...this.allData.userVacations, [vacationKey]: vacations } 
                }, { merge: true });
            }

            async updateUserAvailability(userId, year, month, availability) {
                const availabilityKey = `${userId}-${year}-${month}`;
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userAvailability: { ...this.allData.userAvailability, [availabilityKey]: availability } 
                }, { merge: true });
            }

            async updateUserVacationTime(userId, year, month, date, vacationData) {
                const vacationTimeKey = `${userId}-${year}-${month}`;
                const currentVacationTimes = this.allData.userVacationTimes || {};
                const userVacationTimes = currentVacationTimes[vacationTimeKey] || {};
                
                // 如果兩個時段都不休假，則刪除該日期的記錄
                if (!vacationData.morning && !vacationData.evening) {
                    delete userVacationTimes[date];
                } else {
                    userVacationTimes[date] = vacationData;
                }
                
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userVacationTimes: { ...currentVacationTimes, [vacationTimeKey]: userVacationTimes } 
                }, { merge: true });
            }

            async updateAdminHolidays(holidays) {
                await setDoc(doc(this.db, "scheduleData", "main"), { adminHolidays: holidays }, { merge: true });
            }

            async updateCoverSignups(signups) {
                try {
                    // 獲取當前所有資料
                    const currentData = this.allData;
                    // 更新 coverSignups 並保持其他資料不變
                    const updatedData = { ...currentData, coverSignups: signups };
                    
                    console.log('更新代班資料到資料庫:', updatedData.coverSignups);
                    
                    await setDoc(doc(this.db, "scheduleData", "main"), updatedData);
                    
                    console.log('代班資料更新成功');
                } catch (error) {
                    console.error('更新代班資料失敗:', error);
                    throw error;
                }
            }

            async updateManualAssignments(assignments) {
                await setDoc(doc(this.db, "scheduleData", "main"), { manualAssignments: assignments }, { merge: true });
            }

            async updateOutsideSchedule(schedule) {
                await setDoc(doc(this.db, "scheduleData", "main"), { outsideSchedule: schedule }, { merge: true });
            }

            async updateMultiple(fields) {
                // 使用 merge:true 同步更新多個欄位，避免資料彼此覆蓋
                console.log('updateMultiple 被呼叫，準備更新欄位:', fields);
                try {
                    await setDoc(doc(this.db, "scheduleData", "main"), fields, { merge: true });
                    console.log('updateMultiple 更新成功');
                } catch (error) {
                    console.error('updateMultiple 更新失敗:', error);
                    throw error;
                }
            }

            async deleteUser(userId) {
                try {
                    console.log('開始刪除用戶:', userId);
                    
                    // 1. 刪除用戶文檔
                    await deleteDoc(doc(this.db, "users", userId));
                    console.log('用戶文檔已刪除');
                    
                    // 2. 清理所有相關數據
                    const currentData = this.allData;
                    const updatedData = { ...currentData };
                    
                    // 清理 userVacations
                    const userVacationKeys = Object.keys(updatedData.userVacations || {}).filter(key => key.startsWith(`${userId}-`));
                    userVacationKeys.forEach(key => {
                        delete updatedData.userVacations[key];
                    });
                    
                    // 清理 userAvailability
                    const userAvailabilityKeys = Object.keys(updatedData.userAvailability || {}).filter(key => key.startsWith(`${userId}-`));
                    userAvailabilityKeys.forEach(key => {
                        delete updatedData.userAvailability[key];
                    });
                    
                    // 清理 coverSignups 中該用戶的代班記錄
                    const updatedCoverSignups = { ...updatedData.coverSignups };
                    Object.keys(updatedCoverSignups).forEach(key => {
                        if (updatedCoverSignups[key] === userId) {
                            delete updatedCoverSignups[key];
                        }
                    });
                    updatedData.coverSignups = updatedCoverSignups;
                    
                    // 清理 manualAssignments 中該用戶的排班記錄
                    const updatedManualAssignments = { ...updatedData.manualAssignments };
                    Object.keys(updatedManualAssignments).forEach(dateKey => {
                        if (Array.isArray(updatedManualAssignments[dateKey])) {
                            updatedManualAssignments[dateKey] = updatedManualAssignments[dateKey].filter(assignment => assignment.userId !== userId);
                        }
                    });
                    updatedData.manualAssignments = updatedManualAssignments;
                    
                    // 清理 outsideSchedule 中該用戶的排班記錄
                    const updatedOutsideSchedule = { ...updatedData.outsideSchedule };
                    Object.keys(updatedOutsideSchedule).forEach(dateKey => {
                        if (Array.isArray(updatedOutsideSchedule[dateKey])) {
                            updatedOutsideSchedule[dateKey] = updatedOutsideSchedule[dateKey].filter(shift => shift.userId !== userId);
                        }
                    });
                    updatedData.outsideSchedule = updatedOutsideSchedule;
                    
                    // 3. 更新數據庫
                    await setDoc(doc(this.db, "scheduleData", "main"), updatedData);
                    console.log('用戶相關數據已清理完成');
                    
                } catch (error) {
                    console.error('刪除用戶失敗:', error);
                    throw error;
                }
            }
        }

        // ===================================================================================
        // === UI管理類別 (UIManager) ===
        // ===================================================================================
        class UIManager {
            constructor() {
                this.initializeElements();
            }

            initializeElements() {
                // Auth elements
                this.authContainer = document.getElementById('auth-container');
                this.appContainer = document.getElementById('app');
                this.loginView = document.getElementById('login-view');
                this.registerView = document.getElementById('register-view');
                this.loginForm = document.getElementById('login-form');
                this.registerForm = document.getElementById('register-form');
                this.authError = document.getElementById('auth-error');
                this.showRegisterBtn = document.getElementById('show-register');
                this.showLoginBtn = document.getElementById('show-login');
                this.logoutBtn = document.getElementById('logout-btn');
                this.userNameSpan = document.getElementById('userName');
                this.userRoleSpan = document.getElementById('userRole');
                this.appSubtitle = document.getElementById('app-subtitle');
                this.calendarView = document.getElementById('calendar-view');
                this.settingsBtn = document.getElementById('settings-btn');
                this.settingsModal = document.getElementById('settings-modal');
                this.closeSettingsBtn = document.getElementById('close-settings-btn');
                this.changePasswordForm = document.getElementById('change-password-form');
                this.changeUsernameForm = document.getElementById('change-username-form');
                this.passwordSettingsError = document.getElementById('password-settings-error');
                this.usernameSettingsError = document.getElementById('username-settings-error');

                // 班次選擇 Modal
                this.shiftSelectModal = document.getElementById('shift-select-modal');
                this.closeShiftSelectBtn = document.getElementById('close-shift-select-btn');
                this.shiftSelectInfo = document.getElementById('shift-select-info');
                this.shiftSelectOptions = document.getElementById('shift-select-options');
                
                // 代班人選擇 Modal
                this.coverShiftModal = document.getElementById('cover-shift-modal');
                this.closeCoverShiftBtn = document.getElementById('close-cover-shift-btn');
                this.coverShiftForm = document.getElementById('cover-shift-form');
                this.coverShiftInfo = document.getElementById('cover-shift-info');
                this.coverShiftSelect = document.getElementById('cover-shift-replacement-select');
                
                // 休假時間選擇 Modal
                this.vacationTimeModal = document.getElementById('vacation-time-modal');
                this.closeVacationTimeBtn = document.getElementById('close-vacation-time-btn');
                this.confirmVacationTimeBtn = document.getElementById('confirm-vacation-time-btn');
                this.cancelVacationTimeBtn = document.getElementById('cancel-vacation-time-btn');
                this.vacationTimeInfo = document.getElementById('vacation-time-info');
                this.vacationMorningCheckbox = document.getElementById('vacation-morning');
                this.vacationEveningCheckbox = document.getElementById('vacation-evening');
                
                // 刪除用戶 Modal
                this.deleteUserModal = document.getElementById('delete-user-modal');
                this.closeDeleteUserBtn = document.getElementById('close-delete-user-btn');
                this.confirmDeleteUserBtn = document.getElementById('confirm-delete-user-btn');
                this.cancelDeleteUserBtn = document.getElementById('cancel-delete-user-btn');
                this.deleteUserInfo = document.getElementById('delete-user-info');
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.remove('translate-y-20', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            showAuthView() {
                this.authContainer.classList.remove('hidden');
                this.appContainer.classList.add('hidden');
            }

            showAppView() {
                this.authContainer.classList.add('hidden');
                this.appContainer.classList.remove('hidden');
            }

            showLoginForm() {
                this.loginView.classList.remove('hidden');
                this.registerView.classList.add('hidden');
                this.authError.textContent = '';
            }

            showRegisterForm() {
                this.registerView.classList.remove('hidden');
                this.loginView.classList.add('hidden');
                this.authError.textContent = '';
            }

            showSettingsModal() {
                this.settingsModal.classList.remove('hidden');
                this.passwordSettingsError.textContent = '';
                this.usernameSettingsError.textContent = '';
                this.changePasswordForm.reset();
            }

            hideSettingsModal() {
                this.settingsModal.classList.add('hidden');
            }

            // 顯示班次選擇 Modal
            showShiftSelectModal(date, shifts) {
                this.shiftSelectInfo.textContent = `您在 ${date} 有 ${shifts.length} 個班次，請選擇要找人代班的班次：`;
                this.shiftSelectOptions.innerHTML = ''; // 清空舊按鈕

                shifts.forEach(shiftData => {
                    const button = document.createElement('button');
                    button.className = "w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700";
                    button.textContent = `班次: (${shiftData.shift})`;
                    // 將資料存在按鈕上，以便事件監聽器抓取
                    button.dataset.date = date;
                    button.dataset.shift = shiftData.shift;
                    button.classList.add('shift-select-btn'); // 加上 class 供事件委派使用
                    this.shiftSelectOptions.appendChild(button);
                });

                this.shiftSelectModal.classList.remove('hidden');
            }

            // 隱藏班次選擇 Modal
            hideShiftSelectModal() {
                this.shiftSelectModal.classList.add('hidden');
                this.shiftSelectOptions.innerHTML = ''; // 清空按鈕
            }

            // 顯示代班人選擇 Modal
            showCoverShiftModal(date, shift, replacementOptions) {
                // 儲存資訊，以便表單提交時使用
                this.coverShiftForm.dataset.date = date;
                this.coverShiftForm.dataset.shift = shift;

                // 顯示班次資訊
                this.coverShiftInfo.textContent = `您在 ${date} 的 (${shift}) 班，要找誰代班？`;

                // 清空並填充下拉選單
                this.coverShiftSelect.innerHTML = '<option value="" disabled selected>選擇一位外場工讀生</option>';
                replacementOptions.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    this.coverShiftSelect.appendChild(option);
                });

                this.coverShiftModal.classList.remove('hidden');
            }

            // 隱藏代班人選擇 Modal
            hideCoverShiftModal() {
                this.coverShiftModal.classList.add('hidden');
                this.coverShiftForm.reset();
            }

            // 顯示刪除用戶 Modal
            showDeleteUserModal(userInfo) {
                this.deleteUserInfo.textContent = `您確定要刪除用戶「${userInfo.username}」(${userInfo.role}) 嗎？`;
                this.deleteUserModal.classList.remove('hidden');
            }

            // 隱藏刪除用戶 Modal
            hideDeleteUserModal() {
                this.deleteUserModal.classList.add('hidden');
            }

            // 顯示休假時間選擇 Modal
            showVacationTimeModal(date, currentVacationData = null) {
                this.vacationTimeInfo.textContent = `請選擇您在 ${date} 的休假時間段：`;
                
                // 設置默認值（兩個都勾選表示全天休假）
                this.vacationMorningCheckbox.checked = true;
                this.vacationEveningCheckbox.checked = true;
                
                // 如果有現有的休假數據，根據數據設置勾選狀態
                if (currentVacationData) {
                    this.vacationMorningCheckbox.checked = currentVacationData.morning || false;
                    this.vacationEveningCheckbox.checked = currentVacationData.evening || false;
                }
                
                this.vacationTimeModal.classList.remove('hidden');
            }

            // 隱藏休假時間選擇 Modal
            hideVacationTimeModal() {
                this.vacationTimeModal.classList.add('hidden');
            }

            updateUserInfo(username, role) {
                this.userNameSpan.textContent = username;
                this.userRoleSpan.textContent = role;
            }

            updateAppSubtitle(text) {
                this.appSubtitle.textContent = text;
            }

            toggleSettingsButton(show) {
                if (show) {
                    this.settingsBtn.classList.remove('hidden');
                } else {
                    this.settingsBtn.classList.add('hidden');
                }
            }

            showCalendarView() {
                this.calendarView.classList.remove('hidden');
            }

            hideCalendarView() {
                this.calendarView.classList.add('hidden');
            }

            setAuthError(message) {
                this.authError.textContent = message;
            }

            setPasswordError(message) {
                this.passwordSettingsError.textContent = message;
            }

            setUsernameError(message) {
                this.usernameSettingsError.textContent = message;
            }
        }

        // ===================================================================================
        // === 主應用程式類別 (ScheduleApp) ===
        // ===================================================================================
        class ScheduleApp {
            constructor() {
                this.initializeFirebase();
                this.initializeManagers();
                this.initializeConstants();
                this.setupEventListeners();
                this.setupAuthStateListener();
                this.setupAutoSchedule();
                this.pendingDeleteUser = null;
                this.pendingVacationDate = null;
                this.currentCalendarView = 'outside'; // 初始化月曆視圖類型，默認顯示外場月曆
                
                // === (NEW) Define shift options ===
                this.insideShifts = [
                    "備菜班 (早)", "備菜班 (晚)", "備菜班 (全日)",
                    "炸爐班 (早)", "炸爐班 (晚)", "炸爐班 (全日)",
                    "收班" // 内場工讀生
                ];
                this.outsideShifts = [
                    "早櫃", "早班", "晚櫃", "洗碗", "收班", // 外場工讀生
                    "櫃檯" // 外場櫃檯
                ];
            }

            initializeFirebase() {
                // ===================================================================================
                // === 重要：請將下方的 firebaseConfig 物件替換成您自己的 Firebase 專案設定 ===
                // ===================================================================================
                const firebaseConfig = {
                apiKey: "AIzaSyBEMnLL-ppl8-jQnA1RzZW8JfsUjCqEOFQ",
                authDomain: "schedule-hantaitai.firebaseapp.com",
                databaseURL: "https://schedule-hantaitai-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "schedule-hantaitai",
                storageBucket: "schedule-hantaitai.firebasestorage.app",
                messagingSenderId: "600535535784",
                appId: "1:600535535784:web:397ad1387e60f87479b29d"
                };
                // ===================================================================================

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                this.auth = getAuth(app);
                this.db = getFirestore(app);
            }

            initializeManagers() {
                this.authManager = new AuthManager(this.auth, this.db);
                this.calendarManager = new CalendarManager();
                this.scheduleManager = new ScheduleManager(this.db);
                this.uiManager = new UIManager();
            }

            initializeConstants() {
                this.ADMIN_ROLE = "管理者";
                this.FULLTIME_ROLES = ["内場備菜班", "内場炸爐班"];
                this.PART_TIMER_ROLE = "内場工讀生";
                this.OUTSIDE_ROLES = ["外場工讀生", "外場櫃檯"];
                this.INSIDE_ROLES = ["内場工讀生", "内場備菜班", "内場炸爐班"];
            }

            setupAutoSchedule() {
                // 每分鐘檢查一次是否需要自動排班
                setInterval(() => {
                    this.checkAutoSchedule();
                }, 60000); // 60秒檢查一次
                
                // 頁面載入時也檢查一次
                this.checkAutoSchedule();
            }

            async checkAutoSchedule() {
                const now = new Date();
                const currentDay = now.getDate();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentMonth = now.getMonth() + 1;
                const currentYear = now.getFullYear();
                
                // 檢查是否為25號早上8點（允許8:00-8:01之間執行）
                if (currentDay === 25 && currentHour === 8 && currentMinute <= 1) {
                    const lastRunKey = `autoSchedule_25_${currentYear}_${currentMonth}`;
                    const lastRun = localStorage.getItem(lastRunKey);
                    const today = now.toDateString();
                    
                    if (lastRun !== today) {
                        localStorage.setItem(lastRunKey, today);
                        await this.autoScheduleNextMonth();
                    }
                }
                
                // 檢查是否為10號早上8點（允許8:00-8:01之間執行）
                if (currentDay === 10 && currentHour === 8 && currentMinute <= 1) {
                    const lastRunKey = `autoSchedule_10_${currentYear}_${currentMonth}`;
                    const lastRun = localStorage.getItem(lastRunKey);
                    const today = now.toDateString();
                    
                    if (lastRun !== today) {
                        localStorage.setItem(lastRunKey, today);
                        await this.autoScheduleCurrentMonthSecondHalf();
                    }
                }
            }

            async autoScheduleNextMonth() {
                try {
                    const now = new Date();
                    const nextMonth = now.getMonth() + 1 === 12 ? 0 : now.getMonth() + 1;
                    const nextYear = now.getMonth() + 1 === 12 ? now.getFullYear() + 1 : now.getFullYear();
                    
                    console.log(`自動排班：${nextYear}年${nextMonth + 1}月1-15號`);
                    await this.generateOutsideScheduleAuto(nextYear, nextMonth + 1, 1, 15);
                    
                    // 發送通知給管理員（如果有的話）
                    if (this.uiManager) {
                        this.uiManager.showToast(`已自動排下個月1-15號的班表`);
                    }
                } catch (error) {
                    console.error('自動排班失敗:', error);
                }
            }

            async autoScheduleCurrentMonthSecondHalf() {
                try {
                    const now = new Date();
                    const currentMonth = now.getMonth() + 1;
                    const currentYear = now.getFullYear();
                    
                    console.log(`自動排班：${currentYear}年${currentMonth}月16-31號`);
                    await this.generateOutsideScheduleAuto(currentYear, currentMonth, 16);
                    
                    // 發送通知給管理員（如果有的話）
                    if (this.uiManager) {
                        this.uiManager.showToast(`已自動排本月16-31號的班表`);
                    }
                } catch (error) {
                    console.error('自動排班失敗:', error);
                }
            }

            // 統一的排班邏輯核心函數
            generateDaySchedule(dateString, dayOfWeek, counterVacation, availableWorkers, workerUnavailability, workerVacationTimes, workerWorkDays) {
                const daySchedule = [];
                
                if (counterVacation) {
                    // 櫃檯休假：平日不排「早班」，假日維持含「早班」
                    const dayAvailableWorkers = availableWorkers.filter(worker => 
                        !workerUnavailability[worker.username].includes(dateString)
                    );
                    
                    if (dayAvailableWorkers.length > 0) {
                        // 平日（週一至週五）：早櫃、晚櫃、洗碗、收班；假日：含早班共五班
                        const shifts = (dayOfWeek >= 1 && dayOfWeek <= 5)
                            ? ["早櫃", "晚櫃", "洗碗", "收班"]
                            : ["早櫃", "早班", "晚櫃", "洗碗", "收班"];
                        
                        // 平均分配班別給可用的工讀生
                        const sortedWorkers = dayAvailableWorkers.sort((a, b) => 
                            workerWorkDays[a.username] - workerWorkDays[b.username]
                        );
                        // 打亂班別以隨機分配
                        const shuffledShifts = [...shifts].sort(() => Math.random() - 0.5);
                        
                        // 分配邏輯：
                        // 1. 優先把班別分配給不同的人
                        // 2. 如果人數不足，允許同一個人上多個班，但要檢查衝突
                        let workerIndex = 0;
                        for (const shift of shuffledShifts) {
                            let assigned = false;
                            let attempt = 0;
                            
                            // 嘗試分配給下一個工人，最多繞一圈
                            while (!assigned && attempt < sortedWorkers.length) {
                                const worker = sortedWorkers[workerIndex % sortedWorkers.length];
                                
                                let hasConflict = false;
                                const morningGroup = ["早櫃", "早班"];
                                const eveningGroup = ["晚櫃", "洗碗", "收班"];

                                // Check for conflicts
                                for (const existing of daySchedule) {
                                    if (existing.username === worker.username) {
                                        // Rule 1: "早櫃" and "早班" cannot be the same person
                                        if (morningGroup.includes(shift) && morningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                        
                                        // Rule 2: "晚櫃", "洗碗", and "收班" cannot be the same person
                                        if (eveningGroup.includes(shift) && eveningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                    }
                                }
                                
                                // 檢查工人是否可以在這個班次工作（考慮分時段休假）
                                if (!hasConflict && this.isWorkerAvailableForShift(worker, dateString, shift, workerVacationTimes)) {
                                    daySchedule.push({
                                        username: worker.username,
                                        role: "外場工讀生",
                                        shift: shift
                                    });
                                    workerWorkDays[worker.username]++;
                                    assigned = true;
                                }
                                
                                workerIndex++;
                                attempt++;
                            }
                        }
                    }
                } else {
                    // 正常排班
                    const dayAvailableWorkers = availableWorkers.filter(worker => 
                        !workerUnavailability[worker.username].includes(dateString)
                    );
                    
                    if (dayAvailableWorkers.length > 0) {
                        // 根據星期幾決定班別（不包含櫃檯，因為櫃檯人員已經上班）
                        let shifts = [];
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            // 星期一到星期五：收班、洗碗（櫃檯由櫃檯人員擔任）
                            shifts = ["收班", "洗碗"];
                        } else {
                            // 星期六、星期日：早班、收班、洗碗（櫃檯由櫃檯人員擔任）
                            shifts = ["早班", "收班", "洗碗"];
                        }
                        
                        // 平均分配班別給可用的工讀生
                        const sortedWorkers = dayAvailableWorkers.sort((a, b) => 
                            workerWorkDays[a.username] - workerWorkDays[b.username]
                        );
                        const shuffledShifts = [...shifts].sort(() => Math.random() - 0.5);
                        
                        // 修復：為每個班次尋找合適的工人，而不是綁定索引
                        let workerIndex = 0;
                        for (const shift of shuffledShifts) {
                            let assigned = false;
                            let attempt = 0;
                            
                            // 嘗試分配給下一個工人，最多繞一圈
                            while (!assigned && attempt < sortedWorkers.length) {
                                const worker = sortedWorkers[workerIndex % sortedWorkers.length];
                                
                                // 檢查工人是否可以在這個班次工作（考慮分時段休假）
                                const canWork = this.isWorkerAvailableForShift(worker, dateString, shift, workerVacationTimes);
                                
                                // 檢查衝突：使用與櫃檯休假相同的分組規則
                                let hasConflict = false;
                                const morningGroup = ["早班"];  // 正常排班時，只有早班屬於早班組
                                const eveningGroup = ["洗碗", "收班"];  // 洗碗、收班屬於晚班組
                                
                                for (const existing of daySchedule) {
                                    if (existing.username === worker.username) {
                                        // Rule 1: 早班組內不能重複（這裡只有一個早班，所以不會衝突）
                                        if (morningGroup.includes(shift) && morningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                        
                                        // Rule 2: 晚班組內不能重複（洗碗、收班不能同一人）
                                        if (eveningGroup.includes(shift) && eveningGroup.includes(existing.shift)) {
                                            hasConflict = true;
                                            break;
                                        }
                                    }
                                }
                                
                                if (canWork && !hasConflict) {
                                    daySchedule.push({
                                        username: worker.username,
                                        role: "外場工讀生",
                                        shift: shift
                                    });
                                    workerWorkDays[worker.username]++;
                                    assigned = true;
                                }
                                
                                workerIndex++;
                                attempt++;
                            }
                        }
                    }
                }
                
                return daySchedule;
            }

            // 專門用於自動排班的方法，不依賴勾選框狀態
            async generateOutsideScheduleAuto(year, month, startDay = 1, endDay = null) {
                const allUsers = this.scheduleManager.getAllUsers();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, userAvailability = {}, outsideSchedule = {}, userVacationTimes = {} } = allData;
                
                const outsideWorkers = allUsers.filter(u => u.role === "外場工讀生");
                const counterStaff = allUsers.filter(u => u.role === "外場櫃檯");
                
                if (outsideWorkers.length === 0) {
                    console.log('沒有外場工讀生可以排班');
                    return;
                }
                
                const lastDayOfMonth = new Date(year, month, 0).getDate();
                const actualEndDay = endDay || lastDayOfMonth;
                
                // 複製舊排班資料，但清空即將生成的日期範圍
                const newSchedule = { ...outsideSchedule };
                
                // 清除指定日期範圍的舊排班數據
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    delete newSchedule[dateString];
                }
                
                // 獲取櫃檯休假日期
                const counterVacations = [];
                counterStaff.forEach(staff => {
                    const vacationKey = `${staff.id}-${year}-${month}`;
                    const vacations = userVacations[vacationKey] || [];
                    vacations.forEach(date => {
                        counterVacations.push({ date, staff: staff.username });
                    });
                });
                
                // 獲取工讀生不可上班日期和分時段休假
                const workerUnavailability = {};
                const workerVacationTimes = {};
                outsideWorkers.forEach(worker => {
                    const availabilityKey = `${worker.id}-${year}-${month}`;
                    const vacationTimeKey = `${worker.id}-${year}-${month}`;
                    workerUnavailability[worker.username] = userAvailability[availabilityKey] || [];
                    workerVacationTimes[worker.username] = userVacationTimes[vacationTimeKey] || {};
                });
                
                // 計算每個工讀生的工作天數
                const workerWorkDays = {};
                outsideWorkers.forEach(worker => {
                    workerWorkDays[worker.username] = 0;
                });
                
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay();
                    
                    // 跳過星期四（公休日）
                    if (dayOfWeek === 4) continue;
                    
                    // 檢查是否有櫃檯休假
                    const counterVacation = counterVacations.find(cv => cv.date === dateString);
                    
                    // 使用統一的排班邏輯
                    const daySchedule = this.generateDaySchedule(
                        dateString, 
                        dayOfWeek, 
                        counterVacation, 
                        outsideWorkers, 
                        workerUnavailability, 
                        workerVacationTimes, 
                        workerWorkDays
                    );
                    
                    if (daySchedule.length > 0) {
                        newSchedule[dateString] = daySchedule;
                    }
                }
                
                // 更新排班資料
                await this.scheduleManager.updateOutsideSchedule(newSchedule);
                console.log('外場排班已自動生成！');
            }

            async handleRegister(e) {
                e.preventDefault();
                this.uiManager.setAuthError('');
                
                const username = this.uiManager.registerForm.querySelector('#register-username').value.trim();
                const password = this.uiManager.registerForm.querySelector('#register-password').value;
                const passwordConfirm = this.uiManager.registerForm.querySelector('#register-password-confirm').value;
                const role = this.uiManager.registerForm.querySelector('#register-role').value;
                
                try {
                    await this.authManager.register(username, password, passwordConfirm, role);
                    this.uiManager.showToast('註冊成功！');
                } catch (error) {
                    this.uiManager.setAuthError(error.message);
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                this.uiManager.setAuthError('');
                
                const username = this.uiManager.loginForm.querySelector('#login-username').value.trim().toLowerCase();
                const password = this.uiManager.loginForm.querySelector('#login-password').value;
                
                try {
                    await this.authManager.login(username, password);
                } catch (error) {
                    this.uiManager.setAuthError(error.message);
                }
            }

            async handleLogout() {
                await this.authManager.logout();
            }

            async handleChangePassword(e) {
                e.preventDefault();
                this.uiManager.setPasswordError('');
                
                const newPassword = this.uiManager.changePasswordForm.querySelector('#new-password').value;
                const confirmNewPassword = this.uiManager.changePasswordForm.querySelector('#confirm-new-password').value;

                try {
                    await this.authManager.changePassword(newPassword, confirmNewPassword);
                    this.uiManager.showToast('密碼更新成功！');
                    this.uiManager.hideSettingsModal();
                    this.uiManager.changePasswordForm.reset();
                } catch (error) {
                    this.uiManager.setPasswordError(error.message);
                }
            }

            async handleChangeUsername(e) {
                e.preventDefault();
                this.uiManager.setUsernameError('');
                
                const newUsernameInput = this.uiManager.changeUsernameForm.querySelector('#new-username');
                const newUsername = newUsernameInput.value.trim();

                try {
                    await this.authManager.changeUsername(newUsername);
                    this.uiManager.showToast('名稱更新成功！');
                    this.uiManager.hideSettingsModal();
                } catch (error) {
                    this.uiManager.setUsernameError(error.message);
                }
            }

            async handleDayClick(e) {
                const dayDiv = e.target.closest('.calendar-day');
                if (!dayDiv || !dayDiv.dataset.date) return;
                
                const clickedDateStr = dayDiv.dataset.date;
                const [year, month, day] = clickedDateStr.split('-').map(Number);
                const clickedDate = new Date(year, month - 1, day);
                const allData = this.scheduleManager.getAllData();
                const { adminHolidays: currentAdminHolidays = [], userVacations = {} } = allData;
                
                if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                    if (clickedDate.getDay() === 4) return this.uiManager.showToast("星期四是固定公休日，無法更改。");
                    
                    const newAdminHolidays = currentAdminHolidays.includes(clickedDateStr)
                        ? currentAdminHolidays.filter(d => d !== clickedDateStr)
                        : [...currentAdminHolidays, clickedDateStr];
                    
                    await this.scheduleManager.updateAdminHolidays(newAdminHolidays);
                    this.uiManager.showToast(currentAdminHolidays.includes(clickedDateStr) ? `${clickedDateStr} 已取消公休。` : `${clickedDateStr} 已設定為公休日。`);
                    return;
                }
                
                if (clickedDate.getDay() === 4 || currentAdminHolidays.includes(clickedDateStr)) {
                    return this.uiManager.showToast("此日為公休日，無法排班");
                }
                
                const [yearFromStr, monthFromStr] = clickedDateStr.split('-');

                if (this.FULLTIME_ROLES.includes(this.authManager.getCurrentUserData().role)) {
                    await this.handleFullTimeDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations);
                } else if (this.authManager.getCurrentUserData().role === this.PART_TIMER_ROLE) {
                    await this.handlePartTimerDayClick(clickedDateStr, yearFromStr, monthFromStr);
                } else if (this.OUTSIDE_ROLES.includes(this.authManager.getCurrentUserData().role)) {
                    await this.handleOutsideDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations);
                }
            }

            async handleFullTimeDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations) {
                const vacationKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                const currentVacations = userVacations[vacationKey] || [];
                const isVacation = currentVacations.includes(clickedDateStr);
                
                let newVacations;

                if (isVacation) {
                    newVacations = currentVacations.filter(d => d !== clickedDateStr);
                } else {
                    if(currentVacations.length >= 5) return this.uiManager.showToast('本月休假已選滿5天');
                    
                    const allUsers = this.scheduleManager.getAllUsers();
                    const otherFullTimers = allUsers.filter(u => u.id !== this.authManager.getCurrentUser().uid && this.FULLTIME_ROLES.includes(u.role));
                    let isDayTaken = false;
                    for (const otherUser of otherFullTimers) {
                        const otherUserVacationKey = `${otherUser.id}-${yearFromStr}-${parseInt(monthFromStr)}`;
                        const otherUserVacations = userVacations[otherUserVacationKey] || [];
                        if (otherUserVacations.includes(clickedDateStr)) {
                            isDayTaken = true;
                            break;
                        }
                    }

                    if (isDayTaken) {
                        return this.uiManager.showToast(`已有其他正職人員於此日排休，無法選擇。`);
                    }
                    
                    newVacations = [...currentVacations, clickedDateStr];
                }
                
                await this.scheduleManager.updateUserVacation(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newVacations);
            }

            async handlePartTimerDayClick(clickedDateStr, yearFromStr, monthFromStr) {
                const availabilityKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                const allData = this.scheduleManager.getAllData();
                const currentAvailability = allData.userAvailability?.[availabilityKey] || [];
                const newAvailability = currentAvailability.includes(clickedDateStr)
                    ? currentAvailability.filter(d => d !== clickedDateStr)
                    : [...currentAvailability, clickedDateStr];
                    
                await this.scheduleManager.updateUserAvailability(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newAvailability);
            }

            async handleOutsideDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations) {
                const currentUserData = this.authManager.getCurrentUserData();
                
                if (currentUserData.role === "外場櫃檯") {
                    // 外場櫃檯的休假邏輯（類似內場備菜班）
                    const vacationKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                    const currentVacations = userVacations[vacationKey] || [];
                    const isVacation = currentVacations.includes(clickedDateStr);
                    
                    let newVacations;

                    if (isVacation) {
                        newVacations = currentVacations.filter(d => d !== clickedDateStr);
                    } else {
                        if(currentVacations.length >= 5) return this.uiManager.showToast('本月休假已選滿5天');
                        
                        const allUsers = this.scheduleManager.getAllUsers();
                        const otherCounterStaff = allUsers.filter(u => u.id !== this.authManager.getCurrentUser().uid && u.role === "外場櫃檯");
                        let isDayTaken = false;
                        for (const otherUser of otherCounterStaff) {
                            const otherUserVacationKey = `${otherUser.id}-${yearFromStr}-${parseInt(monthFromStr)}`;
                            const otherUserVacations = userVacations[otherUserVacationKey] || [];
                            if (otherUserVacations.includes(clickedDateStr)) {
                                isDayTaken = true;
                                break;
                            }
                        }

                        if (isDayTaken) {
                            return this.uiManager.showToast(`已有其他外場櫃檯於此日排休，無法選擇。`);
                        }
                        
                        newVacations = [...currentVacations, clickedDateStr];
                    }
                    
                    await this.scheduleManager.updateUserVacation(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newVacations);
                
                // =======================
                // === (MODIFIED) Block ===
                // =======================
                } else if (currentUserData.role === "外場工讀生") {
                    
                    const allData = this.scheduleManager.getAllData();
                    const { outsideSchedule = {}, userAvailability = {} } = allData;
                    
                    // 檢查當天自己被排了哪些班
                    const myShifts = (outsideSchedule[clickedDateStr] || []).filter(
                        s => s.username === currentUserData.username
                    );
                    
                    // --- NEW LOGIC ---
                    if (myShifts.length > 1) {
                        // === 情境1: 多個班次，顯示班次選擇器 ===
                        this.uiManager.showShiftSelectModal(clickedDateStr, myShifts);
                    
                    } else if (myShifts.length === 1) {
                        // === 情境2: 一個班次，直接顯示同事選擇器 ===
                        const allUsers = this.scheduleManager.getAllUsers();
                        const replacementOptions = allUsers.filter(u => 
                            u.role === "外場工讀生" && u.id !== this.authManager.getCurrentUser().uid
                        );
                        const shiftToCover = myShifts[0].shift;
                        this.uiManager.showCoverShiftModal(clickedDateStr, shiftToCover, replacementOptions);

                    } else {
                        // === 情境3: 沒有班次，顯示休假時間選擇 ===
                        this.showVacationTimeModal(clickedDateStr, yearFromStr, monthFromStr);
                    }
                    // --- END NEW LOGIC ---
                }
                // =======================
                // === End Modified Block ===
                // =======================
            }

            // 處理班次選擇的函式
            handleShiftSelect(date, shift) {
                // 1. 隱藏班次選擇 modal
                this.uiManager.hideShiftSelectModal();

                // 2. 準備並顯示同事選擇 modal
                const allUsers = this.scheduleManager.getAllUsers();
                const replacementOptions = allUsers.filter(u => 
                    u.role === "外場工讀生" && u.id !== this.authManager.getCurrentUser().uid
                );

                this.uiManager.showCoverShiftModal(date, shift, replacementOptions);
            }

            // 處理代班人指派的函式
            async handleAssignCoverShift(e) {
                e.preventDefault();
                
                // 從表單的 dataset 獲取資訊
                const date = this.uiManager.coverShiftForm.dataset.date;
                const shift = this.uiManager.coverShiftForm.dataset.shift;
                
                // 獲取選擇的代班人員
                const replacementUserId = this.uiManager.coverShiftSelect.value;
                if (!replacementUserId) {
                    return this.uiManager.showToast("請選擇一位代班人員");
                }
                
                const replacementUser = this.scheduleManager.getAllUsers().find(u => u.id === replacementUserId);
                if (!replacementUser) {
                    return this.uiManager.showToast("代班人員資料錯誤");
                }

                this.uiManager.showToast("正在處理換班...");

                try {
                    // 這是關鍵的 Read-Modify-Write 邏輯
                    const allData = this.scheduleManager.getAllData();
                    // 深度複製一份排班表，避免修改到當前狀態
                    const newOutsideSchedule = JSON.parse(JSON.stringify(allData.outsideSchedule || {}));
                    
                    const daySchedule = newOutsideSchedule[date];
                    if (!daySchedule) {
                        throw new Error("找不到當天的排班資料");
                    }
                    
                    // 找到使用者原有的班次
                    const originalShiftIndex = daySchedule.findIndex(s => 
                        s.username === this.authManager.getCurrentUserData().username && 
                        s.shift === shift
                    );
                    
                    if (originalShiftIndex === -1) {
                        throw new Error("找不到您原有的班次，可能已被更動");
                    }
                    
                    // === 執行換班 ===
                    // 將該班次的 username 換成代班人的 username
                    daySchedule[originalShiftIndex].username = replacementUser.username;
                    
                    // 將修改後的排班表寫回資料庫
                    await this.scheduleManager.updateOutsideSchedule(newOutsideSchedule);
                    
                    this.uiManager.showToast("換班成功！");
                    this.uiManager.hideCoverShiftModal();
                    
                    // 刷新月曆顯示最新的排班資料
                    await this.renderOutsideCalendar();

                } catch (error) {
                    console.error("換班失敗:", error);
                    this.uiManager.showToast(`換班失敗：${error.message}`);
                }
            }

            // 處理刪除用戶點擊
            handleDeleteUserClick(userId, username, role) {
                this.pendingDeleteUser = { id: userId, username, role };
                this.uiManager.showDeleteUserModal({ username, role });
            }

            // 處理確認刪除用戶
            async handleDeleteUser() {
                if (!this.pendingDeleteUser) {
                    this.uiManager.showToast('沒有選擇要刪除的用戶');
                    return;
                }

                try {
                    this.uiManager.showToast('正在刪除用戶...');
                    await this.scheduleManager.deleteUser(this.pendingDeleteUser.id);
                    this.uiManager.showToast(`用戶「${this.pendingDeleteUser.username}」已成功刪除`);
                    this.uiManager.hideDeleteUserModal();
                    
                    // 重新生成用戶管理列表
                    this.generateUserManagementLists();
                    
                    // 清除待刪除用戶
                    this.pendingDeleteUser = null;
                    
                } catch (error) {
                    console.error('刪除用戶失敗:', error);
                    this.uiManager.showToast(`刪除用戶失敗：${error.message}`);
                }
            }

            // 顯示休假時間選擇
            showVacationTimeModal(date, year, month) {
                this.pendingVacationDate = { date, year, month };
                
                // 檢查是否有現有的休假數據
                const allData = this.scheduleManager.getAllData();
                const vacationTimeKey = `${this.authManager.getCurrentUser().uid}-${year}-${month}`;
                const userVacationTimes = allData.userVacationTimes?.[vacationTimeKey] || {};
                const currentVacationData = userVacationTimes[date];
                
                this.uiManager.showVacationTimeModal(date, currentVacationData);
            }

            // 處理確認休假時間選擇
            async handleVacationTimeConfirm() {
                if (!this.pendingVacationDate) {
                    this.uiManager.showToast('沒有選擇休假日期');
                    return;
                }

                const { date, year, month } = this.pendingVacationDate;
                const morningVacation = this.uiManager.vacationMorningCheckbox.checked;
                const eveningVacation = this.uiManager.vacationEveningCheckbox.checked;

                // ========== 智能休假限制檢查 ==========
                if (morningVacation || eveningVacation) {
                    const canVacation = await this.checkOutsideWorkerVacationLimit(date, year, month, morningVacation, eveningVacation);
                    if (!canVacation.allowed) {
                        this.uiManager.showToast(canVacation.message);
                        return;
                    }
                }
                // =====================================

                try {
                    await this.scheduleManager.updateUserVacationTime(
                        this.authManager.getCurrentUser().uid,
                        year,
                        month,
                        date,
                        { morning: morningVacation, evening: eveningVacation }
                    );

                    let message = '';
                    if (morningVacation && eveningVacation) {
                        message = `${date} 已設定為全天休假`;
                    } else if (morningVacation) {
                        message = `${date} 已設定為早上休假`;
                    } else if (eveningVacation) {
                        message = `${date} 已設定為晚上休假`;
                    } else {
                        message = `${date} 已取消休假，可以正常排班`;
                    }

                    this.uiManager.showToast(message);
                    this.uiManager.hideVacationTimeModal();
                    
                    // 清除待處理的休假日期
                    this.pendingVacationDate = null;
                    
                    // 手動觸發月曆重新渲染，確保休假時間立即更新
                    this.renderAppView();
                    
                } catch (error) {
                    console.error('更新休假時間失敗:', error);
                    this.uiManager.showToast(`更新休假時間失敗：${error.message}`);
                }
            }
            
            // 檢查外場工讀生休假是否超過限制
            async checkOutsideWorkerVacationLimit(dateString, year, month, requestMorning, requestEvening) {
                const allUsers = this.scheduleManager.getAllUsers();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, userVacationTimes = {} } = allData;
                
                // 1. 獲取所有外場工讀生
                const outsideWorkers = allUsers.filter(u => u.role === "外場工讀生");
                const totalWorkers = outsideWorkers.length;
                
                if (totalWorkers === 0) {
                    return { allowed: false, message: '沒有外場工讀生' };
                }
                
                // 2. 判斷該日期是平日還是假日
                const [yearStr, monthStr, dayStr] = dateString.split('-');
                const targetDate = new Date(parseInt(yearStr), parseInt(monthStr) - 1, parseInt(dayStr));
                const dayOfWeek = targetDate.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // 週六或週日
                const isWeekday = (dayOfWeek >= 1 && dayOfWeek <= 5); // 週一到週五
                
                // 3. 檢查外場櫃檯是否休假
                const counterStaff = allUsers.filter(u => u.role === "外場櫃檯");
                let isCounterVacation = false;
                for (const staff of counterStaff) {
                    const vacationKey = `${staff.id}-${year}-${month}`;
                    const vacations = userVacations[vacationKey] || [];
                    if (vacations.includes(dateString)) {
                        isCounterVacation = true;
                        break;
                    }
                }
                
                // 4. 根據條件決定需要多少位工讀生上班
                let requiredMorningWorkers = 0;
                let requiredEveningWorkers = 0;
                
                if (isWeekday && !isCounterVacation) {
                    // 平日 + 櫃檯上班：需要2位（洗碗、收班）- 都是晚上班次
                    requiredMorningWorkers = 0;
                    requiredEveningWorkers = 2;
                } else if (isWeekday && isCounterVacation) {
                    // 平日 + 櫃檯休假：需要4位（早櫃、晚櫃、洗碗、收班）
                    requiredMorningWorkers = 1; // 早櫃
                    requiredEveningWorkers = 3; // 晚櫃、洗碗、收班
                } else if (isWeekend && !isCounterVacation) {
                    // 假日 + 櫃檯上班：需要3位（早班、洗碗、收班）
                    requiredMorningWorkers = 1; // 早班
                    requiredEveningWorkers = 2; // 洗碗、收班
                } else if (isWeekend && isCounterVacation) {
                    // 假日 + 櫃檯休假：需要5位（早櫃、早班、晚櫃、洗碗、收班）
                    requiredMorningWorkers = 2; // 早櫃、早班
                    requiredEveningWorkers = 3; // 晚櫃、洗碗、收班
                }
                
                // 5. 計算已經休假的工讀生人數（不包括當前用戶）
                let morningVacationCount = 0;
                let eveningVacationCount = 0;
                
                const currentUserId = this.authManager.getCurrentUser().uid;
                
                for (const worker of outsideWorkers) {
                    if (worker.id === currentUserId) continue; // 不計算自己
                    
                    const vacationTimeKey = `${worker.id}-${year}-${month}`;
                    const workerVacationTimes = userVacationTimes[vacationTimeKey] || {};
                    const vacationData = workerVacationTimes[dateString];
                    
                    if (vacationData) {
                        if (vacationData.morning) {
                            morningVacationCount++;
                        }
                        if (vacationData.evening) {
                            eveningVacationCount++;
                        }
                    }
                }
                
                // 6. 計算可用的工讀生人數
                const availableMorningWorkers = totalWorkers - morningVacationCount - 1; // -1 是當前用戶
                const availableEveningWorkers = totalWorkers - eveningVacationCount - 1;
                
                // 7. 判斷是否允許休假
                if (requestMorning && requiredMorningWorkers > 0) {
                    if (availableMorningWorkers < requiredMorningWorkers) {
                        return { 
                            allowed: false, 
                            message: `當日早上工讀生已休滿，需要至少${requiredMorningWorkers}位工讀生上早班` 
                        };
                    }
                }
                
                if (requestEvening && requiredEveningWorkers > 0) {
                    if (availableEveningWorkers < requiredEveningWorkers) {
                        return { 
                            allowed: false, 
                            message: `當日晚上工讀生已休滿，需要至少${requiredEveningWorkers}位工讀生上晚班` 
                        };
                    }
                }
                
                return { allowed: true };
            }

            // 檢查工人是否可以在特定時間工作
            isWorkerAvailableForShift(worker, dateString, shift, workerVacationTimes) {
                const workerVacationData = workerVacationTimes[worker.username]?.[dateString];
                
                if (!workerVacationData) {
                    // 沒有休假記錄，可以工作
                    return true;
                }
                
                const morningShifts = ["早櫃", "早班"];
                const eveningShifts = ["晚櫃", "晚班", "洗碗", "收班"];
                
                if (morningShifts.includes(shift)) {
                    // 早上班次，檢查是否早上休假
                    return !workerVacationData.morning;
                } else if (eveningShifts.includes(shift)) {
                    // 晚上班次，檢查是否晚上休假
                    return !workerVacationData.evening;
                }
                
                return true;
            }
            
            // 外場排班系統 (Generator - 無變動)
            async generateOutsideSchedule(year, month, startDay = 1, endDay = null) {
                const allUsers = this.scheduleManager.getAllUsers();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, userAvailability = {}, outsideSchedule = {} } = allData;
                
                const outsideWorkers = allUsers.filter(u => u.role === "外場工讀生");
                const counterStaff = allUsers.filter(u => u.role === "外場櫃檯");
                
                // 獲取勾選框狀態，只排有勾選的工讀生
                const availableWorkers = outsideWorkers.filter(worker => {
                    const checkbox = document.getElementById(`worker-${worker.id}`);
                    return checkbox ? checkbox.checked : true;
                });
                
                if (availableWorkers.length === 0) {
                    this.uiManager.showToast('沒有外場工讀生可以排班');
                    return;
                }
                
                const lastDayOfMonth = new Date(year, month, 0).getDate();
                const actualEndDay = endDay || lastDayOfMonth;
                
                // 複製舊排班資料，但清空即將生成的日期範圍
                const newSchedule = { ...outsideSchedule };
                
                // 清除指定日期範圍的舊排班數據
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    delete newSchedule[dateString];
                }
                
                // 獲取櫃檯休假日期
                const counterVacations = [];
                counterStaff.forEach(staff => {
                    const vacationKey = `${staff.id}-${year}-${month}`;
                    const vacations = userVacations[vacationKey] || [];
                    vacations.forEach(date => {
                        counterVacations.push({ date, staff: staff.username });
                    });
                });
                
                // 獲取工讀生不可上班日期和分時段休假
                const workerUnavailability = {};
                const workerVacationTimes = {};
                availableWorkers.forEach(worker => {
                    const availabilityKey = `${worker.id}-${year}-${month}`;
                    const vacationTimeKey = `${worker.id}-${year}-${month}`;
                    workerUnavailability[worker.username] = userAvailability[availabilityKey] || [];
                    workerVacationTimes[worker.username] = allData.userVacationTimes?.[vacationTimeKey] || {};
                });
                
                // 計算每個工讀生的工作天數
                const workerWorkDays = {};
                availableWorkers.forEach(worker => {
                    workerWorkDays[worker.username] = 0;
                });
                
                for (let day = startDay; day <= actualEndDay; day++) {
                    const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay();
                    
                    // 跳過星期四（公休日）
                    if (dayOfWeek === 4) continue;
                    
                    // 檢查是否有櫃檯休假
                    const counterVacation = counterVacations.find(cv => cv.date === dateString);
                    
                    // 使用統一的排班邏輯
                    const daySchedule = this.generateDaySchedule(
                        dateString, 
                        dayOfWeek, 
                        counterVacation, 
                        availableWorkers, 
                        workerUnavailability, 
                        workerVacationTimes, 
                        workerWorkDays
                    );
                    
                    if (daySchedule.length > 0) {
                        newSchedule[dateString] = daySchedule;
                    }
                }
                
                // 更新排班資料
                await this.scheduleManager.updateOutsideSchedule(newSchedule);
            }

            // 內場工讀生代班按鈕 (無變動)
            async handleCoverShiftAction(e) {
                // 防止預設行為和事件冒泡
                e.preventDefault();
                e.stopPropagation();
                
                const button = e.target;
                const shiftId = button.dataset.id;
                const allData = this.scheduleManager.getAllData();
                const { coverSignups: currentCoverSignups = {} } = allData;
                
                if (button.classList.contains('signup-cover-btn')) {
                    if (currentCoverSignups[shiftId]) return this.uiManager.showToast('此班次已被預約！');
                    
                    try {
                        await this.scheduleManager.updateCoverSignups({ ...currentCoverSignups, [shiftId]: this.authManager.getCurrentUser().uid });
                        this.uiManager.showToast('成功預約代班！');
                    } catch (error) {
                        console.error('預約代班失敗:', error);
                        this.uiManager.showToast('預約代班失敗，請稍後再試。');
                    }
                } else if (button.classList.contains('cancel-cover-btn')) {
                    if (currentCoverSignups[shiftId] === this.authManager.getCurrentUser().uid) {
                        try {
                            const newCoverSignups = { ...currentCoverSignups };
                            delete newCoverSignups[shiftId];
                            
                            console.log('取消代班前:', currentCoverSignups);
                            console.log('取消代班後:', newCoverSignups);
                            
                            await this.scheduleManager.updateCoverSignups(newCoverSignups);
                            this.uiManager.showToast('已取消代班。');
                        } catch (error) {
                            console.error('取消代班失敗:', error);
                            this.uiManager.showToast('取消代班失敗，請稍後再試。');
                        }
                    } else {
                        this.uiManager.showToast('您無法取消其他人的代班。');
                    }
                }
            }

            // 手動新增排班 (無變動)
            async handleManualAssignment(e) {
                e.preventDefault();
                const form = document.getElementById('manual-assignment-form');
                const date = form.querySelector('#assignment-date').value;
                const username = form.querySelector('#assignment-user').value.trim();
                const assignedShift = form.querySelector('#assignment-role').value; // Reads the dynamically updated value

                if (!date || !username || !assignedShift) return this.uiManager.showToast('所有欄位皆為必填。');

                const allData = this.scheduleManager.getAllData();
                const { manualAssignments = {} } = allData;
                
                const dayAssignmentsData = manualAssignments[date] || {};
                const dayAssignments = Array.isArray(dayAssignmentsData) 
                    ? dayAssignmentsData 
                    : Object.values(dayAssignmentsData);
                
                const newAssignment = { username, assignedShift };
                const newDayAssignments = [...dayAssignments, newAssignment];
                const newManualAssignments = { ...manualAssignments, [date]: newDayAssignments };

                await this.scheduleManager.updateManualAssignments(newManualAssignments);
                this.uiManager.showToast('手動排班已新增！');
                form.reset();
            }

            // 刪除手動排班 (無變動)
            async handleDeleteManualAssignment(dateString, username, assignedShift) {
                console.log('開始刪除手動排班:', { dateString, username, assignedShift });
                
                if (this.authManager.getCurrentUserData()?.role !== this.ADMIN_ROLE) {
                    console.log('非管理者嘗試刪除，被拒絕');
                    this.uiManager.showToast('僅管理者可刪除此班次。');
                    return;
                }

                const allData = this.scheduleManager.getAllData();
                const { manualAssignments = {}, userAvailability = {}, userVacations = {}, coverSignups = {} } = allData;
                
                if (!manualAssignments[dateString]) {
                    console.log('該日期沒有手動排班資料');
                    this.uiManager.showToast('該日期沒有手動排班資料。');
                    return;
                }

                const dayAssignmentsData = manualAssignments[dateString] || {};
                const dayAssignments = Array.isArray(dayAssignmentsData) 
                    ? dayAssignmentsData 
                    : Object.values(dayAssignmentsData);
                
                const targetIndex = dayAssignments.findIndex(a => a.username === username && a.assignedShift === assignedShift);
                
                if (targetIndex === -1) {
                    console.log('找不到匹配的排班記錄:', { dateString, username, assignedShift });
                    this.uiManager.showToast('找不到匹配的排班記錄。');
                    return;
                }
                
                const newManualAssignments = { ...manualAssignments };
                const updatedDayAssignments = [...dayAssignments];
                updatedDayAssignments.splice(targetIndex, 1); 
                
                if (updatedDayAssignments.length > 0) {
                    newManualAssignments[dateString] = JSON.parse(JSON.stringify(updatedDayAssignments));
                } else {
                    delete newManualAssignments[dateString];
                }

                const allUsers = this.scheduleManager.getAllUsers();
                const targetUser = allUsers.find(u => u.username === username);

                const [yearStr, monthStr] = dateString.split('-');
                const year = parseInt(yearStr, 10);
                const month = parseInt(monthStr, 10); 

                let newUserAvailability = { ...userAvailability };
                let newUserVacations = { ...userVacations };
                const currentCoverSignups = coverSignups;
                let newCoverSignups = { ...currentCoverSignups };

                if (targetUser) {
                    // Consider adjusting this logic if outside roles need different cleanup
                    if (targetUser.role === this.PART_TIMER_ROLE || targetUser.role === "外場工讀生") { 
                        const availabilityKey = `${targetUser.id}-${year}-${month}`;
                        const currentAvail = newUserAvailability[availabilityKey] || [];
                        const filteredAvail = currentAvail.filter(d => d !== dateString);
                        if (filteredAvail.length > 0) {
                            newUserAvailability[availabilityKey] = filteredAvail;
                        } else {
                            delete newUserAvailability[availabilityKey];
                        }
                        
                        const coverKeysToDelete = [];
                        Object.keys(newCoverSignups).forEach(signupId => {
                            const parts = signupId.split('-');
                            if (parts.length >= 5) {
                                const dateInId = parts.slice(parts.length - 4, parts.length - 1).join('-');
                                if (dateInId === dateString && newCoverSignups[signupId] === targetUser.id) {
                                    coverKeysToDelete.push(signupId);
                                }
                            }
                        });
                        coverKeysToDelete.forEach(key => delete newCoverSignups[key]);
                        
                    } else if (this.FULLTIME_ROLES.includes(targetUser.role) || targetUser.role === "外場櫃檯") {
                        const vacationKey = `${targetUser.id}-${year}-${month}`;
                        const currentVac = newUserVacations[vacationKey] || [];
                        if (!currentVac.includes(dateString)) {
                            newUserVacations[vacationKey] = [...currentVac, dateString];
                        }
                    }
                }

                console.log('取消代班前:', currentCoverSignups);
                console.log('取消代班後:', newCoverSignups);
                
                try {
                    await this.scheduleManager.updateMultiple({
                        manualAssignments: newManualAssignments,
                        userAvailability: newUserAvailability,
                        userVacations: newUserVacations,
                        coverSignups: newCoverSignups
                    });
                    console.log('所有欄位更新成功');
                } catch (error) {
                    console.error('所有欄位更新失敗:', error);
                    this.uiManager.showToast('更新資料失敗，請稍後再試。');
                    return;
                }

                this.uiManager.showToast('手動排班已刪除，已同步清理當日上班顯示！');
            }

            // 主渲染邏輯 (無變動)
            renderAppView() {
                const currentUserData = this.authManager.getCurrentUserData();
                if(!currentUserData) return;
                
                if (currentUserData.role !== this.ADMIN_ROLE) {
                    this.uiManager.toggleSettingsButton(true);
                } else {
                    this.uiManager.toggleSettingsButton(false);
                }

                if (this.FULLTIME_ROLES.includes(currentUserData.role) || currentUserData.role === this.ADMIN_ROLE) {
                    this.uiManager.showCalendarView();
                    if (currentUserData.role === this.ADMIN_ROLE) {
                        this.uiManager.updateAppSubtitle("團隊排班總覽");
                        this.renderAdminView();
                    } else {
                        this.uiManager.updateAppSubtitle("請在下方月曆選擇您的休假日。");
                        this.renderFullTimeView();
                    }
                } else if (currentUserData.role === this.PART_TIMER_ROLE) {
                    this.uiManager.showCalendarView();
                    this.uiManager.updateAppSubtitle("請從左方列表選擇您要代班的時段。");
                    this.renderPartTimerView();
                } else if (this.OUTSIDE_ROLES.includes(currentUserData.role)) {
                    this.uiManager.showCalendarView();
                    if (currentUserData.role === "外場櫃檯") {
                        this.uiManager.updateAppSubtitle("請在下方月曆選擇您的休假日 (每月最多5天)。");
                    } else {
                        this.uiManager.updateAppSubtitle("請在下方月曆標示您不能上班的日子。");
                    }
                    this.renderOutsideView();
                }
            }

            // 內場工讀生視圖 (無變動)
            async renderPartTimerView() {
                // ... (code remains the same) ...
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], coverSignups = {} } = allData;
                
                let availableCoverShifts = [];
                const allUsers = this.scheduleManager.getAllUsers();
                const fullTimeUsers = allUsers.filter(u => this.FULLTIME_ROLES.includes(u.role));
                
                fullTimeUsers.forEach(user => {
                    const vacationKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[vacationKey] || [];
                    monthlyVacations.forEach(dateString => {
                        const vacationDate = new Date(...dateString.split('-').map((n, i) => i === 1 ? n - 1 : n));
                        if (vacationDate.getDay() === 4 || adminHolidays.includes(dateString)) return;

                        const slots = (user.role === '内場備菜班') 
                            ? [{ key: 'AM', time: '10:00 - 14:00' }, { key: 'PM', time: '16:30 - 20:00' }]
                            : [{ key: 'AM', time: '10:30 - 14:00' }, { key: 'PM', time: '17:00 - 21:00' }];
                        
                        slots.forEach(slot => {
                            availableCoverShifts.push({
                                id: `cover-${user.id}-${dateString}-${slot.key}`,
                                date: dateString,
                                time: slot.time,
                                fullTimerName: user.username,
                                fullTimerRole: user.role,
                            });
                        });
                    });
                });
                
                availableCoverShifts.sort((a, b) => {
                    const roleOrder = { '内場備菜班': 1, '内場炸爐班': 2 };
                    if (roleOrder[a.fullTimerRole] !== roleOrder[b.fullTimerRole]) {
                        return roleOrder[a.fullTimerRole] - roleOrder[b.fullTimerRole];
                    }
                    return new Date(a.date) - new Date(b.date);
                });

                this.uiManager.calendarView.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8">
                        <div id="cover-shifts-panel" class="md:col-span-1 bg-gray-50 p-2 sm:p-4 rounded-lg h-fit">
                            <h3 class="font-bold text-lg mb-4 text-center">可代班列表</h3>
                            <div id="cover-shifts-list" class="space-y-3 max-h-[50vh] md:max-h-[60vh] overflow-y-auto"></div>
                        </div>
                        <div class="md:col-span-2">
                            <div id="calendar-header" class="flex items-center justify-between mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                                <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                            </div>
                            <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                            </div>
                            <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                            <p class="text-center text-sm text-gray-500 mt-4">點擊月曆日期來標示您的可上班時間。</p>
                        </div>
                    </div>
                `;

                const coverShiftsList = document.getElementById('cover-shifts-list');
                if (availableCoverShifts.length === 0) {
                    coverShiftsList.innerHTML = `<p class="text-center text-gray-500 p-4">本月尚無代班需求。</p>`;
                } else {
                    availableCoverShifts.forEach(shift => {
                        const isSignedUpByCurrentUser = coverSignups[shift.id] === this.authManager.getCurrentUser().uid;
                        const isTakenByOther = coverSignups[shift.id] && !isSignedUpByCurrentUser;
                        const card = document.createElement('div');
                        card.className = 'bg-white p-3 rounded-md shadow-sm border-l-4';
                        
                        let buttonHtml;
                        if (isSignedUpByCurrentUser) {
                            card.classList.add('border-green-500');
                            buttonHtml = `<button data-id="${shift.id}" class="cancel-cover-btn w-full mt-2 text-sm bg-red-500 text-white py-1 rounded hover:bg-red-600">取消代班</button>`;
                        } else if (isTakenByOther) {
                            card.classList.add('border-gray-300');
                            const taker = allUsers.find(u => u.id === coverSignups[shift.id]);
                            buttonHtml = `<div class="mt-2 text-sm text-center font-semibold bg-gray-200 text-gray-600 py-1 rounded">已被 ${taker ? taker.username : ''} 預約</div>`;
                        } else {
                            card.classList.add('border-indigo-500');
                            buttonHtml = `<button data-id="${shift.id}" class="signup-cover-btn w-full mt-2 text-sm bg-indigo-600 text-white py-1 rounded hover:bg-indigo-700">我要代班</button>`;
                        }

                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <p class="font-bold">${shift.date}</p>
                                <p class="text-sm font-semibold bg-gray-200 px-2 py-1 rounded">${shift.time}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">休假人員: ${shift.fullTimerName} (${shift.fullTimerRole})</p>
                            ${buttonHtml}
                        `;
                        coverShiftsList.appendChild(card);
                    });
                }
                
                await this.renderFullCalendar();
            }
            
            // 管理員視圖 (無變動)
            async renderAdminView() {
                this.uiManager.calendarView.innerHTML = `
                    <div>
                        <div class="flex items-center justify-center mb-6">
                            <div class="bg-gray-100 rounded-lg p-1">
                                <button id="inside-calendar-btn" class="px-4 py-2 rounded-md bg-indigo-600 text-white font-semibold">内場月曆</button>
                                <button id="outside-calendar-btn" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-200">外場月曆</button>
                            </div>
                        </div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                        </div>
                        <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                        <div id="admin-assignment-panel" class="mt-8 bg-indigo-50 border border-indigo-200 rounded-xl">
                            <button id="manual-assignment-toggle" class="w-full p-4 sm:p-6 text-left flex items-center justify-between hover:bg-indigo-100 transition-colors">
                                <h3 class="text-lg font-bold text-indigo-800">手動新增排班</h3>
                                <span id="manual-assignment-icon" class="material-icons-outlined text-indigo-600 transition-transform">expand_more</span>
                            </button>
                            <div id="manual-assignment-content" class="hidden px-4 sm:px-6 pb-4 sm:pb-6">
                                <form id="manual-assignment-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                                    <input type="date" id="assignment-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <input type="text" id="assignment-user" placeholder="輸入姓名" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <select id="assignment-role" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="" disabled selected>選擇班別</option>
                                    </select>
                                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">新增</button>
                                </form>
                            </div>
                        </div>
                        <div id="user-management-panel" class="mt-4 bg-red-50 border border-red-200 rounded-xl">
                            <button id="user-management-toggle" class="w-full p-4 sm:p-6 text-left flex items-center justify-between hover:bg-red-100 transition-colors">
                                <h3 class="text-lg font-bold text-red-800">用戶管理</h3>
                                <span id="user-management-icon" class="material-icons-outlined text-red-600 transition-transform">expand_more</span>
                            </button>
                            <div id="user-management-content" class="hidden px-4 sm:px-6 pb-4 sm:pb-6">
                                <div class="mb-4">
                                    <h4 class="text-md font-semibold mb-3 text-red-800">內場工讀生</h4>
                                    <div id="inside-workers-list" class="space-y-2">
                                        <!-- 內場工讀生列表將在這裡動態生成 -->
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h4 class="text-md font-semibold mb-3 text-red-800">外場工讀生</h4>
                                    <div id="outside-workers-list" class="space-y-2">
                                        <!-- 外場工讀生列表將在這裡動態生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="outside-schedule-panel" class="mt-4 bg-green-50 border border-green-200 rounded-xl">
                            <button id="outside-schedule-toggle" class="w-full p-4 sm:p-6 text-left flex items-center justify-between hover:bg-green-100 transition-colors">
                                <h3 class="text-lg font-bold text-green-800">外場排班管理</h3>
                                <span id="outside-schedule-icon" class="material-icons-outlined text-green-600 transition-transform">expand_more</span>
                            </button>
                            <div id="outside-schedule-content" class="hidden px-4 sm:px-6 pb-4 sm:pb-6">
                                <div class="flex flex-col sm:flex-row gap-4 items-center mb-4">
                                    <button id="generate-outside-schedule-btn" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                                        生成外場排班
                                    </button>
                                    <p class="text-sm text-green-700">根據櫃檯休假和工讀生不可上班日自動排班</p>
                                </div>
                                <div id="worker-availability-panel" class="mt-4">
                                    <h4 class="text-md font-semibold mb-3 text-green-800">工讀生可上櫃檯</h4>
                                    <div id="worker-checkboxes" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                                        </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-center text-sm text-gray-500 mt-4">點擊日期以設定或取消該日為全體公休日。</p>
                    </div>
                `;
                
                // 設置切換按鈕事件
                document.getElementById('inside-calendar-btn').addEventListener('click', () => {
                    this.currentCalendarView = 'inside';
                    this.updateCalendarToggleButtons(); // Will update dropdown
                    this.renderFullCalendar();
                });
                
                document.getElementById('outside-calendar-btn').addEventListener('click', () => {
                    this.currentCalendarView = 'outside';
                    this.updateCalendarToggleButtons(); // Will update dropdown
                    this.renderOutsideCalendar();
                });
                
                document.getElementById('generate-outside-schedule-btn').addEventListener('click', async () => {
                    // 使用台灣當前的實際日期，而不是月曆顯示的月份
                    const today = new Date();
                    const currentDay = today.getDate();
                    const currentMonth = today.getMonth() + 1; // 1-12
                    const currentYear = today.getFullYear();
                    
                    let targetYear, targetMonth;
                    
                    if (currentDay >= 25) {
                        // 25號之後：排下個月1-15號
                        targetMonth = currentMonth === 12 ? 1 : currentMonth + 1;
                        targetYear = currentMonth === 12 ? currentYear + 1 : currentYear;
                        await this.generateOutsideSchedule(targetYear, targetMonth, 1, 15);
                        this.uiManager.showToast(`已排${targetYear}年${targetMonth}月1-15號的班表`);
                    } else if (currentDay >= 10) {
                        // 10號之後：排本月16-31號
                        targetYear = currentYear;
                        targetMonth = currentMonth;
                        await this.generateOutsideSchedule(targetYear, targetMonth, 16);
                        this.uiManager.showToast(`已排${targetYear}年${targetMonth}月16-31號的班表`);
                    } else {
                        // 10號前：排整個月
                        targetYear = currentYear;
                        targetMonth = currentMonth;
                        await this.generateOutsideSchedule(targetYear, targetMonth);
                        this.uiManager.showToast(`已排${targetYear}年${targetMonth}月整月的班表`);
                    }
                    
                    // 切換月曆到排好班的月份
                    this.calendarManager.setCalendarDate(new Date(targetYear, targetMonth - 1, 1));
                    
                    // 切換到外場月曆視圖並更新按鈕樣式
                    this.currentCalendarView = 'outside';
                    this.updateCalendarToggleButtons();
                    this.renderOutsideCalendar();
                });
                
                // 用戶管理面板折叠/展开
                document.getElementById('user-management-toggle').addEventListener('click', () => {
                    const content = document.getElementById('user-management-content');
                    const icon = document.getElementById('user-management-icon');
                    
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.classList.add('hidden');
                        icon.textContent = 'expand_more';
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // 外場排班管理面板折叠/展开
                document.getElementById('outside-schedule-toggle').addEventListener('click', () => {
                    const content = document.getElementById('outside-schedule-content');
                    const icon = document.getElementById('outside-schedule-icon');
                    
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.classList.add('hidden');
                        icon.textContent = 'expand_more';
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // 手動新增排班面板折叠/展开
                document.getElementById('manual-assignment-toggle').addEventListener('click', () => {
                    const content = document.getElementById('manual-assignment-content');
                    const icon = document.getElementById('manual-assignment-icon');
                    
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        icon.textContent = 'expand_less';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.classList.add('hidden');
                        icon.textContent = 'expand_more';
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // 初始化為內場月曆
                this.currentCalendarView = 'inside';
                this.updateCalendarToggleButtons(); // Initial dropdown population
                await this.renderFullCalendar();
                
                // 生成工讀生勾選框
                this.generateWorkerCheckboxes();
                
                // 生成用戶管理列表
                this.generateUserManagementLists();
            }

            // 更新按鈕樣式 + 更新下拉選單 (無變動)
            updateCalendarToggleButtons() {
                const insideBtn = document.getElementById('inside-calendar-btn');
                const outsideBtn = document.getElementById('outside-calendar-btn');
                const assignmentRoleSelect = document.getElementById('assignment-role');
                
                // Clear existing options except the first disabled one
                assignmentRoleSelect.innerHTML = '<option value="" disabled selected>選擇班別</option>';

                let shiftsToAdd = [];
                if (this.currentCalendarView === 'inside') {
                    insideBtn.className = 'px-4 py-2 rounded-md bg-indigo-600 text-white font-semibold';
                    outsideBtn.className = 'px-4 py-2 rounded-md text-gray-600 hover:bg-gray-200';
                    shiftsToAdd = this.insideShifts; // Use inside shifts
                } else {
                    insideBtn.className = 'px-4 py-2 rounded-md text-gray-600 hover:bg-gray-200';
                    outsideBtn.className = 'px-4 py-2 rounded-md bg-indigo-600 text-white font-semibold';
                    shiftsToAdd = this.outsideShifts; // Use outside shifts
                }

                // Add new options
                shiftsToAdd.forEach(shift => {
                    const option = document.createElement('option');
                    option.value = shift;
                    option.textContent = shift;
                    assignmentRoleSelect.appendChild(option);
                });
            }

            // 生成工讀生勾選框 (無變動)
            generateWorkerCheckboxes() {
                // ... (code remains the same) ...
                const workerCheckboxesContainer = document.getElementById('worker-checkboxes');
                if (!workerCheckboxesContainer) return;
                
                const allUsers = this.scheduleManager.getAllUsers();
                const outsideWorkers = allUsers.filter(u => u.role === "外場工讀生");
                
                workerCheckboxesContainer.innerHTML = '';
                
                outsideWorkers.forEach(worker => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center space-x-2 p-2 bg-white rounded border';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `worker-${worker.id}`;
                    checkbox.className = 'rounded border-gray-300 text-green-600 focus:ring-green-500';
                    checkbox.checked = true; // 預設為可上班
                    
                    const label = document.createElement('label');
                    label.htmlFor = `worker-${worker.id}`;
                    label.className = 'text-sm font-medium text-gray-700';
                    label.textContent = worker.username;
                    
                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    workerCheckboxesContainer.appendChild(checkboxDiv);
                });
            }

            // 生成用戶管理列表
            generateUserManagementLists() {
                const allUsers = this.scheduleManager.getAllUsers();
                const insideWorkers = allUsers.filter(u => u.role === "内場工讀生");
                const outsideWorkers = allUsers.filter(u => u.role === "外場工讀生");
                
                // 生成內場工讀生列表
                const insideWorkersList = document.getElementById('inside-workers-list');
                if (insideWorkersList) {
                    insideWorkersList.innerHTML = '';
                    if (insideWorkers.length === 0) {
                        insideWorkersList.innerHTML = '<p class="text-gray-500 text-sm">暫無內場工讀生</p>';
                    } else {
                        insideWorkers.forEach(worker => {
                            const workerDiv = document.createElement('div');
                            workerDiv.className = 'flex items-center justify-between p-3 bg-white rounded border';
                            workerDiv.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <span class="material-icons-outlined text-gray-600">person</span>
                                    <div>
                                        <p class="font-semibold text-gray-800">${worker.username}</p>
                                        <p class="text-sm text-gray-500">${worker.role}</p>
                                    </div>
                                </div>
                                <button class="delete-user-btn px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600" 
                                        data-user-id="${worker.id}" 
                                        data-username="${worker.username}" 
                                        data-role="${worker.role}">
                                    刪除
                                </button>
                            `;
                            insideWorkersList.appendChild(workerDiv);
                        });
                    }
                }
                
                // 生成外場工讀生列表
                const outsideWorkersList = document.getElementById('outside-workers-list');
                if (outsideWorkersList) {
                    outsideWorkersList.innerHTML = '';
                    if (outsideWorkers.length === 0) {
                        outsideWorkersList.innerHTML = '<p class="text-gray-500 text-sm">暫無外場工讀生</p>';
                    } else {
                        outsideWorkers.forEach(worker => {
                            const workerDiv = document.createElement('div');
                            workerDiv.className = 'flex items-center justify-between p-3 bg-white rounded border';
                            workerDiv.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <span class="material-icons-outlined text-gray-600">person</span>
                                    <div>
                                        <p class="font-semibold text-gray-800">${worker.username}</p>
                                        <p class="text-sm text-gray-500">${worker.role}</p>
                                    </div>
                                </div>
                                <button class="delete-user-btn px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600" 
                                        data-user-id="${worker.id}" 
                                        data-username="${worker.username}" 
                                        data-role="${worker.role}">
                                    刪除
                                </button>
                            `;
                            outsideWorkersList.appendChild(workerDiv);
                        });
                    }
                }
            }

            // 正職人員視圖 (無變動)
            async renderFullTimeView() {
                // ... (code remains the same) ...
                this.uiManager.calendarView.innerHTML = `
                    <div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                        </div>
                        <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                        <p class="text-center text-sm text-gray-500 mt-4"></p>
                    </div>
                `;
                 const instructions = this.uiManager.calendarView.querySelector('p');
                 instructions.textContent = "請點擊日期選擇您的休假日 (每月最多5天)。"; // Simplified for non-admin
                 await this.renderFullCalendar();
            }

            // 外場人員視圖 (無變動)
            async renderOutsideView() {
                // ... (code remains the same) ...
                const currentUserData = this.authManager.getCurrentUserData();
                const isWorker = currentUserData.role === "外場工讀生";
                
                 this.uiManager.calendarView.innerHTML = `
                    <div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                        </div>
                        <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                        <p class="text-center text-sm text-gray-500 mt-4"></p>
                        ${isWorker ? `
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h3 class="text-center font-bold text-blue-900 mb-3">📋 班次時間表</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-purple-700">早櫃</span>
                                    <span class="text-gray-700">10:30 - 14:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-purple-700">晚櫃</span>
                                    <span class="text-gray-700">16:40 - 21:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-blue-700">早班</span>
                                    <span class="text-gray-700">11:30 - 14:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-orange-700">洗碗</span>
                                    <span class="text-gray-700">17:30 - 20:00</span>
                                </div>
                                <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                    <span class="font-semibold text-green-700">收班</span>
                                    <span class="text-gray-700">18:00 - 22:00</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                const instructions = this.uiManager.calendarView.querySelector('p');
                if (currentUserData.role === "外場櫃檯") {
                    instructions.textContent = "請點擊日期選擇您的休假日 (每月最多5天)。";
                } else {
                    instructions.textContent = "請點擊日期標示您不能上班的日子 / 點擊已排班日期找人代班。"; // Updated instruction
                }
                
                await this.renderOutsideCalendar();
            }

            // 渲染內場完整月曆 (修改 - 修正 橙色警告 邏輯)
            async renderFullCalendar() {
                this.calendarManager.getCalendarDate().setDate(1);
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                
                document.getElementById('calendar-month-year').textContent = `${year}年 ${month + 1}月`;
                
                const holidays = await this.calendarManager.fetchHolidays(year);
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], coverSignups = {}, userAvailability = {}, manualAssignments = {} } = allData;

                const dailySchedule = {};
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dailySchedule[dateString] = [];
                }

                const allUsers = this.scheduleManager.getAllUsers();
                allUsers.filter(u => this.FULLTIME_ROLES.includes(u.role)).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[userMonthKey] || [];
                    for (let i = 1; i <= lastDayOfMonth; i++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        if (!monthlyVacations.includes(dateString)) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    }
                });

                Object.keys(coverSignups).forEach(coverId => {
                    const parts = coverId.split('-');
                    if (parts.length < 5) return;
                    const dateString = parts.slice(parts.length - 4, parts.length - 1).join('-');
                    const timeSlot = parts[parts.length - 1];
                    const date = new Date(dateString);

                    if (date.getFullYear() === year && date.getMonth() === month) {
                         const ptUserId = coverSignups[coverId];
                         const ptUser = allUsers.find(u => u.id === ptUserId);
                         const fullTimerId = parts.slice(1, parts.length - 4).join('-');
                         const originalFullTimer = allUsers.find(u => u.id === fullTimerId);

                         if(ptUser && originalFullTimer) {
                            dailySchedule[dateString].push({ username: ptUser.username, role: originalFullTimer.role, isCover: true, timeSlot });
                         }
                    }
                });
                
                allUsers.filter(u => u.role === this.PART_TIMER_ROLE).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyAvailability = userAvailability[userMonthKey] || [];
                    monthlyAvailability.forEach(dateString => {
                        const alreadyScheduled = dailySchedule[dateString].some(s => s.username === user.username);
                        if (!alreadyScheduled) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    });
                });

                // --- Render Manual Assignments ---
                Object.keys(manualAssignments).forEach(dateString => {
                    const assignments = manualAssignments[dateString] || [];
                    // Ensure assignments is always an array
                    const assignmentsArray = Array.isArray(assignments) ? assignments : Object.values(assignments);

                    if (dailySchedule[dateString] && assignmentsArray.length > 0) {
                         assignmentsArray.forEach(assignment => {
                            // Check if this shift belongs to the inside view
                            if (this.insideShifts.includes(assignment.assignedShift)) {
                                let role = '';
                                let timeSlot = 'FullDay';
                                const assignedShift = assignment.assignedShift;

                                if (assignedShift.includes('備菜班')) role = '内場備菜班';
                                else if (assignedShift.includes('炸爐班')) role = '内場炸爐班';
                                else if (assignedShift === '收班') role = '内場工讀生';

                                if (assignedShift.includes('早')) timeSlot = 'AM';
                                else if (assignedShift.includes('晚')) timeSlot = 'PM';

                                dailySchedule[dateString].push({ 
                                    username: assignment.username, 
                                    role: role, 
                                    isCover: true, // Treat as cover for simplicity in logic
                                    timeSlot: timeSlot,
                                    isManual: true,
                                    assignedShift: assignment.assignedShift
                                });
                            }
                        });
                    }
                });
                // --- End Render Manual Assignments ---


                const calendarGrid = document.getElementById('calendar-grid');
                calendarGrid.innerHTML = '';
                const firstDayIndex = this.calendarManager.getCalendarDate().getDay();
                const prevLastDay = new Date(year, month, 0).getDate();
                for (let i = firstDayIndex; i > 0; i--) {
                    calendarGrid.innerHTML += `<div class="p-1 sm:p-2 text-center text-gray-300 no-hover">${prevLastDay - i + 1}</div>`;
                }

                const todayString = new Date().toISOString().split('T')[0];
                const currentUserData = this.authManager.getCurrentUserData();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const day = document.createElement('div');
                    const isThursday = new Date(year, month, i).getDay() === 4;
                    const holidayName = holidays.get(dateString);
                    const isAdminHoliday = adminHolidays.includes(dateString);

                    day.className = `calendar-day p-1 rounded-lg text-left text-[10px] sm:text-xs`;
                    day.dataset.date = dateString;

                    if (isThursday || isAdminHoliday) {
                        day.classList.add('bg-red-100');
                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800">${i}</span></div><div class="flex-grow flex items-center justify-center"><p class="font-bold text-red-700 text-xs sm:text-sm">公休日</p></div>`;
                        if (currentUserData.role === this.ADMIN_ROLE && !isThursday) day.classList.add('cursor-pointer'); 
                    } else {
                        // ======================================================
                        // === (MODIFIED) Inside Shift Shortage Check (Orange BG) ===
                        // ======================================================
                        const workingUsers = dailySchedule[dateString] || [];
                        let isShortage = false;

                        // Helper function to check for AM/PM/FullDay presence
                        const hasShift = (role, time) => {
                            // 'role' will be '内場備菜班' or '内場炸爐班'
                            
                            if (time === 'FullDay') {
                                return workingUsers.some(w => 
                                    (w.role === role && w.timeSlot === 'FullDay' && !w.isCover) || // Full-timer
                                    (w.isManual && w.assignedShift === `${role.replace('内場', '')} (全日)`) // *** FIX *** e.g., '備菜班 (全日)'
                                );
                            }
                            if (time === 'AM') {
                                return workingUsers.some(w => 
                                    (w.role === role && w.isCover && w.timeSlot === 'AM' && !w.isManual) || // PT Cover (from vacation)
                                    (w.isManual && w.assignedShift === `${role.replace('内場', '')} (早)`) // *** FIX *** e.g., '備菜班 (早)'
                                );
                            }
                            if (time === 'PM') {
                                return workingUsers.some(w => 
                                    (w.role === role && w.isCover && w.timeSlot === 'PM' && !w.isManual) || // PT Cover (from vacation)
                                    (w.isManual && w.assignedShift === `${role.replace('内場', '')} (晚)`) // *** FIX *** e.g., '備菜班 (晚)'
                                );
                            }
                            return false;
                        };
                        
                        // 1. Check 備菜班
                        const isBekaiCovered = hasShift('内場備菜班', 'FullDay') || (hasShift('内場備菜班', 'AM') && hasShift('内場備菜班', 'PM'));
                        
                        // 2. Check 炸爐班
                        const isJaluCovered = hasShift('内場炸爐班', 'FullDay') || (hasShift('内場炸爐班', 'AM') && hasShift('内場炸爐班', 'PM'));

                        // 3. Check 收班 (PT availability or manual)
                        const isShoubanCovered = workingUsers.some(w => 
                            (w.role === this.PART_TIMER_ROLE && w.timeSlot === 'FullDay' && !w.isCover) || // From userAvailability
                            (w.isManual && w.assignedShift === '收班') // Manual '收班'
                        );
                        
                        if (!(isBekaiCovered && isJaluCovered && isShoubanCovered)) {
                            isShortage = true;
                        }

                        if (isShortage) {
                            day.classList.add('bg-orange-100');
                        } else if (holidayName) {
                            day.classList.add('bg-yellow-100');
                        }
                        // ===============================================
                        // === (END) Modified Inside Shift Shortage Check ===
                        // ===============================================
                        
                        // Make clickable for relevant roles
                        if (this.FULLTIME_ROLES.includes(currentUserData.role) || currentUserData.role === this.PART_TIMER_ROLE || currentUserData.role === this.ADMIN_ROLE) {
                            day.classList.add('cursor-pointer');
                        }

                        // const workingUsers = dailySchedule[dateString] || []; // (Moved up)
                        let usersHtml = '<div class="flex-grow"></div>';
                        if (workingUsers.length > 0) {
                            // Sort logic remains the same for inside view
                             const getSortOrder = (workInfo) => {
                                const { role, isCover, timeSlot, isManual, assignedShift } = workInfo;
                                
                                // Handle manual shifts first
                                if (isManual) {
                                    if (assignedShift.includes('備菜班 (早)')) return 1;
                                    if (assignedShift.includes('備菜班 (晚)')) return 2;
                                    if (assignedShift.includes('備菜班 (全日)')) return 3;
                                    if (assignedShift.includes('炸爐班 (早)')) return 4;
                                    if (assignedShift.includes('炸爐班 (晚)')) return 5;
                                    if (assignedShift.includes('炸爐班 (全日)')) return 6;
                                    if (assignedShift === '收班') return 7;
                                }

                                // Handle non-manual shifts
                                if (role === '内場備菜班') {
                                    if (isCover) return timeSlot === 'AM' ? 1 : 2; // PT Cover
                                    return 3; // Full-timer
                                }
                                if (role === '内場炸爐班') {
                                    if (isCover) return timeSlot === 'AM' ? 4 : 5; // PT Cover
                                    return 6; // Full-timer
                                }
                                if (role === this.PART_TIMER_ROLE) {
                                    return 7; // 收 (from availability)
                                }
                                return 99;
                            };
                            workingUsers.sort((a, b) => getSortOrder(a) - getSortOrder(b));

                            const userListHtml = workingUsers.map(workInfo => {
                                const { username, role, isCover, timeSlot, isManual, assignedShift } = workInfo; // Added assignedShift
                                let displayLabel = '';
                                let colorClass = '';
                                
                                const originalUser = allUsers.find(u => u.username === username);
                                const userRole = originalUser ? originalUser.role : (role === this.PART_TIMER_ROLE ? this.PART_TIMER_ROLE : null);

                                if (userRole === this.PART_TIMER_ROLE || isManual) {
                                     if (isManual) { // Handle manual assignment labels
                                        if (assignedShift === '備菜班 (早)') displayLabel = '(早備)';
                                        else if (assignedShift === '備菜班 (晚)') displayLabel = '(晚備)';
                                        else if (assignedShift === '備菜班 (全日)') displayLabel = '(備)';
                                        else if (assignedShift === '炸爐班 (早)') displayLabel = '(早炸)';
                                        else if (assignedShift === '炸爐班 (晚)') displayLabel = '(晚炸)';
                                        else if (assignedShift === '炸爐班 (全日)') displayLabel = '(炸)';
                                        else if (assignedShift === '收班') displayLabel = '(收)';
                                    } else if (isCover) { // Handle cover shift labels
                                        if (role === '内場備菜班') displayLabel = `(${timeSlot === 'AM' ? '早備' : '晚備'})`;
                                        else if (role === '内場炸爐班') displayLabel = `(${timeSlot === 'AM' ? '早炸' : '晚炸'})`;
                                    } else { // Handle regular part-timer shift (from availability)
                                        displayLabel = '(收)';
                                    }
                                } else { // Handle full-time regular shift
                                    if (role === '内場備菜班') displayLabel = '(備)';
                                    else if (role === '内場炸爐班') displayLabel = '(炸)';
                                }
                                
                                // Assign color based on the final determined role/shift
                                if (displayLabel.includes('備')) colorClass = 'font-semibold text-green-800';
                                else if (displayLabel.includes('炸')) colorClass = 'font-semibold text-amber-800';
                                else if (displayLabel.includes('收')) colorClass = 'font-semibold text-blue-800';
                                else colorClass = 'text-gray-800'; // Default color
                                
                                const deleteButtonHtml = (currentUserData.role === this.ADMIN_ROLE && isManual)
                                    ? `<button data-date="${dateString}" data-username="${username}" data-shift="${assignedShift || ''}" class="delete-manual-assignment-btn text-red-400 hover:text-red-700 font-bold">&times;</button>`
                                    : '';

                                return `<div class="flex items-center justify-between w-full">
                                            <span class="${colorClass}">${username}${displayLabel}</span>
                                            ${deleteButtonHtml}
                                        </div>`;

                            }).join('');
                            usersHtml = `<div class="mt-1 text-gray-600 leading-tight overflow-hidden">${userListHtml}</div>`;
                        }
                        
                        let selfStatusHtml = '';
                        if (currentUserData.role === this.ADMIN_ROLE) {
                            if(!holidayName && !isShortage) day.classList.add('bg-gray-50'); // (MODIFIED)
                        } else if (this.FULLTIME_ROLES.includes(currentUserData.role)) {
                            const vacationKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const isVacation = (userVacations[vacationKey] || []).includes(dateString);
                            if (isVacation) {
                                day.classList.add('bg-red-100', 'border', 'border-red-400');
                                selfStatusHtml = `<p class="font-semibold text-red-700">休假</p>`;
                            } else {
                                if(!holidayName && !isShortage) day.classList.add('bg-green-100'); // (MODIFIED)
                                day.classList.add('border', 'border-green-400');
                                selfStatusHtml = `<p class="font-semibold text-green-700">上班日</p>`;
                            }
                        } else if (currentUserData.role === this.PART_TIMER_ROLE) {
                            const availabilityKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const isAvailable = (userAvailability[availabilityKey] || []).includes(dateString);
                            const isWorkingCoverShift = workingUsers.some(w => w.username === currentUserData.username && w.isCover && !w.isManual);
                            const isWorkingManual = workingUsers.some(w => w.username === currentUserData.username && w.isManual);
                            const isWorkingAvailability = workingUsers.some(w => w.username === currentUserData.username && w.role === this.PART_TIMER_ROLE && !w.isCover && !w.isManual);


                            if (isWorkingCoverShift || isWorkingManual || isWorkingAvailability) { // If working (any type)
                                if(!holidayName && !isShortage) day.classList.add('bg-blue-100'); // (MODIFIED)
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="font-bold text-blue-700">上班</p>`;
                            } else if (isAvailable) { // Available but not assigned cover/manual
                                if(!holidayName && !isShortage) day.classList.add('bg-blue-100'); // (MODIFIED)
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="font-semibold text-blue-700">要上班</p>`; // Still marked as "要上班"
                            } else { // Not available
                                if(!holidayName && !isShortage) day.classList.add('bg-white'); // (MODIFIED)
                                selfStatusHtml = `<p class="text-gray-400">休息</p>`;
                            }
                        }

                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800 text-xs sm:text-sm">${i}</span>${holidayName ? `<p class="text-[9px] sm:text-[11px] font-bold text-yellow-800">${holidayName}</p>` : ''}${selfStatusHtml}</div>${usersHtml}`;
                    }
                    
                    if (dateString === todayString) day.classList.add('today');
                    calendarGrid.appendChild(day);
                }
            }

            // 渲染外場月曆 (無變動)
            async renderOutsideCalendar() {
                this.calendarManager.getCalendarDate().setDate(1);
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                
                document.getElementById('calendar-month-year').textContent = `${year}年 ${month + 1}月`;
                
                const holidays = await this.calendarManager.fetchHolidays(year);
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], userAvailability = {}, outsideSchedule = {}, manualAssignments = {}, userVacationTimes = {} } = allData; 

                const dailySchedule = {};
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dailySchedule[dateString] = [];
                }

                // --- Render Auto-Generated Outside Schedule ---
                Object.keys(outsideSchedule).forEach(dateString => {
                    const assignments = outsideSchedule[dateString] || [];
                     const assignmentsArray = Array.isArray(assignments) ? assignments : Object.values(assignments);
                    if (dailySchedule[dateString] && assignmentsArray.length > 0) {
                        assignmentsArray.forEach(assignment => {
                            dailySchedule[dateString].push({
                                username: assignment.username,
                                role: assignment.role, // "外場工讀生"
                                shift: assignment.shift, // "早班", "洗碗", etc.
                                isManual: false // Mark as not manual
                            });
                        });
                    }
                });
                
                // --- Render Manual Assignments (for Outside) ---
                 Object.keys(manualAssignments).forEach(dateString => {
                    const assignments = manualAssignments[dateString] || [];
                    const assignmentsArray = Array.isArray(assignments) ? assignments : Object.values(assignments);

                    if (dailySchedule[dateString] && assignmentsArray.length > 0) {
                         assignmentsArray.forEach(assignment => {
                            // Check if this shift belongs to the outside view
                            if (this.outsideShifts.includes(assignment.assignedShift)) {
                                let role = "外場工讀生"; // Default
                                if (assignment.assignedShift === "櫃檯") {
                                    role = "外場櫃檯";
                                }
                                
                                dailySchedule[dateString].push({ 
                                    username: assignment.username, 
                                    role: role, 
                                    shift: assignment.assignedShift, // Use the assigned shift directly
                                    isManual: true // Mark as manual
                                });
                            }
                        });
                    }
                });
                // --- End Render Manual Assignments ---

                // 添加櫃檯人員的正常上班（非休假日期）
                const allUsers = this.scheduleManager.getAllUsers();
                const counterStaff = allUsers.filter(u => u.role === "外場櫃檯");
                
                counterStaff.forEach(staff => {
                    const vacationKey = `${staff.id}-${year}-${month + 1}`;
                    const monthlyVacations = userVacations[vacationKey] || [];
                    
                    for (let i = 1; i <= lastDayOfMonth; i++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        const date = new Date(year, month, i);
                        const dayOfWeek = date.getDay();
                        
                        // Skip Thursday, vacation days, AND if already manually assigned as "櫃檯"
                        const isManuallyAssignedCounter = dailySchedule[dateString]?.some(s => s.isManual && s.role === "外場櫃檯" && s.username === staff.username);
                        if (dayOfWeek === 4 || monthlyVacations.includes(dateString) || isManuallyAssignedCounter) continue;
                        
                        // Check if ANY counter is scheduled (auto or manual)
                        const hasCounter = dailySchedule[dateString]?.some(s => s.role === "外場櫃檯" || s.shift === "櫃檯");
                        if (!hasCounter) {
                            dailySchedule[dateString].push({
                                username: staff.username,
                                role: "外場櫃檯",
                                shift: "櫃檯", // Standard shift for non-vacation counter staff
                                isManual: false
                            });
                        }
                    }
                });

                const calendarGrid = document.getElementById('calendar-grid');
                calendarGrid.innerHTML = '';
                const firstDayIndex = this.calendarManager.getCalendarDate().getDay();
                const prevLastDay = new Date(year, month, 0).getDate();
                for (let i = firstDayIndex; i > 0; i--) {
                    calendarGrid.innerHTML += `<div class="p-1 sm:p-2 text-center text-gray-300 no-hover">${prevLastDay - i + 1}</div>`;
                }

                const todayString = new Date().toISOString().split('T')[0];
                const currentUserData = this.authManager.getCurrentUserData();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const day = document.createElement('div');
                    const isThursday = new Date(year, month, i).getDay() === 4;
                    const holidayName = holidays.get(dateString);
                    const isAdminHoliday = adminHolidays.includes(dateString);

                    day.className = `calendar-day p-1 rounded-lg text-left text-[10px] sm:text-xs`;
                    day.dataset.date = dateString;

                    if (isThursday || isAdminHoliday) {
                        day.classList.add('bg-red-100');
                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800">${i}</span></div><div class="flex-grow flex items-center justify-center"><p class="font-bold text-red-700 text-xs sm:text-sm">公休日</p></div>`;
                        // Admins can still click non-Thursday holidays
                        if (currentUserData.role === this.ADMIN_ROLE && !isThursday) day.classList.add('cursor-pointer');
                    } else {
                        // ===============================================
                        // === (NEW) Shift Shortage Check (Orange BG) ===
                        // ===============================================
                        const date = new Date(year, month, i);
                        const dayOfWeek = date.getDay();
                        const workingUsers = dailySchedule[dateString] || [];
                        const numShifts = workingUsers.length;

                        let isCounterVacation = false;
                        for (const staff of counterStaff) { // counterStaff is defined above this loop
                            const vacationKey = `${staff.id}-${year}-${month + 1}`;
                            const monthlyVacations = userVacations[vacationKey] || [];
                            if (monthlyVacations.includes(dateString)) {
                                isCounterVacation = true;
                                break;
                            }
                        }
                        
                        let isShortage = false;
                        if (isCounterVacation) {
                            // 櫃檯休假: 應有 5 班 (早櫃, 早班, 晚櫃, 洗碗, 收班)
                            if (numShifts < 5) { isShortage = true; }
                        } else {
                            // 櫃檯未休假
                            if (dayOfWeek === 0 || dayOfWeek === 6) { 
                                // 週末: 應有 4 班 (櫃檯, 早班, 收班, 洗碗)
                                if (numShifts < 4) { isShortage = true; }
                            } else { 
                                // 平日: 應有 3 班 (櫃檯, 收班, 洗碗)
                                if (numShifts < 3) { isShortage = true; }
                            }
                        }

                        if (isShortage) {
                            day.classList.add('bg-orange-100');
                        } else if (holidayName) {
                            day.classList.add('bg-yellow-100');
                        }
                        // ===============================================
                        // === (END) New Shift Shortage Check ===
                        // ===============================================
                        
                        if (this.OUTSIDE_ROLES.includes(currentUserData.role) || currentUserData.role === this.ADMIN_ROLE) { // Admins should also be able to click
                            day.classList.add('cursor-pointer');
                        }

                        // const workingUsers = dailySchedule[dateString] || []; // (Moved up)
                        let usersHtml = '<div class="flex-grow"></div>';
                        if (workingUsers.length > 0) {
                            
                            // Sort Order for Outside View
                            const getSortOrder = (workInfo) => {
                                const { role, shift } = workInfo;
                                if (role === "外場櫃檯" || shift === "櫃檯") return 1;
                                switch (shift) {
                                    case "早櫃": return 2;
                                    case "早班": return 3;
                                    case "晚櫃": return 4;
                                    case "洗碗": return 5;
                                    case "收班": return 6;
                                }
                                return 99; // Other/Unknown
                            };
                            workingUsers.sort((a, b) => getSortOrder(a) - getSortOrder(b));
                            
                            const userListHtml = workingUsers.map(workInfo => {
                                const { username, role, shift, isManual } = workInfo; // Added isManual
                                let displayLabel = '';
                                let colorClass = '';
                                
                                // Determine label and color based on shift
                                switch(shift) {
                                    case "櫃檯":
                                        displayLabel = '(櫃)';
                                        colorClass = 'font-semibold text-purple-800';
                                        break;
                                    case "早櫃":
                                        displayLabel = '(早櫃)';
                                        colorClass = 'font-semibold text-purple-600';
                                        break;
                                     case "晚櫃":
                                        displayLabel = '(晚櫃)';
                                        colorClass = 'font-semibold text-purple-600';
                                        break;
                                    case "早班":
                                        displayLabel = '(早)';
                                        colorClass = 'font-semibold text-blue-800';
                                        break;
                                    case "收班":
                                        displayLabel = '(收)';
                                        colorClass = 'font-semibold text-green-800';
                                        break;
                                    case "洗碗":
                                        displayLabel = '(洗)';
                                        colorClass = 'font-semibold text-orange-800';
                                        break;
                                    default: // Fallback if shift name is unexpected
                                        displayLabel = `(${shift})`;
                                        colorClass = 'text-gray-800';
                                }

                                const deleteButtonHtml = (currentUserData.role === this.ADMIN_ROLE && isManual)
                                    ? `<button data-date="${dateString}" data-username="${username}" data-shift="${shift || ''}" class="delete-manual-assignment-btn text-red-400 hover:text-red-700 font-bold">&times;</button>`
                                    : '';

                                return `<div class="flex items-center justify-between w-full">
                                            <span class="${colorClass}">${username}${displayLabel}</span>
                                            ${deleteButtonHtml}
                                        </div>`;
                            }).join('');
                            usersHtml = `<div class="mt-1 text-gray-600 leading-tight overflow-hidden">${userListHtml}</div>`;
                        }
                        
                        let selfStatusHtml = '';
                         if (currentUserData.role === this.ADMIN_ROLE) {
                             if(!holidayName && !isShortage) day.classList.add('bg-gray-50'); // (MODIFIED) Keep admin background neutral
                         } else if (currentUserData.role === "外場櫃檯") {
                            const vacationKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const isVacation = (userVacations[vacationKey] || []).includes(dateString);
                            if (isVacation) {
                                day.classList.add('bg-red-100', 'border', 'border-red-400');
                                selfStatusHtml = `<p class="font-semibold text-red-700">休假</p>`;
                            } else {
                                if(!holidayName && !isShortage) day.classList.add('bg-green-100'); // (MODIFIED)
                                day.classList.add('border', 'border-green-400');
                                selfStatusHtml = `<p class="font-semibold text-green-700">上班日</p>`;
                            }
                        } else if (currentUserData.role === "外場工讀生") {
                            const availabilityKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const vacationTimeKey = `${currentUserData.uid}-${year}-${month+1}`;
                            const isUnavailable = (userAvailability[availabilityKey] || []).includes(dateString);
                            const vacationData = userVacationTimes[vacationTimeKey]?.[dateString];
                            const isWorking = workingUsers.some(w => w.username === currentUserData.username);

                            if (isWorking) { // Check if working first
                                if(!holidayName && !isShortage) day.classList.add('bg-blue-100'); // (MODIFIED)
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="font-semibold text-blue-700">上班</p>`;
                            } else if (isUnavailable) { // Then check if unavailable (old system)
                                if(!holidayName && !isShortage) day.classList.add('bg-red-100'); // (MODIFIED)
                                day.classList.add('border', 'border-red-400');
                                selfStatusHtml = `<p class="font-semibold text-red-700">不上班</p>`;
                            } else if (vacationData) { // Check new vacation time system
                                if (vacationData.morning && vacationData.evening) {
                                    // 全天休假
                                    if(!holidayName && !isShortage) day.classList.add('bg-red-100');
                                    day.classList.add('border', 'border-red-400');
                                    selfStatusHtml = `<p class="font-semibold text-red-700">全天休假</p>`;
                                } else if (vacationData.morning) {
                                    // 早上休假
                                    if(!holidayName && !isShortage) day.classList.add('bg-orange-100');
                                    day.classList.add('border', 'border-orange-400');
                                    selfStatusHtml = `<p class="font-semibold text-orange-700">早上休假</p>`;
                                } else if (vacationData.evening) {
                                    // 晚上休假
                                    if(!holidayName && !isShortage) day.classList.add('bg-yellow-100');
                                    day.classList.add('border', 'border-yellow-400');
                                    selfStatusHtml = `<p class="font-semibold text-yellow-700">晚上休假</p>`;
                                } else {
                                    // 可以工作
                                    if(!holidayName && !isShortage) day.classList.add('bg-white');
                                    selfStatusHtml = `<p class="text-gray-400">待排班</p>`;
                                }
                            } else { // Otherwise, available but not scheduled
                                if(!holidayName && !isShortage) day.classList.add('bg-white'); // (MODIFIED)
                                selfStatusHtml = `<p class="text-gray-400">待排班</p>`;
                            }
                        }

                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800 text-xs sm:text-sm">${i}</span>${holidayName ? `<p class="text-[9px] sm:text-[11px] font-bold text-yellow-800">${holidayName}</p>` : ''}${selfStatusHtml}</div>${usersHtml}`;
                    }
                    
                    if (dateString === todayString) day.classList.add('today');
                    calendarGrid.appendChild(day);
                }
            }
            
            // 事件監聽器 (無變動)
            setupEventListeners() {
                this.uiManager.showRegisterBtn.addEventListener('click', (e) => { 
                    e.preventDefault(); this.uiManager.showRegisterForm(); 
                });
                this.uiManager.showLoginBtn.addEventListener('click', (e) => { 
                    e.preventDefault(); this.uiManager.showLoginForm(); 
                });
                
                this.uiManager.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                this.uiManager.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.uiManager.logoutBtn.addEventListener('click', () => this.handleLogout());

                // Settings Modal Listeners
                this.uiManager.settingsBtn.addEventListener('click', () => {
                    this.uiManager.showSettingsModal();
                    const newUsernameInput = document.getElementById('new-username');
                    if(newUsernameInput && this.authManager.getCurrentUserData()) {
                        newUsernameInput.value = this.authManager.getCurrentUserData().username;
                    }
                });
                this.uiManager.closeSettingsBtn.addEventListener('click', () => this.uiManager.hideSettingsModal());
                this.uiManager.changePasswordForm.addEventListener('submit', (e) => this.handleChangePassword(e));
                this.uiManager.changeUsernameForm.addEventListener('submit', (e) => this.handleChangeUsername(e));

                // Shift Select Modal Listeners
                this.uiManager.closeShiftSelectBtn.addEventListener('click', () => this.uiManager.hideShiftSelectModal());
                this.uiManager.shiftSelectOptions.addEventListener('click', (e) => {
                    const button = e.target.closest('.shift-select-btn');
                    if (button) {
                        this.handleShiftSelect(button.dataset.date, button.dataset.shift);
                    }
                });
                
                // Cover Shift (Replacement) Modal Listeners
                this.uiManager.closeCoverShiftBtn.addEventListener('click', () => this.uiManager.hideCoverShiftModal());
                this.uiManager.coverShiftForm.addEventListener('submit', (e) => this.handleAssignCoverShift(e));
                
                // Vacation Time Modal Listeners
                this.uiManager.closeVacationTimeBtn.addEventListener('click', () => this.uiManager.hideVacationTimeModal());
                this.uiManager.cancelVacationTimeBtn.addEventListener('click', () => this.uiManager.hideVacationTimeModal());
                this.uiManager.confirmVacationTimeBtn.addEventListener('click', () => this.handleVacationTimeConfirm());
                
                // Delete User Modal Listeners
                this.uiManager.closeDeleteUserBtn.addEventListener('click', () => this.uiManager.hideDeleteUserModal());
                this.uiManager.cancelDeleteUserBtn.addEventListener('click', () => this.uiManager.hideDeleteUserModal());
                this.uiManager.confirmDeleteUserBtn.addEventListener('click', () => this.handleDeleteUser());
                
                // Calendar View Event Delegation
                this.uiManager.calendarView.addEventListener('click', async (e) => {
                    // --- Button specific actions first ---
                    if (e.target.closest('.delete-user-btn')) {
                        e.stopPropagation();
                        const btn = e.target.closest('.delete-user-btn');
                        this.handleDeleteUserClick(btn.dataset.userId, btn.dataset.username, btn.dataset.role);
                        return;
                    }
                    if (e.target.closest('.delete-manual-assignment-btn')) {
                        e.stopPropagation();
                        const btn = e.target.closest('.delete-manual-assignment-btn');
                        await this.handleDeleteManualAssignment(btn.dataset.date, btn.dataset.username, btn.dataset.shift);
                        return;
                    }
                    if (e.target.closest('.signup-cover-btn') || e.target.closest('.cancel-cover-btn')) { // Inside PT cover
                        await this.handleCoverShiftAction(e);
                        return;
                    }
                    if (e.target.closest('#prev-month-btn')) {
                        this.calendarManager.previousMonth();
                        if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                             this.currentCalendarView === 'inside' ? this.renderFullCalendar() : this.renderOutsideCalendar();
                        } else { this.renderAppView(); }
                        return;
                    }
                    if (e.target.closest('#next-month-btn')) {
                        this.calendarManager.nextMonth();
                         if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                             this.currentCalendarView === 'inside' ? this.renderFullCalendar() : this.renderOutsideCalendar();
                        } else { this.renderAppView(); }
                        return;
                    }
                    // --- Fallback to day click ---
                    if (e.target.closest('.calendar-day')) {
                        await this.handleDayClick(e);
                        return;
                    }
                });
                
                // Manual Assignment Form Submission
                this.uiManager.calendarView.addEventListener('submit', async (e) => {
                    if (e.target.id === 'manual-assignment-form') {
                       await this.handleManualAssignment(e);
                    }
                });
            }

            // 登入狀態監聽 (無變動)
            setupAuthStateListener() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.scheduleManager.cleanupListeners(); // Clean up listeners on auth state change
                    if (user) {
                        this.authManager.setCurrentUser(user);
                        const userData = await this.authManager.getUserData(user);
                        
                        if (userData) {
                            this.authManager.setCurrentUserData(userData);
                            this.uiManager.updateUserInfo(userData.username, userData.role);
                            
                            this.uiManager.showAppView();
                            
                            // Setup listener AFTER user data is confirmed
                            this.scheduleManager.setOnDataChangeCallback(() => {
                                // Prevent re-render if modals are open? Or handle gracefully.
                                // Currently, it will just re-render the whole view.
                                if(!this.uiManager.settingsModal.classList.contains('hidden')) return;
                                if(!this.uiManager.shiftSelectModal.classList.contains('hidden')) return;
                                if(!this.uiManager.coverShiftModal.classList.contains('hidden')) return;
                                if(!this.uiManager.vacationTimeModal.classList.contains('hidden')) return;
                                this.renderAppView();
                            });
                            
                            this.scheduleManager.setupRealtimeListeners();
                            // Initial render after setup
                            this.renderAppView();
                        } else {
                            console.error("User data not found in Firestore!");
                            this.handleLogout(); // Log out if user exists in Auth but not Firestore
                        }
                    } else {
                        this.authManager.setCurrentUser(null);
                        this.authManager.setCurrentUserData(null);
                        this.uiManager.showAuthView();
                    }
                });
            }
        }

        // ===================================================================================
        // === 初始化應用程式 ===
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            new ScheduleApp();
        });

    </script>
</body>
</html>
