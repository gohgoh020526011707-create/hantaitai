<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工自主排班系統 (網頁版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 和 Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }
        .material-icons-outlined {
            font-size: 1.25rem;
        }
        /* 滾動條美化 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 避免 Tailwind CSS JIT 編譯器移除動態 class */
        .bg-blue-100, .bg-green-100, .bg-yellow-100, .bg-indigo-100, .bg-pink-100, .bg-purple-100, .bg-gray-100 {}
        .text-blue-800, .text-green-800, .text-yellow-800, .text-indigo-800, .text-pink-800, .text-purple-800, .text-gray-800, .text-amber-800 {}
        .border-blue-400, .border-green-400, .border-yellow-400, .border-indigo-400, .border-pink-400, .border-purple-400, .border-gray-400 {}
        .hidden { display: none; }
        
        /* 月曆樣式 */
        .calendar-day {
            transition: all 0.2s ease-in-out;
            min-height: 6rem; /* 調整手機上的最小高度 */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        @media (min-width: 640px) {
            .calendar-day {
                min-height: 7rem;
            }
        }
        .calendar-day.cursor-pointer:not(.no-hover):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .today {
            box-shadow: inset 0 0 0 2px #4f46e5;
        }
        .custom-calendar-grid {
            display: grid;
            /* 日     一     二     三     四     五     六 */
            grid-template-columns: 1.15fr 1.15fr 1.15fr 1.15fr 0.5fr 1.15fr 1.15fr;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <!-- Login Form -->
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center">登入系統</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <input type="text" id="login-username" placeholder="用戶名稱" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="login-password" placeholder="密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">登入</button>
                    <p class="text-center text-sm">還沒有帳號？ <a href="#" id="show-register" class="font-medium text-indigo-600 hover:underline">立即註冊</a></p>
                </form>
            </div>
            <!-- Register Form -->
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center">註冊新帳號</h2>
                <form id="register-form" class="mt-8 space-y-6">
                    <input type="text" id="register-username" placeholder="用戶名稱 (登入用)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password" placeholder="密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password-confirm" placeholder="確認密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <div>
                        <label for="register-role" class="block text-sm font-medium text-gray-700 sr-only">選擇您的職位</label>
                        <select id="register-role" required class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>請選擇您的職位</option>
                            <option value="内場工讀生">内場工讀生</option>
                            <option value="内場備菜班">内場備菜班</option>
                            <option value="内場炸爐班">内場炸爐班</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">註冊</button>
                    <p class="text-center text-sm">已經有帳號了？ <a href="#" id="show-login" class="font-medium text-indigo-600 hover:underline">返回登入</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-center text-red-500 text-sm mt-4"></p>
        </div>
    </div>
    
    <!-- App Container -->
    <div id="app" class="hidden min-h-screen p-1 sm:p-4 md:p-8">
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-2 sm:p-6 md:p-8">
            
            <!-- Header -->
            <header class="mb-6 md:mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span class="material-icons-outlined text-2xl md:text-3xl text-indigo-600">event_available</span>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">員工自主排班系統</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-xs sm:text-sm text-gray-600">使用者: <span id="userName" class="font-semibold bg-gray-100 p-1 rounded"></span> (<span id="userRole" class="font-semibold"></span>)</p>
                        <button id="settings-btn" class="hidden items-center gap-1 text-sm text-gray-600 hover:text-indigo-600">
                            <span class="material-icons-outlined">settings</span>
                            <span class="hidden sm:inline">個人設定</span>
                        </button>
                        <button id="logout-btn" class="flex items-center gap-1 text-sm text-red-500 hover:text-red-700">
                            <span class="material-icons-outlined">logout</span>
                            <span class="hidden sm:inline">登出</span>
                        </button>
                    </div>
                </div>
                <p id="app-subtitle" class="mt-2 text-gray-500 text-sm md:text-base">一個讓團隊合作更順暢的排班解決方案。</p>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Standard View for Admins -->
                <div id="standard-view">
                    <!-- ... (admin view remains unchanged) ... -->
                </div>

                <!-- Calendar View -->
                <div id="calendar-view" class="hidden">
                    <!-- This will be dynamically structured based on role -->
                </div>
            </main>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">個人設定</h2>
                    <button id="close-settings-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-8">
                    <form id="change-username-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">修改顯示名稱</h3>
                        <input type="text" id="new-username" placeholder="新的顯示名稱" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">更新名稱</button>
                        <p id="username-settings-error" class="text-center text-red-500 text-sm mt-2"></p>
                    </form>
                    <hr>
                    <form id="change-password-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">修改密碼</h3>
                        <input type="password" id="new-password" placeholder="新密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <input type="password" id="confirm-new-password" placeholder="確認新密碼" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">更新密碼</button>
                        <p id="password-settings-error" class="text-center text-red-500 text-sm mt-2"></p>
                    </form>
                </div>
            </div>
        </div>



        <!-- Notification Toast -->
        <div id="toast" class="fixed bottom-8 right-8 bg-gray-900 text-white py-3 px-6 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-500 ease-in-out">
            <p id="toast-message"></p>
        </div>
    </div>

    <script type="module">
        // Firebase v9+ modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            onSnapshot,
            collection,
            query,
            where,
            writeBatch,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===================================================================================
        // === 認證管理類別 (AuthManager) ===
        // ===================================================================================
        class AuthManager {
            constructor(auth, db) {
                this.auth = auth;
                this.db = db;
                this.currentUser = null;
                this.currentUserData = null;
            }

            async register(username, password, passwordConfirm, role) {
                if (!username || !password || !role || !passwordConfirm) {
                    throw new Error('所有欄位皆為必填。');
                }
                if (password.length < 6) {
                    throw new Error('密碼長度至少需要6位數。');
                }
                if (password !== passwordConfirm) {
                    throw new Error('兩次輸入的密碼不一致。');
                }
                
                const q = query(collection(this.db, "users"), where("username_lowercase", "==", username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    throw new Error('此用戶名稱已被使用。');
                }
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(this.auth, `${username.toLowerCase()}@schedule-app.com`, password);
                    const user = userCredential.user;
                    await setDoc(doc(this.db, "users", user.uid), {
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        role: role
                    });
                } catch (error) {
                    console.error("Register error:", error);
                    throw new Error("註冊失敗，請稍後再試。");
                }
            }

            async login(username, password) {
                try {
                    await signInWithEmailAndPassword(this.auth, `${username.trim().toLowerCase()}@schedule-app.com`, password);
                } catch (error) {
                    console.error("Login error:", error);
                    throw new Error("用戶名稱或密碼錯誤。");
                }
            }

            async logout() {
                await signOut(this.auth);
            }

            async changePassword(newPassword, confirmNewPassword) {
                if (newPassword.length < 6) {
                    throw new Error('新密碼長度至少需要6位數。');
                }
                if (newPassword !== confirmNewPassword) {
                    throw new Error('兩次輸入的新密碼不一致。');
                }

                try {
                    await updatePassword(this.currentUser, newPassword);
                } catch (error) {
                    console.error("Password change error:", error);
                    throw new Error('密碼更新失敗。這可能是因為您登入時間過久，請先登出再重新登入一次後再試。');
                }
            }

            async changeUsername(newUsername) {
                if (!newUsername) {
                    throw new Error('姓名不能為空。');
                }
                if (newUsername === this.currentUserData.username) {
                    throw new Error('新舊名稱相同。');
                }

                const q = query(collection(this.db, "users"), where("username_lowercase", "==", newUsername.toLowerCase()));
                const querySnapshot = await getDocs(q);
                
                let isTaken = false;
                querySnapshot.forEach(doc => {
                    if (doc.id !== this.currentUser.uid) {
                        isTaken = true;
                    }
                });

                if (isTaken) {
                    throw new Error('此名稱已被其他使用者占用。');
                }

                try {
                    const userDocRef = doc(this.db, "users", this.currentUser.uid);
                    await setDoc(userDocRef, {
                        username: newUsername,
                        username_lowercase: newUsername.toLowerCase()
                    }, { merge: true });
                } catch (error) {
                    console.error("Username change error:", error);
                    throw new Error('名稱更新失敗，請稍後再試。');
                }
            }

            async getUserData(user) {
                if (!user) return null;
                
                const userDocRef = doc(this.db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    return { uid: user.uid, ...userDocSnap.data() };
                }
                return null;
            }

            setCurrentUser(user) {
                this.currentUser = user;
            }

            setCurrentUserData(userData) {
                this.currentUserData = userData;
            }

            getCurrentUser() {
                return this.currentUser;
            }

            getCurrentUserData() {
                return this.currentUserData;
            }
        }

        // ===================================================================================
        // === 月曆管理類別 (CalendarManager) ===
        // ===================================================================================
        class CalendarManager {
            constructor() {
                this.calendarDate = new Date();
                this.holidaysCache = {};
            }

            async fetchHolidays(year) {
                if (this.holidaysCache[year]) {
                    return this.holidaysCache[year];
                }

                const fallback2025 = new Map([
                    ['2025-01-01', '中華民國開國紀念日'],['2025-01-28', '農曆除夕'],['2025-01-29', '農曆春節'],['2025-01-30', '農曆春節'],
                    ['2025-01-31', '農曆春節'],['2025-02-28', '和平紀念日'],['2025-04-04', '兒童節'],['2025-05-31', '端午節'],
                    ['2025-10-06', '中秋節'],['2025-10-10', '國慶日']
                ]);

                try {
                    const response = await fetch(`https://cdn.jsdelivr.net/gh/g0v/tw-holiday@master/data/${year}.json`);
                    if (!response.ok) {
                        if (year === 2025 || year === '2025') {
                            console.warn(`無法從網路獲取 ${year} 年的假日資訊，將使用內建的備用資料。`);
                            this.holidaysCache[year] = fallback2025;
                            return this.holidaysCache[year];
                        }
                        console.warn(`Could not fetch holidays for ${year}. The API might not have data for this year.`);
                        this.holidaysCache[year] = new Map();
                        return this.holidaysCache[year];
                    }
                    const data = await response.json();
                    const holidaysMap = new Map();
                    data.holidays.forEach(holiday => {
                        if (holiday.isHoliday) { 
                           holidaysMap.set(holiday.date, holiday.name);
                        }
                    });
                    this.holidaysCache[year] = holidaysMap;
                    return holidaysMap;
                } catch (error) {
                    console.warn("Network error fetching holiday data:", error);
                     if (year === 2025 || year === '2025') {
                        console.warn(`網路錯誤導致無法獲取 ${year} 年的假日資訊，將使用內建的備用資料。`);
                        this.holidaysCache[year] = fallback2025;
                        return this.holidaysCache[year];
                    }
                    this.holidaysCache[year] = new Map();
                    return this.holidaysCache[year];
                }
            }

            getCalendarDate() {
                return this.calendarDate;
            }

            setCalendarDate(date) {
                this.calendarDate = date;
            }

            getMonth() {
                return this.calendarDate.getMonth();
            }

            getYear() {
                return this.calendarDate.getFullYear();
            }

            previousMonth() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() - 1);
            }

            nextMonth() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() + 1);
            }
        }

        // ===================================================================================
        // === 排班管理類別 (ScheduleManager) ===
        // ===================================================================================
        class ScheduleManager {
            constructor(db) {
                this.db = db;
                this.allData = {};
                this.allUsers = [];
                this.unsubscribeListeners = [];
                this.onDataChangeCallback = null;
            }

            setOnDataChangeCallback(callback) {
                this.onDataChangeCallback = callback;
            }

            setupRealtimeListeners() {
                const dataDocRef = doc(this.db, "scheduleData", "main");
                const usersColRef = collection(this.db, "users");

                const unsubData = onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.allData = docSnap.data();
                    } else {
                        // Initialize data if it doesn't exist
                        setDoc(doc(this.db, "scheduleData", "main"), {
                            userVacations: {},
                            userAvailability: {},
                            coverSignups: {},
                            adminHolidays: [],
                            manualAssignments: {}
                        });
                    }
                    // 觸發重新渲染
                    if (this.onDataChangeCallback) {
                        this.onDataChangeCallback();
                    }
                });

                const unsubUsers = onSnapshot(query(collection(this.db, "users")), (snapshot) => {
                    this.allUsers = [];
                    snapshot.forEach(doc => this.allUsers.push({ id: doc.id, ...doc.data() }));
                    // 觸發重新渲染
                    if (this.onDataChangeCallback) {
                        this.onDataChangeCallback();
                    }
                });
                
                this.unsubscribeListeners.push(unsubData, unsubUsers);
            }

            cleanupListeners() {
                this.unsubscribeListeners.forEach(unsub => unsub());
                this.unsubscribeListeners = [];
            }

            getAllData() {
                return this.allData;
            }

            getAllUsers() {
                return this.allUsers;
            }

            async updateUserVacation(userId, year, month, vacations) {
                const vacationKey = `${userId}-${year}-${month}`;
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userVacations: { ...this.allData.userVacations, [vacationKey]: vacations } 
                }, { merge: true });
            }

            async updateUserAvailability(userId, year, month, availability) {
                const availabilityKey = `${userId}-${year}-${month}`;
                await setDoc(doc(this.db, "scheduleData", "main"), { 
                    userAvailability: { ...this.allData.userAvailability, [availabilityKey]: availability } 
                }, { merge: true });
            }

            async updateAdminHolidays(holidays) {
                await setDoc(doc(this.db, "scheduleData", "main"), { adminHolidays: holidays }, { merge: true });
            }

            async updateCoverSignups(signups) {
                try {
                    // 獲取當前所有資料
                    const currentData = this.allData;
                    // 更新 coverSignups 並保持其他資料不變
                    const updatedData = { ...currentData, coverSignups: signups };
                    
                    console.log('更新代班資料到資料庫:', updatedData.coverSignups);
                    
                    await setDoc(doc(this.db, "scheduleData", "main"), updatedData);
                    
                    console.log('代班資料更新成功');
                } catch (error) {
                    console.error('更新代班資料失敗:', error);
                    throw error;
                }
            }

            async updateManualAssignments(assignments) {
                await setDoc(doc(this.db, "scheduleData", "main"), { manualAssignments: assignments }, { merge: true });
            }
        }

        // ===================================================================================
        // === UI管理類別 (UIManager) ===
        // ===================================================================================
        class UIManager {
            constructor() {
                this.initializeElements();
            }

            initializeElements() {
                // Auth elements
                this.authContainer = document.getElementById('auth-container');
                this.appContainer = document.getElementById('app');
                this.loginView = document.getElementById('login-view');
                this.registerView = document.getElementById('register-view');
                this.loginForm = document.getElementById('login-form');
                this.registerForm = document.getElementById('register-form');
                this.authError = document.getElementById('auth-error');
                this.showRegisterBtn = document.getElementById('show-register');
                this.showLoginBtn = document.getElementById('show-login');
                this.logoutBtn = document.getElementById('logout-btn');
                this.userNameSpan = document.getElementById('userName');
                this.userRoleSpan = document.getElementById('userRole');
                this.appSubtitle = document.getElementById('app-subtitle');
                this.calendarView = document.getElementById('calendar-view');
                this.settingsBtn = document.getElementById('settings-btn');
                this.settingsModal = document.getElementById('settings-modal');
                this.closeSettingsBtn = document.getElementById('close-settings-btn');
                this.changePasswordForm = document.getElementById('change-password-form');
                this.changeUsernameForm = document.getElementById('change-username-form');
                this.passwordSettingsError = document.getElementById('password-settings-error');
                this.usernameSettingsError = document.getElementById('username-settings-error');
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.remove('translate-y-20', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            showAuthView() {
                this.authContainer.classList.remove('hidden');
                this.appContainer.classList.add('hidden');
            }

            showAppView() {
                this.authContainer.classList.add('hidden');
                this.appContainer.classList.remove('hidden');
            }

            showLoginForm() {
                this.loginView.classList.remove('hidden');
                this.registerView.classList.add('hidden');
                this.authError.textContent = '';
            }

            showRegisterForm() {
                this.registerView.classList.remove('hidden');
                this.loginView.classList.add('hidden');
                this.authError.textContent = '';
            }

            showSettingsModal() {
                this.settingsModal.classList.remove('hidden');
                this.passwordSettingsError.textContent = '';
                this.usernameSettingsError.textContent = '';
                this.changePasswordForm.reset();
            }

            hideSettingsModal() {
                this.settingsModal.classList.add('hidden');
            }

            updateUserInfo(username, role) {
                this.userNameSpan.textContent = username;
                this.userRoleSpan.textContent = role;
            }

            updateAppSubtitle(text) {
                this.appSubtitle.textContent = text;
            }

            toggleSettingsButton(show) {
                if (show) {
                    this.settingsBtn.classList.remove('hidden');
                } else {
                    this.settingsBtn.classList.add('hidden');
                }
            }

            showCalendarView() {
                this.calendarView.classList.remove('hidden');
            }

            hideCalendarView() {
                this.calendarView.classList.add('hidden');
            }

            setAuthError(message) {
                this.authError.textContent = message;
            }

            setPasswordError(message) {
                this.passwordSettingsError.textContent = message;
            }

            setUsernameError(message) {
                this.usernameSettingsError.textContent = message;
            }
        }

        // ===================================================================================
        // === 主應用程式類別 (ScheduleApp) ===
        // ===================================================================================
        class ScheduleApp {
            constructor() {
                this.initializeFirebase();
                this.initializeManagers();
                this.initializeConstants();
                this.setupEventListeners();
                this.setupAuthStateListener();
            }

            initializeFirebase() {
                // ===================================================================================
                // === 重要：請將下方的 firebaseConfig 物件替換成您自己的 Firebase 專案設定 ===
                // ===================================================================================
                const firebaseConfig = {
                apiKey: "AIzaSyBEMnLL-ppl8-jQnA1RzZW8JfsUjCqEOFQ",
                authDomain: "schedule-hantaitai.firebaseapp.com",
                databaseURL: "https://schedule-hantaitai-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "schedule-hantaitai",
                storageBucket: "schedule-hantaitai.firebasestorage.app",
                messagingSenderId: "600535535784",
                appId: "1:600535535784:web:397ad1387e60f87479b29d"
                };
                // ===================================================================================

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                this.auth = getAuth(app);
                this.db = getFirestore(app);
            }

            initializeManagers() {
                this.authManager = new AuthManager(this.auth, this.db);
                this.calendarManager = new CalendarManager();
                this.scheduleManager = new ScheduleManager(this.db);
                this.uiManager = new UIManager();
            }

            initializeConstants() {
                this.ADMIN_ROLE = "管理者";
                this.FULLTIME_ROLES = ["内場備菜班", "内場炸爐班"];
                this.PART_TIMER_ROLE = "内場工讀生";
            }

            async handleRegister(e) {
                e.preventDefault();
                this.uiManager.setAuthError('');
                
                const username = this.uiManager.registerForm.querySelector('#register-username').value.trim();
                const password = this.uiManager.registerForm.querySelector('#register-password').value;
                const passwordConfirm = this.uiManager.registerForm.querySelector('#register-password-confirm').value;
                const role = this.uiManager.registerForm.querySelector('#register-role').value;
                
                try {
                    await this.authManager.register(username, password, passwordConfirm, role);
                    this.uiManager.showToast('註冊成功！');
                } catch (error) {
                    this.uiManager.setAuthError(error.message);
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                this.uiManager.setAuthError('');
                
                const username = this.uiManager.loginForm.querySelector('#login-username').value.trim().toLowerCase();
                const password = this.uiManager.loginForm.querySelector('#login-password').value;
                
                try {
                    await this.authManager.login(username, password);
                } catch (error) {
                    this.uiManager.setAuthError(error.message);
                }
            }

            async handleLogout() {
                await this.authManager.logout();
            }

            async handleChangePassword(e) {
                e.preventDefault();
                this.uiManager.setPasswordError('');
                
                const newPassword = this.uiManager.changePasswordForm.querySelector('#new-password').value;
                const confirmNewPassword = this.uiManager.changePasswordForm.querySelector('#confirm-new-password').value;

                try {
                    await this.authManager.changePassword(newPassword, confirmNewPassword);
                    this.uiManager.showToast('密碼更新成功！');
                    this.uiManager.hideSettingsModal();
                    this.uiManager.changePasswordForm.reset();
                } catch (error) {
                    this.uiManager.setPasswordError(error.message);
                }
            }

            async handleChangeUsername(e) {
                e.preventDefault();
                this.uiManager.setUsernameError('');
                
                const newUsernameInput = this.uiManager.changeUsernameForm.querySelector('#new-username');
                const newUsername = newUsernameInput.value.trim();

                try {
                    await this.authManager.changeUsername(newUsername);
                    this.uiManager.showToast('名稱更新成功！');
                    this.uiManager.hideSettingsModal();
                } catch (error) {
                    this.uiManager.setUsernameError(error.message);
                }
            }

            async handleDayClick(e) {
                const dayDiv = e.target.closest('.calendar-day');
                if (!dayDiv || !dayDiv.dataset.date) return;
                
                const clickedDateStr = dayDiv.dataset.date;
                const [year, month, day] = clickedDateStr.split('-').map(Number);
                const clickedDate = new Date(year, month - 1, day);
                const allData = this.scheduleManager.getAllData();
                const { adminHolidays: currentAdminHolidays = [], userVacations = {} } = allData;
                
                if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                    if (clickedDate.getDay() === 4) return this.uiManager.showToast("星期四是固定公休日，無法更改。");
                    
                    const newAdminHolidays = currentAdminHolidays.includes(clickedDateStr)
                        ? currentAdminHolidays.filter(d => d !== clickedDateStr)
                        : [...currentAdminHolidays, clickedDateStr];
                    
                    await this.scheduleManager.updateAdminHolidays(newAdminHolidays);
                    this.uiManager.showToast(currentAdminHolidays.includes(clickedDateStr) ? `${clickedDateStr} 已取消公休。` : `${clickedDateStr} 已設定為公休日。`);
                    return;
                }
                
                if (clickedDate.getDay() === 4 || currentAdminHolidays.includes(clickedDateStr)) {
                    return this.uiManager.showToast("此日為公休日，無法排班");
                }
                
                const [yearFromStr, monthFromStr] = clickedDateStr.split('-');

                if (this.FULLTIME_ROLES.includes(this.authManager.getCurrentUserData().role)) {
                    await this.handleFullTimeDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations);
                } else if (this.authManager.getCurrentUserData().role === this.PART_TIMER_ROLE) {
                    await this.handlePartTimerDayClick(clickedDateStr, yearFromStr, monthFromStr);
                }
            }

            async handleFullTimeDayClick(clickedDateStr, yearFromStr, monthFromStr, userVacations) {
                const vacationKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                const currentVacations = userVacations[vacationKey] || [];
                const isVacation = currentVacations.includes(clickedDateStr);
                
                let newVacations;

                if (isVacation) {
                    newVacations = currentVacations.filter(d => d !== clickedDateStr);
                } else {
                    if(currentVacations.length >= 4) return this.uiManager.showToast('本月休假已選滿4天');
                    
                    const allUsers = this.scheduleManager.getAllUsers();
                    const otherFullTimers = allUsers.filter(u => u.id !== this.authManager.getCurrentUser().uid && this.FULLTIME_ROLES.includes(u.role));
                    let isDayTaken = false;
                    for (const otherUser of otherFullTimers) {
                        const otherUserVacationKey = `${otherUser.id}-${yearFromStr}-${parseInt(monthFromStr)}`;
                        const otherUserVacations = userVacations[otherUserVacationKey] || [];
                        if (otherUserVacations.includes(clickedDateStr)) {
                            isDayTaken = true;
                            break;
                        }
                    }

                    if (isDayTaken) {
                        return this.uiManager.showToast(`已有其他正職人員於此日排休，無法選擇。`);
                    }
                    
                    newVacations = [...currentVacations, clickedDateStr];
                }
                
                await this.scheduleManager.updateUserVacation(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newVacations);
            }

            async handlePartTimerDayClick(clickedDateStr, yearFromStr, monthFromStr) {
                const availabilityKey = `${this.authManager.getCurrentUser().uid}-${yearFromStr}-${parseInt(monthFromStr)}`;
                const allData = this.scheduleManager.getAllData();
                const currentAvailability = allData.userAvailability?.[availabilityKey] || [];
                const newAvailability = currentAvailability.includes(clickedDateStr)
                    ? currentAvailability.filter(d => d !== clickedDateStr)
                    : [...currentAvailability, clickedDateStr];
                    
                await this.scheduleManager.updateUserAvailability(this.authManager.getCurrentUser().uid, yearFromStr, parseInt(monthFromStr), newAvailability);
            }

            async handleCoverShiftAction(e) {
                // 防止預設行為和事件冒泡
                e.preventDefault();
                e.stopPropagation();
                
                const button = e.target;
                const shiftId = button.dataset.id;
                const allData = this.scheduleManager.getAllData();
                const { coverSignups: currentCoverSignups = {} } = allData;
                
                if (button.classList.contains('signup-cover-btn')) {
                    if (currentCoverSignups[shiftId]) return this.uiManager.showToast('此班次已被預約！');
                    
                    try {
                        await this.scheduleManager.updateCoverSignups({ ...currentCoverSignups, [shiftId]: this.authManager.getCurrentUser().uid });
                        this.uiManager.showToast('成功預約代班！');
                    } catch (error) {
                        console.error('預約代班失敗:', error);
                        this.uiManager.showToast('預約代班失敗，請稍後再試。');
                    }
                } else if (button.classList.contains('cancel-cover-btn')) {
                    if (currentCoverSignups[shiftId] === this.authManager.getCurrentUser().uid) {
                        try {
                            const newCoverSignups = { ...currentCoverSignups };
                            delete newCoverSignups[shiftId];
                            
                            console.log('取消代班前:', currentCoverSignups);
                            console.log('取消代班後:', newCoverSignups);
                            
                            await this.scheduleManager.updateCoverSignups(newCoverSignups);
                            this.uiManager.showToast('已取消代班。');
                        } catch (error) {
                            console.error('取消代班失敗:', error);
                            this.uiManager.showToast('取消代班失敗，請稍後再試。');
                        }
                    } else {
                        this.uiManager.showToast('您無法取消其他人的代班。');
                    }
                }
                
                // 不需要重新渲染整個視圖，即時監聽器會自動更新UI
                // this.renderAppView(); // 移除這行以避免頁面跳轉
            }

            async handleManualAssignment(e) {
                e.preventDefault();
                const form = document.getElementById('manual-assignment-form');
                const date = form.querySelector('#assignment-date').value;
                const username = form.querySelector('#assignment-user').value.trim();
                const assignedShift = form.querySelector('#assignment-role').value;

                if (!date || !username || !assignedShift) return this.uiManager.showToast('所有欄位皆為必填。');

                const allData = this.scheduleManager.getAllData();
                const { manualAssignments = {} } = allData;
                const dayAssignments = manualAssignments[date] || [];
                
                const newAssignment = { username, assignedShift };

                const newDayAssignments = dayAssignments.filter(a => a.username !== username); 
                newDayAssignments.push(newAssignment);

                const newManualAssignments = { ...manualAssignments, [date]: newDayAssignments };

                await this.scheduleManager.updateManualAssignments(newManualAssignments);
                this.uiManager.showToast('手動排班已新增！');
                form.reset();
            }

            async handleDeleteManualAssignment(dateString, username) {
                const allData = this.scheduleManager.getAllData();
                const { manualAssignments = {} } = allData;
                if (!manualAssignments[dateString]) return;

                const updatedDayAssignments = (manualAssignments[dateString] || []).filter(a => a.username !== username);

                const newManualAssignments = { ...manualAssignments };

                if (updatedDayAssignments.length > 0) {
                    newManualAssignments[dateString] = updatedDayAssignments;
                } else {
                    delete newManualAssignments[dateString];
                }

                await this.scheduleManager.updateManualAssignments(newManualAssignments);
                this.uiManager.showToast('手動排班已刪除！');
            }

            renderAppView() {
                const currentUserData = this.authManager.getCurrentUserData();
                if(!currentUserData) return;
                
                if (currentUserData.role !== this.ADMIN_ROLE) {
                    this.uiManager.toggleSettingsButton(true);
                } else {
                    this.uiManager.toggleSettingsButton(false);
                }

                if (this.FULLTIME_ROLES.includes(currentUserData.role) || currentUserData.role === this.ADMIN_ROLE) {
                    this.uiManager.showCalendarView();
                    this.uiManager.updateAppSubtitle(currentUserData.role === this.ADMIN_ROLE ? "團隊排班總覽" : "請在下方月曆選擇您的休假日。");
                    this.renderFullTimeView();
                } else if (currentUserData.role === this.PART_TIMER_ROLE) {
                    this.uiManager.showCalendarView();
                    this.uiManager.updateAppSubtitle("請從左方列表選擇您要代班的時段。");
                    this.renderPartTimerView();
                }
            }

            async renderPartTimerView() {
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], coverSignups = {} } = allData;
                
                let availableCoverShifts = [];
                const allUsers = this.scheduleManager.getAllUsers();
                const fullTimeUsers = allUsers.filter(u => this.FULLTIME_ROLES.includes(u.role));
                
                fullTimeUsers.forEach(user => {
                    const vacationKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[vacationKey] || [];
                    monthlyVacations.forEach(dateString => {
                        const vacationDate = new Date(...dateString.split('-').map((n, i) => i === 1 ? n - 1 : n));
                        if (vacationDate.getDay() === 4 || adminHolidays.includes(dateString)) return;

                        const slots = (user.role === '内場備菜班') 
                            ? [{ key: 'AM', time: '10:00 - 14:00' }, { key: 'PM', time: '16:30 - 20:00' }]
                            : [{ key: 'AM', time: '10:30 - 14:00' }, { key: 'PM', time: '17:00 - 21:00' }];
                        
                        slots.forEach(slot => {
                            availableCoverShifts.push({
                                id: `cover-${user.id}-${dateString}-${slot.key}`,
                                date: dateString,
                                time: slot.time,
                                fullTimerName: user.username,
                                fullTimerRole: user.role,
                            });
                        });
                    });
                });
                
                availableCoverShifts.sort((a, b) => {
                    const roleOrder = { '内場備菜班': 1, '内場炸爐班': 2 };
                    if (roleOrder[a.fullTimerRole] !== roleOrder[b.fullTimerRole]) {
                        return roleOrder[a.fullTimerRole] - roleOrder[b.fullTimerRole];
                    }
                    return new Date(a.date) - new Date(b.date);
                });

                this.uiManager.calendarView.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8">
                        <div id="cover-shifts-panel" class="md:col-span-1 bg-gray-50 p-2 sm:p-4 rounded-lg h-fit">
                            <h3 class="font-bold text-lg mb-4 text-center">可代班列表</h3>
                            <div id="cover-shifts-list" class="space-y-3 max-h-[50vh] md:max-h-[60vh] overflow-y-auto"></div>
                        </div>
                        <div class="md:col-span-2">
                            <div id="calendar-header" class="flex items-center justify-between mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                                <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                            </div>
                            <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                            </div>
                            <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                            <p class="text-center text-sm text-gray-500 mt-4">點擊月曆日期來標示您的可上班時間。</p>
                        </div>
                    </div>
                `;

                const coverShiftsList = document.getElementById('cover-shifts-list');
                if (availableCoverShifts.length === 0) {
                    coverShiftsList.innerHTML = `<p class="text-center text-gray-500 p-4">本月尚無代班需求。</p>`;
                } else {
                    availableCoverShifts.forEach(shift => {
                        const isSignedUpByCurrentUser = coverSignups[shift.id] === this.authManager.getCurrentUser().uid;
                        const isTakenByOther = coverSignups[shift.id] && !isSignedUpByCurrentUser;
                        const card = document.createElement('div');
                        card.className = 'bg-white p-3 rounded-md shadow-sm border-l-4';
                        
                        let buttonHtml;
                        if (isSignedUpByCurrentUser) {
                            card.classList.add('border-green-500');
                            buttonHtml = `<button data-id="${shift.id}" class="cancel-cover-btn w-full mt-2 text-sm bg-red-500 text-white py-1 rounded hover:bg-red-600">取消代班</button>`;
                        } else if (isTakenByOther) {
                            card.classList.add('border-gray-300');
                            const taker = allUsers.find(u => u.id === coverSignups[shift.id]);
                            buttonHtml = `<div class="mt-2 text-sm text-center font-semibold bg-gray-200 text-gray-600 py-1 rounded">已被 ${taker ? taker.username : ''} 預約</div>`;
                        } else {
                            card.classList.add('border-indigo-500');
                            buttonHtml = `<button data-id="${shift.id}" class="signup-cover-btn w-full mt-2 text-sm bg-indigo-600 text-white py-1 rounded hover:bg-indigo-700">我要代班</button>`;
                        }

                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <p class="font-bold">${shift.date}</p>
                                <p class="text-sm font-semibold bg-gray-200 px-2 py-1 rounded">${shift.time}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">休假人員: ${shift.fullTimerName} (${shift.fullTimerRole})</p>
                            ${buttonHtml}
                        `;
                        coverShiftsList.appendChild(card);
                    });
                }
                
                await this.renderFullCalendar();
            }
            
            async renderFullTimeView() {
                this.uiManager.calendarView.innerHTML = `
                    <div>
                        <div id="calendar-header" class="flex items-center justify-between mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_left</span></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons-outlined">chevron_right</span></button>
                        </div>
                        <div id="calendar-weekdays" class="custom-calendar-grid gap-1 sm:gap-2 text-center text-xs sm:text-sm font-semibold text-gray-600 mb-2">
                            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                        </div>
                        <div id="calendar-grid" class="custom-calendar-grid gap-1 sm:gap-2"></div>
                        <p class="text-center text-sm text-gray-500 mt-4"></p>
                    </div>
                `;
                 const instructions = this.uiManager.calendarView.querySelector('p');
                if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                    instructions.textContent = "點擊日期以設定或取消該日為全體公休日。";
                    this.uiManager.calendarView.insertAdjacentHTML('beforeend', `
                        <div id="admin-assignment-panel" class="mt-8 p-4 sm:p-6 bg-indigo-50 border border-indigo-200 rounded-xl">
                            <h3 class="text-lg font-bold mb-4 text-indigo-800">手動新增排班</h3>
                            <form id="manual-assignment-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                                <input type="date" id="assignment-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <input type="text" id="assignment-user" placeholder="輸入姓名" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <select id="assignment-role" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="" disabled selected>選擇班別</option>
                                    <option value="備菜班 (早)">備菜班 (早)</option>
                                    <option value="備菜班 (晚)">備菜班 (晚)</option>
                                    <option value="備菜班 (全日)">備菜班 (全日)</option>
                                    <option value="炸爐班 (早)">炸爐班 (早)</option>
                                    <option value="炸爐班 (晚)">炸爐班 (晚)</option>
                                    <option value="炸爐班 (全日)">炸爐班 (全日)</option>
                                    <option value="收班">收班</option>
                                </select>
                                <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">新增</button>
                            </form>
                        </div>
                    `);

                } else {
                    instructions.textContent = "請點擊日期選擇您的休假日 (每月最多4天)。";
                }
                await this.renderFullCalendar();
            }

            async renderFullCalendar() {
                this.calendarManager.getCalendarDate().setDate(1);
                const month = this.calendarManager.getMonth();
                const year = this.calendarManager.getYear();
                
                document.getElementById('calendar-month-year').textContent = `${year}年 ${month + 1}月`;
                
                const holidays = await this.calendarManager.fetchHolidays(year);
                const allData = this.scheduleManager.getAllData();
                const { userVacations = {}, adminHolidays = [], coverSignups = {}, userAvailability = {}, manualAssignments = {} } = allData;

                const dailySchedule = {};
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dailySchedule[dateString] = [];
                }

                const allUsers = this.scheduleManager.getAllUsers();
                allUsers.filter(u => this.FULLTIME_ROLES.includes(u.role)).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyVacations = userVacations[userMonthKey] || [];
                    for (let i = 1; i <= lastDayOfMonth; i++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        if (!monthlyVacations.includes(dateString)) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    }
                });

                Object.keys(coverSignups).forEach(coverId => {
                    const parts = coverId.split('-');
                    if (parts.length < 5) return;
                    const dateString = parts.slice(parts.length - 4, parts.length - 1).join('-');
                    const timeSlot = parts[parts.length - 1];
                    const date = new Date(dateString);

                    if (date.getFullYear() === year && date.getMonth() === month) {
                         const ptUserId = coverSignups[coverId];
                         const ptUser = allUsers.find(u => u.id === ptUserId);
                         const fullTimerId = parts.slice(1, parts.length - 4).join('-');
                         const originalFullTimer = allUsers.find(u => u.id === fullTimerId);

                         if(ptUser && originalFullTimer) {
                            dailySchedule[dateString].push({ username: ptUser.username, role: originalFullTimer.role, isCover: true, timeSlot });
                         }
                    }
                });
                
                allUsers.filter(u => u.role === this.PART_TIMER_ROLE).forEach(user => {
                    const userMonthKey = `${user.id}-${year}-${month+1}`;
                    const monthlyAvailability = userAvailability[userMonthKey] || [];
                    monthlyAvailability.forEach(dateString => {
                        const alreadyScheduled = dailySchedule[dateString].some(s => s.username === user.username);
                        if (!alreadyScheduled) {
                            dailySchedule[dateString].push({ username: user.username, role: user.role, isCover: false, timeSlot: 'FullDay' });
                        }
                    });
                });

                Object.keys(manualAssignments).forEach(dateString => {
                    if (dailySchedule[dateString]) {
                        const assignments = manualAssignments[dateString];
                        assignments.forEach(assignment => {
                             // Remove any other assignment for this user on this day
                            dailySchedule[dateString] = dailySchedule[dateString].filter(
                                s => s.username !== assignment.username
                            );

                            // Parse assignedShift to role and timeSlot
                            let role = '';
                            let timeSlot = 'FullDay';
                            const assignedShift = assignment.assignedShift;

                            if (assignedShift.includes('備菜班')) role = '内場備菜班';
                            else if (assignedShift.includes('炸爐班')) role = '内場炸爐班';
                            else if (assignedShift === '收班') role = '内場工讀生';

                            if (assignedShift.includes('早')) timeSlot = 'AM';
                            else if (assignedShift.includes('晚')) timeSlot = 'PM';

                            dailySchedule[dateString].push({ 
                                username: assignment.username, 
                                role: role, 
                                isCover: true, // Treat as cover to get time-specific labels
                                timeSlot: timeSlot,
                                isManual: true
                            });
                        });
                    }
                });

                const calendarGrid = document.getElementById('calendar-grid');
                calendarGrid.innerHTML = '';
                const firstDayIndex = this.calendarManager.getCalendarDate().getDay();
                const prevLastDay = new Date(year, month, 0).getDate();
                for (let i = firstDayIndex; i > 0; i--) {
                    calendarGrid.innerHTML += `<div class="p-1 sm:p-2 text-center text-gray-300 no-hover">${prevLastDay - i + 1}</div>`;
                }

                const todayString = new Date().toISOString().split('T')[0];

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const day = document.createElement('div');
                    const isThursday = new Date(year, month, i).getDay() === 4;
                    const holidayName = holidays.get(dateString);
                    const isAdminHoliday = adminHolidays.includes(dateString);

                    day.className = `calendar-day p-1 rounded-lg text-left text-[10px] sm:text-xs`;
                    day.dataset.date = dateString;

                    if (isThursday || isAdminHoliday) {
                        day.classList.add('bg-red-100');
                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800">${i}</span></div><div class="flex-grow flex items-center justify-center"><p class="font-bold text-red-700 text-xs sm:text-sm">公休日</p></div>`;
                        if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE && !isThursday) day.classList.add('cursor-pointer'); 
                    } else {
                        if(holidayName) day.classList.add('bg-yellow-100');
                        
                        if (this.FULLTIME_ROLES.includes(this.authManager.getCurrentUserData().role) || this.authManager.getCurrentUserData().role === this.PART_TIMER_ROLE || this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                            day.classList.add('cursor-pointer');
                        }

                        const workingUsers = dailySchedule[dateString] || [];
                        let usersHtml = '<div class="flex-grow"></div>';
                        if (workingUsers.length > 0) {
                            const getSortOrder = (workInfo) => {
                                const { role, isCover, timeSlot } = workInfo;
                                if (role === '内場備菜班') {
                                    if (isCover) return timeSlot === 'AM' ? 1 : 2; // 早備, 晚備
                                    return 3; // 備
                                }
                                if (role === '内場炸爐班') {
                                    if (isCover) return timeSlot === 'AM' ? 4 : 5; // 早炸, 晚炸
                                    return 6; // 炸
                                }
                                if (role === this.PART_TIMER_ROLE) {
                                    return 7; // 收
                                }
                                return 99;
                            };
                            workingUsers.sort((a, b) => getSortOrder(a) - getSortOrder(b));

                            const userListHtml = workingUsers.map(workInfo => {
                                const { username, role, isCover, timeSlot, isManual } = workInfo;
                                let displayLabel = '';
                                let colorClass = '';
                                
                                const originalUser = allUsers.find(u => u.username === username);
                                const userRole = originalUser ? originalUser.role : (role === this.PART_TIMER_ROLE ? this.PART_TIMER_ROLE : null);

                                if (userRole === this.PART_TIMER_ROLE || isManual) {
                                    if (isCover) { 
                                        if (role === '内場備菜班') {
                                            displayLabel = `(${timeSlot === 'AM' ? '早備' : '晚備'})`;
                                            colorClass = 'font-semibold text-green-800';
                                        } else if (role === '内場炸爐班') {
                                            displayLabel = `(${timeSlot === 'AM' ? '早炸' : '晚炸'})`;
                                            colorClass = 'font-semibold text-amber-800';
                                        }
                                    } else { 
                                        displayLabel = '(收)';
                                        colorClass = 'font-semibold text-blue-800';
                                    }
                                } else { 
                                    switch (role) {
                                        case '内場備菜班':
                                            displayLabel = '(備)';
                                            colorClass = 'font-semibold text-green-800';
                                            break;
                                        case '内場炸爐班':
                                            displayLabel = '(炸)';
                                            colorClass = 'font-semibold text-amber-800';
                                            break;
                                    }
                                }
                                
                                const deleteButtonHtml = (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE && isManual)
                                    ? `<button data-date="${dateString}" data-username="${username}" class="delete-manual-assignment-btn text-red-400 hover:text-red-700 font-bold">&times;</button>`
                                    : '';

                                return `<div class="flex items-center justify-between w-full">
                                            <span class="${colorClass}">${username}${displayLabel}</span>
                                            ${deleteButtonHtml}
                                        </div>`;

                            }).join('');
                            usersHtml = `<div class="mt-1 text-gray-600 leading-tight overflow-hidden">${userListHtml}</div>`;
                        }
                        
                        let selfStatusHtml = '';
                        if (this.authManager.getCurrentUserData().role === this.ADMIN_ROLE) {
                            if(!holidayName) day.classList.add('bg-gray-50');
                        } else if (this.FULLTIME_ROLES.includes(this.authManager.getCurrentUserData().role)) {
                            const vacationKey = `${this.authManager.getCurrentUser().uid}-${year}-${month+1}`;
                            const isVacation = (userVacations[vacationKey] || []).includes(dateString);
                            if (isVacation) {
                                day.classList.add('bg-red-100', 'border', 'border-red-400');
                                selfStatusHtml = `<p class="font-semibold text-red-700">休假</p>`;
                            } else {
                                if(!holidayName) day.classList.add('bg-green-100');
                                day.classList.add('border', 'border-green-400');
                                selfStatusHtml = `<p class="font-semibold text-green-700">上班日</p>`;
                            }
                        } else if (this.authManager.getCurrentUserData().role === this.PART_TIMER_ROLE) {
                            const availabilityKey = `${this.authManager.getCurrentUser().uid}-${year}-${month+1}`;
                            const isAvailable = (userAvailability[availabilityKey] || []).includes(dateString);
                            const isWorkingCoverShift = workingUsers.some(w => w.username === this.authManager.getCurrentUserData().username && w.isCover);

                            if (isAvailable) {
                                if(!holidayName) day.classList.add('bg-blue-100');
                                day.classList.add('border', 'border-blue-400');
                                selfStatusHtml = `<p class="font-semibold text-blue-700">要上班</p>`;
                            } else {
                                if(!holidayName) day.classList.add('bg-white');
                                selfStatusHtml = `<p class="text-gray-400">休息</p>`;
                            }
                            if (isWorkingCoverShift) {
                                selfStatusHtml += `<p class="font-bold text-green-700">(已代班)</p>`;
                            }
                        }


                        day.innerHTML = `<div class="text-center"><span class="font-bold text-gray-800 text-xs sm:text-sm">${i}</span>${holidayName ? `<p class="text-[9px] sm:text-[11px] font-bold text-yellow-800">${holidayName}</p>` : ''}${selfStatusHtml}</div>${usersHtml}`;
                    }
                    
                    if (dateString === todayString) day.classList.add('today');
                    calendarGrid.appendChild(day);
                }
            }
            
            setupEventListeners() {
                this.uiManager.showRegisterBtn.addEventListener('click', (e) => { 
                e.preventDefault();
                    this.uiManager.showRegisterForm(); 
                });
                this.uiManager.showLoginBtn.addEventListener('click', (e) => { 
                e.preventDefault();
                    this.uiManager.showLoginForm(); 
                });
                
                this.uiManager.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                this.uiManager.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.uiManager.logoutBtn.addEventListener('click', () => this.handleLogout());

                this.uiManager.settingsBtn.addEventListener('click', () => {
                    this.uiManager.showSettingsModal();
                    const newUsernameInput = document.getElementById('new-username');
                    if(newUsernameInput && this.authManager.getCurrentUserData()) {
                        newUsernameInput.value = this.authManager.getCurrentUserData().username;
                    }
                });
                this.uiManager.closeSettingsBtn.addEventListener('click', () => {
                    this.uiManager.hideSettingsModal();
                });
                this.uiManager.changePasswordForm.addEventListener('submit', (e) => this.handleChangePassword(e));
                this.uiManager.changeUsernameForm.addEventListener('submit', (e) => this.handleChangeUsername(e));

                this.uiManager.calendarView.addEventListener('click', async (e) => {
                    if (e.target.closest('#prev-month-btn')) {
                        this.calendarManager.previousMonth();
                        this.renderAppView();
                    }
                    if (e.target.closest('#next-month-btn')) {
                        this.calendarManager.nextMonth();
                        this.renderAppView();
                    }
                    if (e.target.closest('.calendar-day')) {
                        await this.handleDayClick(e);
                    }
                    if (e.target.closest('.signup-cover-btn') || e.target.closest('.cancel-cover-btn')) {
                        await this.handleCoverShiftAction(e);
                    }
                    if (e.target.closest('.delete-manual-assignment-btn')) {
                        e.stopPropagation();
                        const btn = e.target.closest('.delete-manual-assignment-btn');
                        await this.handleDeleteManualAssignment(btn.dataset.date, btn.dataset.username);
                    }
                });
                this.uiManager.calendarView.addEventListener('submit', async (e) => {
                    if (e.target.id === 'manual-assignment-form') {
                       await this.handleManualAssignment(e);
                    }
                });
            }

            setupAuthStateListener() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.scheduleManager.cleanupListeners();
                if (user) {
                        this.authManager.setCurrentUser(user);
                        const userData = await this.authManager.getUserData(user);
                        
                        if (userData) {
                            this.authManager.setCurrentUserData(userData);
                            this.uiManager.updateUserInfo(userData.username, userData.role);
                            
                            this.uiManager.showAppView();
                            
                            // 設置資料變更回調
                            this.scheduleManager.setOnDataChangeCallback(() => {
                                this.renderAppView();
                            });
                            
                            this.scheduleManager.setupRealtimeListeners();
                            // 初始渲染
                            this.renderAppView();
                    } else {
                        console.error("User data not found in Firestore!");
                            this.handleLogout();
                    }
                } else {
                        this.authManager.setCurrentUser(null);
                        this.authManager.setCurrentUserData(null);
                        this.uiManager.showAuthView();
                    }
                });
            }
        }

        // ===================================================================================
        // === 初始化應用程式 ===
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            new ScheduleApp();
        });

    </script>
</body>
</html>

